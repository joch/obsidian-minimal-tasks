/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Ot=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var Ae=Object.prototype.hasOwnProperty;var Ce=(l,c)=>{for(var t in c)Ot(l,t,{get:c[t],enumerable:!0})},Le=(l,c,t,e)=>{if(c&&typeof c=="object"||typeof c=="function")for(let s of $e(c))!Ae.call(l,s)&&s!==t&&Ot(l,s,{get:()=>c[s],enumerable:!(e=Me(c,s))||e.enumerable});return l};var je=l=>Le(Ot({},"__esModule",{value:!0}),l);var Oe={};Ce(Oe,{default:()=>$t});module.exports=je(Oe);var k=require("obsidian"),_=require("@codemirror/view");var Yt={projectField:"projects",dueField:"due",scheduledField:"scheduled",contextsField:"contexts",discussWithField:"discuss-with",discussDuringField:"discuss-during",storeField:"store",areaField:"area",titleField:"title",statusField:"status",priorityField:"priority",rruleField:"rrule",showProjects:!0,showProjectDueDates:!0,showNoteIcon:!0,showContextPills:!1,noteContentIgnorePattern:'^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*',statuses:["none","open","in-progress","done","dropped"],priorities:["anytime","today","someday"],personTypeField:"type",personTypeValue:"person",eventTypeField:"type",eventTypeValue:"event",projectTypeField:"type",projectTypeValue:"project",actionTypeField:"type",actionTypeValue:"action",areasFolder:"gtd/areas/",contextsFolder:"gtd/contexts/"};var D=require("obsidian"),pt=class extends D.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Minimal Tasks Settings"}),t.createEl("h3",{text:"Frontmatter Field Names"}),t.createEl("p",{text:"Customize which frontmatter fields are used for task metadata.",cls:"setting-item-description"}),new D.Setting(t).setName("Status field").setDesc("Frontmatter field for task status").addText(e=>e.setPlaceholder("status").setValue(this.plugin.settings.statusField).onChange(async s=>{this.plugin.settings.statusField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Priority field").setDesc("Frontmatter field for task priority").addText(e=>e.setPlaceholder("priority").setValue(this.plugin.settings.priorityField).onChange(async s=>{this.plugin.settings.priorityField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Projects field").setDesc("Frontmatter field for project links (array)").addText(e=>e.setPlaceholder("projects").setValue(this.plugin.settings.projectField).onChange(async s=>{this.plugin.settings.projectField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Contexts field").setDesc("Frontmatter field for contexts (array)").addText(e=>e.setPlaceholder("contexts").setValue(this.plugin.settings.contextsField).onChange(async s=>{this.plugin.settings.contextsField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Due date field").setDesc("Frontmatter field for due date").addText(e=>e.setPlaceholder("due").setValue(this.plugin.settings.dueField).onChange(async s=>{this.plugin.settings.dueField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Scheduled field").setDesc("Frontmatter field for scheduled date").addText(e=>e.setPlaceholder("scheduled").setValue(this.plugin.settings.scheduledField).onChange(async s=>{this.plugin.settings.scheduledField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Discuss-with field").setDesc("Frontmatter field for people to discuss with (array)").addText(e=>e.setPlaceholder("discuss-with").setValue(this.plugin.settings.discussWithField).onChange(async s=>{this.plugin.settings.discussWithField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Discuss-during field").setDesc("Frontmatter field for meetings to discuss during (array)").addText(e=>e.setPlaceholder("discuss-during").setValue(this.plugin.settings.discussDuringField).onChange(async s=>{this.plugin.settings.discussDuringField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Store field").setDesc("Frontmatter field for store/location (errands)").addText(e=>e.setPlaceholder("store").setValue(this.plugin.settings.storeField).onChange(async s=>{this.plugin.settings.storeField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Area field").setDesc("Frontmatter field for area/category").addText(e=>e.setPlaceholder("area").setValue(this.plugin.settings.areaField).onChange(async s=>{this.plugin.settings.areaField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Title field").setDesc("Frontmatter field for task title").addText(e=>e.setPlaceholder("title").setValue(this.plugin.settings.titleField).onChange(async s=>{this.plugin.settings.titleField=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Display Options"}),new D.Setting(t).setName("Show projects").setDesc("Display project links below tasks").addToggle(e=>e.setValue(this.plugin.settings.showProjects).onChange(async s=>{this.plugin.settings.showProjects=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Show project due dates").setDesc("Show due date warnings for projects").addToggle(e=>e.setValue(this.plugin.settings.showProjectDueDates).onChange(async s=>{this.plugin.settings.showProjectDueDates=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Show note icon").setDesc("Show \u2630 icon for tasks with content").addToggle(e=>e.setValue(this.plugin.settings.showNoteIcon).onChange(async s=>{this.plugin.settings.showNoteIcon=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Note content ignore pattern").setDesc("Regex pattern to ignore when detecting note content. Useful for stripping boilerplate code blocks like ribbons. Leave empty to disable.").addTextArea(e=>e.setPlaceholder('^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*').setValue(this.plugin.settings.noteContentIgnorePattern).onChange(async s=>{this.plugin.settings.noteContentIgnorePattern=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Note Type Detection"}),t.createEl("p",{text:"Configure how different note types are identified in your vault.",cls:"setting-item-description"}),new D.Setting(t).setName("Person type field").setDesc("Frontmatter field to identify person notes").addText(e=>e.setPlaceholder("type").setValue(this.plugin.settings.personTypeField).onChange(async s=>{this.plugin.settings.personTypeField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Person type value").setDesc("Value that identifies a note as a person").addText(e=>e.setPlaceholder("person").setValue(this.plugin.settings.personTypeValue).onChange(async s=>{this.plugin.settings.personTypeValue=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Event type field").setDesc("Frontmatter field to identify event notes").addText(e=>e.setPlaceholder("type").setValue(this.plugin.settings.eventTypeField).onChange(async s=>{this.plugin.settings.eventTypeField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Event type value").setDesc("Value that identifies a note as an event").addText(e=>e.setPlaceholder("event").setValue(this.plugin.settings.eventTypeValue).onChange(async s=>{this.plugin.settings.eventTypeValue=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Project type field").setDesc("Frontmatter field to identify project notes").addText(e=>e.setPlaceholder("type").setValue(this.plugin.settings.projectTypeField).onChange(async s=>{this.plugin.settings.projectTypeField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Project type value").setDesc("Value that identifies a note as a project").addText(e=>e.setPlaceholder("project").setValue(this.plugin.settings.projectTypeValue).onChange(async s=>{this.plugin.settings.projectTypeValue=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Action type field").setDesc("Frontmatter field to identify action/task notes").addText(e=>e.setPlaceholder("type").setValue(this.plugin.settings.actionTypeField).onChange(async s=>{this.plugin.settings.actionTypeField=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Action type value").setDesc("Value that identifies a note as an action/task").addText(e=>e.setPlaceholder("action").setValue(this.plugin.settings.actionTypeValue).onChange(async s=>{this.plugin.settings.actionTypeValue=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Areas folder").setDesc('Folder containing area notes. Use "order" (number) and "emoji" frontmatter fields in area notes to control sorting and display.').addText(e=>e.setPlaceholder("gtd/areas/").setValue(this.plugin.settings.areasFolder).onChange(async s=>{this.plugin.settings.areasFolder=s,await this.plugin.saveSettings()})),new D.Setting(t).setName("Contexts folder").setDesc('Folder containing context notes (e.g., @focus.md). Use "order" (number) frontmatter field to control sorting. Context name is derived from filename without @ prefix.').addText(e=>e.setPlaceholder("gtd/contexts/").setValue(this.plugin.settings.contextsFolder).onChange(async s=>{this.plugin.settings.contextsFolder=s,await this.plugin.saveSettings()}))}};function at(l){let c=document.createElement("div");return c.textContent=l,c.textContent||""}function ut(){let l=new Date,c=t=>t.toString().padStart(2,"0");return`${l.getFullYear()}${c(l.getMonth()+1)}${c(l.getDate())}-${c(l.getHours())}${c(l.getMinutes())}${c(l.getSeconds())}`}function Dt(l){let c=l%10,t=l%100;return c===1&&t!==11?"st":c===2&&t!==12?"nd":c===3&&t!==13?"rd":"th"}function Ht(l){return l+Dt(l)}function Et(l){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][l.getMonth()]} ${l.getDate()}`}function Vt(l){let c=new Date(l),t=c.getFullYear(),e=String(c.getMonth()+1).padStart(2,"0"),s=String(c.getDate()).padStart(2,"0");return`${t}${e}${s}`}function bt(l){if(!l)return"";let c=String(l).replace(/^["']|["']$/g,"");return c.length>=10?c.substring(0,10):""}function gt(l){if(!l)return l;let c=String(l),t=c.match(/\[\[(?:[^\]|]+\|)?([^\]]+)\]\]/);return t?t[1]:c}function St(l){if(!l)return null;let t=String(l).match(/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/);return t?t[1]:null}function Bt(l){return l&&l.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")}function W(l){let c=/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/,t=l.match(c);if(!t)return{frontmatter:{},body:l};let e=t[1],s=t[2],n={},o=e.split(`
`),r=null,i=null;for(let d of o){if(d.trim().startsWith("- ")){i&&i.push(d.trim().substring(2));continue}let u=d.indexOf(":");if(u>0){let g=d.substring(0,u).trim(),h=d.substring(u+1).trim();r=g,h===""?(i=[],n[g]=i):(n[g]=h,i=null)}}return{frontmatter:n,body:s}}function Ne(l){return l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'")?l:l.includes("[[")?`"${l}"`:l}function Q(l,c){let t=[];for(let[s,n]of Object.entries(l))Array.isArray(n)?n.length===0?t.push(`${s}: []`):(t.push(`${s}:`),n.forEach(o=>{t.push(`  - ${Ne(String(o))}`)})):t.push(`${s}: ${n}`);return`---
${t.join(`
`)}
---
${c}`}function rt(l){let c={};return l.split(";").forEach(e=>{let[s,n]=e.split(":").length===2?e.split(":"):e.split("=");s&&n&&(c[s]=n)}),c}function Wt(l){if(!l)return"";try{let c=rt(l),t=c.FREQ,e=parseInt(c.INTERVAL||"1"),s=c.BYDAY,n=c.BYMONTHDAY,o=c.BYMONTH,r=c.BYSETPOS,i="";if(e===1)switch(t){case"DAILY":i="Daily";break;case"WEEKLY":i="Weekly";break;case"MONTHLY":i="Monthly";break;case"YEARLY":i="Yearly";break}else if(t==="MONTHLY"&&e===3)i="Quarterly";else if(t==="MONTHLY"&&e===6)i="Biannually";else switch(t){case"DAILY":i=`Every ${e} days`;break;case"WEEKLY":i=`Every ${e} weeks`;break;case"MONTHLY":i=`Every ${e} months`;break;case"YEARLY":i=`Every ${e} years`;break}if(r&&s){let u={SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"}[s]||s,g=parseInt(r),h=g===-1?"last":Ht(g);i+=` on the ${h} ${u}`}else if(s){let d=s.split(",").map(u=>({SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"})[u]||u);i+=" on "+d.join(", ")}return n&&(i+=" on the "+n+Dt(parseInt(n))),o&&(i+=" in "+["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(o)]),i}catch(c){return console.error("Failed to format RRULE:",c),"Recurring"}}function _t(l){return{SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[l]||0}function Ut(l,c){let t=rt(l),e=new Date(c);e.setDate(e.getDate()+1);let s=t.DTSTART;if(!s)throw new Error("DTSTART is required in RRULE");let n=new Date(parseInt(s.substring(0,4)),parseInt(s.substring(4,6))-1,parseInt(s.substring(6,8))),o=t.FREQ;if(!o)throw new Error("FREQ is required in RRULE");let r=parseInt(t.INTERVAL||"1"),i;switch(o){case"DAILY":if(i=new Date(e),t.BYDAY){let S=t.BYDAY.split(",").map(_t);for(;!S.includes(i.getDay());)i.setDate(i.getDate()+1)}else{let F=Math.floor((i.getTime()-n.getTime())/864e5)%r;F!==0&&i.setDate(i.getDate()+(r-F))}break;case"WEEKLY":i=new Date(e);let m=(t.BYDAY||["SU","MO","TU","WE","TH","FR","SA"][n.getDay()]).split(",").map(_t),w=!1;for(let S=0;S<7&&!w;S++){if(m.includes(i.getDay())){if(r===1){w=!0;break}if(Math.floor((i.getTime()-n.getTime())/(1e3*60*60*24*7))%r===0){w=!0;break}}i.setDate(i.getDate()+1)}if(!w)for(i=new Date(e),i.setDate(i.getDate()+r*7);!m.includes(i.getDay());)i.setDate(i.getDate()+1);break;case"MONTHLY":i=new Date(e);let E=t.BYMONTHDAY?parseInt(t.BYMONTHDAY):n.getDate();if(i.setDate(E),i<=e)i.setMonth(i.getMonth()+r);else{let S=(i.getFullYear()-n.getFullYear())*12+(i.getMonth()-n.getMonth());if(S%r!==0){let F=S%r;i.setMonth(i.getMonth()+(r-F))}}for(;i.getDate()!==E;)i.setDate(0),i.setMonth(i.getMonth()+1);break;case"YEARLY":i=new Date(e);let b=t.BYMONTH?parseInt(t.BYMONTH)-1:n.getMonth(),P=t.BYMONTHDAY?parseInt(t.BYMONTHDAY):n.getDate();if(i.setMonth(b),i.setDate(P),i<=e)i.setFullYear(i.getFullYear()+r);else{let S=i.getFullYear()-n.getFullYear();if(S%r!==0){let F=S%r;i.setFullYear(i.getFullYear()+(r-F))}}break;default:throw new Error("Unsupported FREQ: "+o)}let d=i.getFullYear(),u=String(i.getMonth()+1).padStart(2,"0"),g=String(i.getDate()).padStart(2,"0");return`${d}-${u}-${g}`}function ht(l){return{today:"\u2B50",someday:"\u{1F4AD}",anytime:"\u2022"}[l]||"\u2022"}function xt(l,c){return`<span class="task-status-dot" data-status="${l}" data-task-path="${c}" title="Status: ${l} (click to cycle)"></span>`}function Pt(l,c){let t=ht(l);return`<span class="task-priority-badge" data-priority="${l}" data-task-path="${c}" title="Priority: ${l} (click to cycle)">${t}</span>`}function Ft(l){return(Array.isArray(l)?l:[l]).map(c=>`<span class="minimal-badge minimal-badge-context">@${c}</span>`).join("")}function qt(l){return(Array.isArray(l)?l:[l]).map(c=>{let t=gt(c),e=St(c);return e?`<span class="minimal-badge minimal-badge-person"><a class="internal-link" data-href="${e}" href="${e}" target="_blank" rel="noopener">\u{1F464}${t}</a></span>`:`<span class="minimal-badge minimal-badge-person">\u{1F464}${t}</span>`}).join("")}function Gt(l){return(Array.isArray(l)?l:[l]).map(c=>{let t=gt(c);return`<span class="minimal-badge minimal-badge-meeting">\u{1F4C5}${Bt(t)}</span>`}).join("")}function Qt(l){return`<span class="minimal-badge minimal-badge-store">\u{1F3EA}${l}</span>`}function Mt(l){return`<span class="minimal-badge minimal-badge-recurrence">\u{1F501} ${Wt(l)}</span>`}function Jt(l){return(Array.isArray(l)?l:[l]).filter(c=>c).map(c=>{let t=gt(c),e=St(c);return e?`<span class="minimal-badge minimal-badge-project"><a class="internal-link" data-href="${e}" href="${e}">\u{1F4C1} ${at(t)}</a></span>`:`<span class="minimal-badge minimal-badge-project">\u{1F4C1} ${at(t)}</span>`}).join("")}var $=require("obsidian");var J=class extends $.Modal{constructor(t,e,s,n,o){super(t);this.frontmatter={};this.body="";this.isCreateMode=!1;this.didSave=!1;this.viewportHandler=null;this.plugin=e,this.taskPath=s,n&&(this.isCreateMode=!0,this.frontmatter=n,this.body='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n',o&&(this.body+=`
`+o))}async onOpen(){let{contentEl:t}=this;if(this.modalEl.addClass("edit-task-modal"),this.setupViewportHandler(),this.isCreateMode){this.buildForm();return}let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof $.TFile)){t.createEl("p",{text:"Error: Task file not found"});return}let s=await this.app.vault.read(e),n=W(s);this.frontmatter=n.frontmatter,this.body=n.body,this.buildForm()}buildForm(){let{contentEl:t}=this;t.empty();let e,s,n,r=t.createDiv({cls:"edit-task-title-container"}).createEl("input",{cls:"edit-task-title-input",attr:{type:"text",placeholder:"Task title...",value:String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")}});r.addEventListener("change",()=>{this.frontmatter.title=r.value}),setTimeout(()=>r.focus(),0);let i=t.createDiv({cls:"edit-task-section"});i.createDiv({cls:"edit-task-section-label",text:"Contexts"});let d=i.createDiv({cls:"edit-task-contexts"}),u=this.getContextsFromFolder(),g=this.getArrayField("contexts"),h=()=>{var p,T;let a=this.getActiveContexts(d);if(e){let M=((p=this.frontmatter["discuss-with"])==null?void 0:p.length)>0||((T=this.frontmatter["discuss-during"])==null?void 0:T.length)>0;e.style.display=a.includes("agenda")||M?"":"none"}if(s){let M=this.frontmatter.store&&String(this.frontmatter.store).replace(/^["']|["']$/g,"").trim()!=="";s.style.display=a.includes("errands")||M?"":"none"}};u.forEach(a=>{let p=d.createSpan({cls:"context-pill"+(g.includes(a)?" active":""),text:"@"+a});p.addEventListener("click",()=>{p.toggleClass("active",!p.hasClass("active")),this.updateContexts(d),h()})});let w=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),E=w.createDiv({cls:"edit-task-inline-group"});E.createSpan({cls:"edit-task-label",text:"\u{1F4C2} Project"});let b=E.createEl("select",{cls:"edit-task-select-project"});b.createEl("option",{value:"",text:"(none)"});let P=this.getAreasFromFolder(),S={};P.forEach(a=>{S[a.name]=a.emoji});let F=[...P.map(a=>a.name),""],N=this.getNotesOfType(this.plugin.settings.projectTypeField,this.plugin.settings.projectTypeValue).filter(a=>{var T;let p=this.app.metadataCache.getFileCache(a);return((T=p==null?void 0:p.frontmatter)==null?void 0:T.state)!=="completed"}).map(a=>{var H;let p=this.app.metadataCache.getFileCache(a),T=(H=p==null?void 0:p.frontmatter)==null?void 0:H.area,M="";if(T&&typeof T=="string"&&(T=T.replace(/^["']|["']$/g,""),T.includes("|"))){let it=T.split("|");it.length>=2&&(M=it[1].replace(/\]\]$/,"").trim())}return{file:a,area:M}}).sort((a,p)=>a.file.basename.localeCompare(p.file.basename)),R=new Map;N.forEach(a=>{let p=a.area||"";R.has(p)||R.set(p,[]),R.get(p).push(a)});let K=this.getProjectBasename();F.forEach(a=>{let p=R.get(a);if(!p||p.length===0)return;let T=S[a]||"\u{1F4E6}",M=a?`${T} ${a}`:"\u{1F4E6} No Area",H=b.createEl("optgroup",{attr:{label:M}});p.forEach(it=>{let Fe=H.createEl("option",{value:it.file.path,text:it.file.basename});it.file.basename===K&&(Fe.selected=!0)})});let U=w.createDiv({cls:"edit-task-inline-group"});U.createSpan({cls:"edit-task-label",text:"\u{1F5C2}\uFE0F Area"});let L=U.createEl("select",{cls:"edit-task-select-small"}),mt=this.getAreaName();L.createEl("option",{value:"",text:"(none)"}),P.forEach(a=>{let p=`${a.emoji} ${a.name}`,T=L.createEl("option",{value:a.name,text:p});a.name===mt&&(T.selected=!0)}),L.addEventListener("change",()=>{L.value?this.frontmatter.area=`"[[${this.plugin.settings.areasFolder}${L.value}|${L.value}]]"`:this.frontmatter.area='""'}),b.addEventListener("change",()=>{if(b.value){let a=N.find(p=>p.file.path===b.value);a&&(this.frontmatter.projects=[`"[[${a.file.path}|${a.file.basename}]]"`],L.value="",this.frontmatter.area='""')}else this.frontmatter.projects=[]}),e=t.createDiv({cls:"edit-task-section"});let X=e.createDiv({cls:"edit-task-row-inline"}),ot=X.createDiv({cls:"edit-task-inline-group"});ot.createSpan({cls:"edit-task-label",text:"\u{1F464} With"});let y=ot.createEl("select",{cls:"edit-task-select-small"});y.createEl("option",{value:"",text:"(none)"});let C=this.getNotesOfType(this.plugin.settings.personTypeField,this.plugin.settings.personTypeValue).sort((a,p)=>a.basename.localeCompare(p.basename)),v=this.getDiscussWithBasename();C.forEach(a=>{let p=y.createEl("option",{value:a.path,text:a.basename});a.basename===v&&(p.selected=!0)}),y.addEventListener("change",()=>{if(y.value){let a=C.find(p=>p.path===y.value);a&&(this.frontmatter["discuss-with"]=[`"[[${a.path}|${a.basename}]]"`])}else delete this.frontmatter["discuss-with"]});let f=X.createDiv({cls:"edit-task-inline-group"});f.createSpan({cls:"edit-task-label",text:"\u{1F4C5} During"});let x=f.createEl("select",{cls:"edit-task-select-small"});x.createEl("option",{value:"",text:"(none)"});let A=this.getNotesOfType(this.plugin.settings.eventTypeField,this.plugin.settings.eventTypeValue).sort((a,p)=>p.basename.localeCompare(a.basename)).slice(0,50),B=this.getDiscussDuringBasename();A.forEach(a=>{let p=a.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,""),T=x.createEl("option",{value:a.path,text:p});(a.basename===B||p===B)&&(T.selected=!0)}),x.addEventListener("change",()=>{if(x.value){let a=A.find(p=>p.path===x.value);if(a){let p=a.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${a.path}|${p}]]"`]}}else delete this.frontmatter["discuss-during"]}),s=t.createDiv({cls:"edit-task-section"});let ct=s.createDiv({cls:"edit-task-row-inline"}),lt=ct.createDiv({cls:"edit-task-inline-group"});lt.createSpan({cls:"edit-task-label",text:"\u{1F3EA} Store"});let q=lt.createEl("input",{cls:"edit-task-input-small",attr:{type:"text",placeholder:"Type or select...",list:"store-suggestions",value:String(this.frontmatter.store||"").replace(/^["']|["']$/g,"")}}),ke=ct.createEl("datalist",{attr:{id:"store-suggestions"}}),Xt=new Set;this.getNotesOfType(this.plugin.settings.actionTypeField,this.plugin.settings.actionTypeValue).forEach(a=>{var M;let p=this.app.metadataCache.getFileCache(a),T=(M=p==null?void 0:p.frontmatter)==null?void 0:M.store;if(T){let H=String(T).replace(/^["']|["']$/g,"");H&&Xt.add(H)}}),Array.from(Xt).sort().forEach(a=>{ke.createEl("option",{value:a})}),q.addEventListener("change",()=>{q.value?this.frontmatter.store=q.value:delete this.frontmatter.store}),h();let zt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),Zt=zt.createDiv({cls:"edit-task-inline-group"});Zt.createSpan({cls:"edit-task-label",text:"\u{1F5D3}\uFE0F Scheduled"}),n=Zt.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:bt(this.frontmatter.scheduled)}}),n.addEventListener("change",()=>{this.frontmatter.scheduled=n.value||void 0,n.value||delete this.frontmatter.scheduled});let te=zt.createDiv({cls:"edit-task-inline-group"});te.createSpan({cls:"edit-task-label",text:"\u{1F4C5} Due"});let ft=te.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:bt(this.frontmatter.due)}});ft.addEventListener("change",()=>{this.frontmatter.due=ft.value||void 0,ft.value||delete this.frontmatter.due});let ee=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),j=ee.createDiv({cls:"edit-task-inline-group"});j.createSpan({cls:"edit-task-label",text:"\u{1F501} Every"});let At=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],yt=["MO","TU","WE","TH","FR","SA","SU"],z=j.createEl("input",{cls:"edit-task-input-small",attr:{type:"number",min:"1",max:"99",value:"1"}});z.style.width="45px",z.style.display="none";let V=j.createEl("select",{cls:"edit-task-select-small"});V.createEl("option",{value:"",text:"(none)"}),V.createEl("option",{value:"day",text:"day"}),V.createEl("option",{value:"week",text:"week"}),V.createEl("option",{value:"month",text:"month"}),V.createEl("option",{value:"year",text:"year"});let se=j.createSpan({cls:"edit-task-label",text:"on"});se.style.display="none";let Z=j.createEl("select",{cls:"edit-task-select-small"});At.forEach((a,p)=>{Z.createEl("option",{value:yt[p],text:a})}),Z.style.display="none";let O=j.createEl("select",{cls:"edit-task-select-small"});O.createEl("option",{value:"day",text:"day"}),At.forEach((a,p)=>{O.createEl("option",{value:yt[p],text:a})}),O.style.display="none";let tt=j.createEl("select",{cls:"edit-task-select-small"}),ne=[{label:"1st",value:"1"},{label:"2nd",value:"2"},{label:"3rd",value:"3"},{label:"4th",value:"4"},{label:"last",value:"-1"}];ne.forEach(a=>{tt.createEl("option",{value:a.value,text:a.label})}),tt.style.display="none";let et=j.createEl("select",{cls:"edit-task-select-small"});for(let a=1;a<=31;a++){let p=a===1||a===21||a===31?"st":a===2||a===22?"nd":a===3||a===23?"rd":"th";et.createEl("option",{value:String(a),text:`${a}${p}`})}et.style.display="none";let G=j.createEl("select",{cls:"edit-task-select-small"});["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((a,p)=>{G.createEl("option",{value:String(p+1),text:a})}),G.style.display="none";let Y=j.createEl("select",{cls:"edit-task-select-small"});Y.createEl("option",{value:"day",text:"day"}),At.forEach((a,p)=>{Y.createEl("option",{value:yt[p],text:a})}),Y.style.display="none";let st=j.createEl("select",{cls:"edit-task-select-small"});ne.forEach(a=>{st.createEl("option",{value:a.value,text:a.label})}),st.style.display="none";let nt=j.createEl("select",{cls:"edit-task-select-small"});for(let a=1;a<=31;a++)nt.createEl("option",{value:String(a),text:String(a)});nt.style.display="none";let vt=ee.createDiv({cls:"edit-task-inline-group"});vt.createSpan({cls:"edit-task-label",text:"from"});let wt=vt.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date"}});vt.style.display="none";let ie=String(this.frontmatter.rrule||"").replace(/^["']|["']$/g,""),dt="",ae=1,re=yt[(new Date().getDay()+6)%7],Tt=new Date().getDate(),oe=new Date().getMonth()+1,Ct="day",Lt="day",ce="1",le="1",de=this.frontmatter.recurrence_start?String(this.frontmatter.recurrence_start).replace(/^["']|["']$/g,""):n.value||new Date().toISOString().split("T")[0];if(ie){let a=rt(ie);if(a.DTSTART){let p=a.DTSTART;p.length===8&&(de=`${p.slice(0,4)}-${p.slice(4,6)}-${p.slice(6,8)}`)}ae=parseInt(a.INTERVAL||"1"),a.FREQ==="DAILY"?dt="day":a.FREQ==="WEEKLY"?(dt="week",a.BYDAY&&(re=a.BYDAY)):a.FREQ==="MONTHLY"?(dt="month",a.BYSETPOS&&a.BYDAY?(Ct=a.BYDAY,ce=a.BYSETPOS):a.BYMONTHDAY&&(Ct="day",Tt=parseInt(a.BYMONTHDAY))):a.FREQ==="YEARLY"&&(dt="year",a.BYMONTH&&(oe=parseInt(a.BYMONTH)),a.BYSETPOS&&a.BYDAY?(Lt=a.BYDAY,le=a.BYSETPOS):a.BYMONTHDAY&&(Lt="day",Tt=parseInt(a.BYMONTHDAY)))}V.value=dt,z.value=String(ae),Z.value=re,et.value=String(Tt),G.value=String(oe),nt.value=String(Tt),O.value=Ct,Y.value=Lt,tt.value=ce,st.value=le,wt.value=de;let kt=()=>{let a=V.value,p=O.value,T=Y.value,M=a==="month"&&p!=="day",H=a==="year"&&T!=="day";z.style.display=a?"":"none",se.style.display=a==="week"||a==="month"||a==="year"?"":"none",Z.style.display=a==="week"?"":"none",O.style.display=a==="month"?"":"none",tt.style.display=M?"":"none",et.style.display=a==="month"&&!M?"":"none",G.style.display=a==="year"?"":"none",Y.style.display=a==="year"?"":"none",st.style.display=H?"":"none",nt.style.display=a==="year"&&!H?"":"none",vt.style.display=a?"":"none"};kt(),O.addEventListener("change",kt),Y.addEventListener("change",kt);let De=()=>{let a=wt.value||n.value||new Date().toISOString().split("T")[0],p=Vt(a),T=V.value,M=parseInt(z.value)||1;switch(T){case"day":return`DTSTART:${p};FREQ=DAILY;INTERVAL=${M}`;case"week":return`DTSTART:${p};FREQ=WEEKLY;INTERVAL=${M};BYDAY=${Z.value}`;case"month":return O.value!=="day"?`DTSTART:${p};FREQ=MONTHLY;INTERVAL=${M};BYDAY=${O.value};BYSETPOS=${tt.value}`:`DTSTART:${p};FREQ=MONTHLY;INTERVAL=${M};BYMONTHDAY=${et.value}`;case"year":return Y.value!=="day"?`DTSTART:${p};FREQ=YEARLY;INTERVAL=${M};BYMONTH=${G.value};BYDAY=${Y.value};BYSETPOS=${st.value}`:`DTSTART:${p};FREQ=YEARLY;INTERVAL=${M};BYMONTH=${G.value};BYMONTHDAY=${nt.value}`;default:return""}},I=()=>{let a=De();if(a){let p=wt.value||n.value||new Date().toISOString().split("T")[0];this.frontmatter.rrule=a,this.frontmatter.recurrence_start=p}else delete this.frontmatter.rrule,delete this.frontmatter.recurrence_start};V.addEventListener("change",()=>{kt(),I()}),z.addEventListener("change",I),Z.addEventListener("change",I),et.addEventListener("change",I),O.addEventListener("change",I),tt.addEventListener("change",I),G.addEventListener("change",I),Y.addEventListener("change",I),st.addEventListener("change",I),nt.addEventListener("change",I),wt.addEventListener("change",I);let pe=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),ue=pe.createDiv({cls:"edit-task-inline-group"});ue.createSpan({cls:"edit-task-label",text:"Status"});let jt=ue.createDiv({cls:"edit-task-icon-group"}),Ee=["none","open","in-progress","done","dropped"],be=this.frontmatter.status||"none";Ee.forEach(a=>{let p=jt.createSpan({cls:"task-status-dot"+(be===a?" selected":""),attr:{"data-status":a,title:a}});p.addEventListener("click",()=>{jt.querySelectorAll(".task-status-dot").forEach(T=>T.removeClass("selected")),p.addClass("selected"),this.frontmatter.status=a})});let ge=pe.createDiv({cls:"edit-task-inline-group"});ge.createSpan({cls:"edit-task-label",text:"Priority"});let Nt=ge.createDiv({cls:"edit-task-icon-group"}),Se=[{value:"anytime",icon:"\u2022"},{value:"today",icon:"\u2B50"},{value:"someday",icon:"\u{1F4AD}"}],xe=this.frontmatter.priority||"anytime";Se.forEach(a=>{let p=Nt.createSpan({cls:"edit-task-icon"+(xe===a.value?" active":""),text:a.icon,attr:{title:a.value}});p.addEventListener("click",()=>{Nt.querySelectorAll(".edit-task-icon").forEach(T=>T.removeClass("active")),p.addClass("active"),this.frontmatter.priority=a.value})});let he=t.createDiv({cls:"edit-task-section"});he.createDiv({cls:"edit-task-section-label",text:"Notes"});let It=he.createEl("textarea",{cls:"edit-task-notes-input",attr:{placeholder:"Add notes...",rows:"3"}}),me='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n',fe=this.body.indexOf("```\n",this.body.indexOf("```dataviewjs")),Pe=fe!==-1?this.body.substring(fe+4).trim():"";It.value=Pe,It.addEventListener("input",()=>{let a=It.value.trim();this.body=a?me+`
`+a:me});let Rt=t.createDiv({cls:"edit-task-button-row"}),ye=Rt.createEl("button",{cls:"edit-task-delete",text:"\u{1F5D1}\uFE0F"});ye.setAttribute("title","Delete task"),ye.addEventListener("click",()=>this.deleteTask());let ve=Rt.createEl("button",{cls:"edit-task-ai",text:"\u2728"});ve.setAttribute("title","AI suggest fields"),ve.addEventListener("click",()=>this.suggestFieldsWithAI(r,jt,Nt,ft,n,d,b,L,y,x,q,h)),Rt.createEl("button",{cls:"edit-task-save",text:"Save Changes"}).addEventListener("click",()=>this.saveChanges()),this.scope.register(["Mod"],"Enter",a=>(a.preventDefault(),this.saveChanges(),!1))}async deleteTask(){if(this.isCreateMode){this.close();return}let t=this.app.vault.getAbstractFileByPath(this.taskPath);if(!t||!(t instanceof $.TFile)){new $.Notice("Error: Task file not found");return}let e=String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")||t.basename;confirm(`Delete "${e}"?`)&&(await this.app.vault.delete(t),this.didSave=!0,new $.Notice("Task deleted"),this.close())}async suggestFieldsWithAI(t,e,s,n,o,r,i,d,u,g,h,m){try{let w=this.app.plugins.plugins["opper-ai"];if(!w){new $.Notice("Opper AI plugin not found. Please install and enable it.");return}if(!w.api){new $.Notice("Opper AI plugin API not initialized. Please reload Obsidian.");return}new $.Notice("\u2728 Analyzing task...",2e3);let b=new Date().toISOString().split("T")[0],P=this.getNotesOfType(this.plugin.settings.projectTypeField,this.plugin.settings.projectTypeValue),S=P.map(v=>{var ct,lt;let f=this.app.metadataCache.getFileCache(v),x=(ct=f==null?void 0:f.frontmatter)==null?void 0:ct.state,A=(lt=f==null?void 0:f.frontmatter)==null?void 0:lt.area,B="No Area";if(A&&typeof A=="string"&&(A=A.replace(/^["']|["']$/g,""),A.includes("|"))){let q=A.split("|");q.length>=2&&(B=q[1].replace(/\]\]$/,"").trim())}return{name:v.basename,area:B,state:x}}).filter(v=>v.state==="active"),F=this.getNotesOfType(this.plugin.settings.personTypeField,this.plugin.settings.personTypeValue),N=F.map(v=>v.basename),R=this.getNotesOfType(this.plugin.settings.eventTypeField,this.plugin.settings.eventTypeValue),K=R.filter(v=>{var A;let f=this.app.metadataCache.getFileCache(v),x=(A=f==null?void 0:f.frontmatter)==null?void 0:A.date;return x?x>=b:!0}).map(v=>v.basename),U=new Set;this.getNotesOfType(this.plugin.settings.actionTypeField,this.plugin.settings.actionTypeValue).forEach(v=>{var A;let f=this.app.metadataCache.getFileCache(v),x=(A=f==null?void 0:f.frontmatter)==null?void 0:A.store;if(x){let B=String(x).replace(/^["']|["']$/g,"");B&&U.add(B)}});let L=Array.from(U),mt=t.value||"",X=this.body||"",ot=await w.api.call("detect-action-fields",{task_title:mt,task_body:X,current_date:b,available_contexts:this.getContextsFromFolder(),available_projects:S,available_areas:this.getAreasFromFolder().map(v=>v.name),available_people:N,available_meetings:K,available_stores:L},{instructions:this.getAIInstructions(),outputSchema:this.getAIOutputSchema(),model:"gcp/gemini-flash-latest"});if(!ot.json_payload){new $.Notice("No suggestions from AI");return}let y=ot.json_payload,C=[];if(y.title&&y.title.trim()&&(t.value=y.title,this.frontmatter.title=y.title,C.push("title")),y.priority){s.querySelectorAll(".edit-task-icon").forEach(f=>f.removeClass("active"));let v=s.querySelector(`[title="${y.priority}"]`);v&&(v.addClass("active"),this.frontmatter.priority=y.priority,C.push("priority"))}if(y.context){let v=r.querySelector(".context-pill:not(.active)");r.querySelectorAll(".context-pill").forEach(f=>{var A;(((A=f.textContent)==null?void 0:A.replace("@",""))||"")===y.context&&!f.hasClass("active")&&(f.addClass("active"),C.push("context"))}),this.updateContexts(r),m()}if(y.projects&&y.projects.length>0){let v=y.projects[0],f=P.find(x=>x.basename===v);f&&(i.value=f.path,this.frontmatter.projects=[`"[[${f.path}|${f.basename}]]"`],C.push("project"),d.value="",delete this.frontmatter.area)}if(y.area&&(!y.projects||y.projects.length===0)&&Array.from(d.options).find(f=>f.value===y.area)&&(d.value=y.area,this.frontmatter.area=`"[[${this.plugin.settings.areasFolder}${y.area}|${y.area}]]"`,C.push("area")),y.discuss_with&&y.discuss_with.length>0){let v=y.discuss_with[0],f=F.find(x=>x.basename===v);f&&(u.value=f.path,this.frontmatter["discuss-with"]=[`"[[${f.path}|${f.basename}]]"`],C.push("discuss-with"))}if(y.discuss_during&&y.discuss_during.length>0){let v=y.discuss_during[0],f=R.find(x=>x.basename===v||x.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")===v);if(f){g.value=f.path;let x=f.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${f.path}|${x}]]"`],C.push("discuss-during")}}if(y.store&&(h.value=y.store,this.frontmatter.store=y.store,C.push("store")),y.due){let v=this.parseNaturalDate(y.due,b);v&&(n.value=v,this.frontmatter.due=v,C.push("due"))}if(y.scheduled){let v=this.parseNaturalDate(y.scheduled,b);v&&(o.value=v,this.frontmatter.scheduled=v,C.push("scheduled"))}m(),C.length>0?new $.Notice(`\u2728 Applied: ${C.join(", ")}`):new $.Notice("No fields detected")}catch(w){console.error("AI suggestion failed:",w),new $.Notice("AI suggestion failed: "+w.message)}}parseNaturalDate(t,e){if(!t)return null;let s=t.toLowerCase().trim(),n=new Date(e);if(s==="today")return e;if(s==="tomorrow"){let r=new Date(n);return r.setDate(r.getDate()+1),r.toISOString().split("T")[0]}if(s.startsWith("next ")){let r=s.replace("next ",""),d=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(r);if(d>=0){let u=new Date(n),g=u.getDay(),h=d-g;return h<=0&&(h+=7),u.setDate(u.getDate()+h),u.toISOString().split("T")[0]}}let o=s.match(/\d{4}-\d{2}-\d{2}/);return o?o[0]:null}getAIInstructions(){return`Analyze the task title and body to detect relevant GTD fields.

**Context Detection Rules:**
Suggest ONE primary context:
- "focus": Deep work (write, design, review)
- "quick": Tasks under 5 minutes (send email, reply, check)
- "relax": Low-energy tasks (read, watch, browse)
- "home"/"office"/"brf"/"school": Location-specific
- "errands": Shopping or pickup (buy, pick up, get)
- "agenda": Discussion topics (when people/meetings mentioned)
- "waiting": Waiting on something/someone

**Priority Detection:**
- "today": Urgent cues (urgent, ASAP, today, now)
- "someday": Later cues (maybe, someday, consider)
- "anytime": Default

**Date Detection:**
Return dates as natural language (e.g., "next friday", "tomorrow").

**Project/Area:**
- If project matches \u2192 return project, leave area empty
- If no project \u2192 suggest area based on keywords

**People/Meeting Detection:**
Match to available lists when discussion is mentioned.

**Store Detection:**
For errands, extract store names.

**Title Generation:**
If title can be improved (more concise, action-oriented), suggest improvement.`}getAIOutputSchema(){return{type:"object",properties:{context:{type:"string",description:"Single primary context or empty"},projects:{type:"array",items:{type:"string"},description:"Detected project names"},area:{type:"string",description:"Suggested area if no projects"},priority:{type:"string",enum:["anytime","today","someday"]},scheduled:{type:"string",description:"Natural language scheduled date"},due:{type:"string",description:"Natural language due date"},discuss_with:{type:"array",items:{type:"string"},description:"People to discuss with"},discuss_during:{type:"array",items:{type:"string"},description:"Meetings"},store:{type:"string",description:"Store name for errands"},title:{type:"string",description:"Suggested title improvement"},confidence_scores:{type:"object",properties:{context:{type:"number"},projects:{type:"number"},area:{type:"number"},priority:{type:"number"},scheduled:{type:"number"},due:{type:"number"},discuss_with:{type:"number"},discuss_during:{type:"number"},store:{type:"number"},title:{type:"number"}}}},required:["context","projects","area","priority","scheduled","due","discuss_with","discuss_during","store","title","confidence_scores"]}}getArrayField(t){let e=this.frontmatter[t];return Array.isArray(e)?e.map(s=>String(s).replace(/^["']|["']$/g,"")):[]}getProjectBasename(){var e;let t=this.frontmatter.projects;if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getAreaName(){let t=this.frontmatter.area;if(!t)return"";let s=String(t).replace(/^["']|["']$/g,"").match(/\|([^\]]+)\]\]/);return s?s[1]:""}getDiscussWithBasename(){var e;let t=this.frontmatter["discuss-with"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getDiscussDuringBasename(){var e;let t=this.frontmatter["discuss-during"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}updateContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];e.forEach(n=>{var r;let o=((r=n.textContent)==null?void 0:r.replace("@",""))||"";o&&s.push(o)}),this.frontmatter.contexts=s}getActiveContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];return e.forEach(n=>{var r;let o=((r=n.textContent)==null?void 0:r.replace("@",""))||"";o&&s.push(o)}),s}getNotesOfType(t,e){return this.app.vault.getMarkdownFiles().filter(s=>{var o;let n=this.app.metadataCache.getFileCache(s);return((o=n==null?void 0:n.frontmatter)==null?void 0:o[t])===e})}getAreasFromFolder(){let t=this.plugin.settings.areasFolder;return this.app.vault.getMarkdownFiles().filter(e=>e.path.startsWith(t)).map(e=>{var r,i,d,u;let s=this.app.metadataCache.getFileCache(e),n=(i=(r=s==null?void 0:s.frontmatter)==null?void 0:r.order)!=null?i:999,o=(u=(d=s==null?void 0:s.frontmatter)==null?void 0:d.emoji)!=null?u:"\u{1F4E6}";return{name:e.basename,order:n,emoji:o}}).sort((e,s)=>e.order-s.order)}getContextsFromFolder(){let t=this.plugin.settings.contextsFolder;return this.app.vault.getMarkdownFiles().filter(e=>e.path.startsWith(t)).map(e=>{var r,i;let s=this.app.metadataCache.getFileCache(e),n=(i=(r=s==null?void 0:s.frontmatter)==null?void 0:r.order)!=null?i:999;return{name:e.basename.startsWith("@")?e.basename.slice(1):e.basename,order:n}}).sort((e,s)=>e.order-s.order).map(e=>e.name)}async saveChanges(){this.frontmatter.dateModified=new Date().toISOString();let t=Q(this.frontmatter,this.body);if(this.isCreateMode)await this.app.vault.create(this.taskPath,t),new $.Notice("Action created");else{let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof $.TFile)){new $.Notice("Error: Task file not found");return}await this.app.vault.modify(e,t),new $.Notice("Task updated")}this.didSave=!0,this.close()}onClose(){let{contentEl:t}=this;t.empty(),this.cleanupViewportHandler(),this.didSave&&this.plugin.refreshDataview()}setupViewportHandler(){window.visualViewport&&(this.viewportHandler=()=>{let e=window.visualViewport.height-40;this.modalEl.style.setProperty("--modal-max-height",`${e}px`)},this.viewportHandler(),window.visualViewport.addEventListener("resize",this.viewportHandler)),this.modalEl.addEventListener("focusin",t=>{let e=t.target;(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT")&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"})},300)})}cleanupViewportHandler(){this.viewportHandler&&window.visualViewport&&(window.visualViewport.removeEventListener("resize",this.viewportHandler),this.viewportHandler=null)}};var we=600,Te=10,Kt=class extends _.WidgetType{constructor(t,e,s){super();this.plugin=t;this.actionPath=e;this.displayTitle=s}toDOM(){var o;let t=this.plugin.app.vault.getAbstractFileByPath(this.actionPath+".md"),e=t?this.plugin.app.metadataCache.getFileCache(t):null,s=(e==null?void 0:e.frontmatter)||{},n=(o=e==null?void 0:e.sections)==null?void 0:o.some(r=>r.type==="paragraph"||r.type==="list"||r.type==="heading");return this.plugin.createInlineTaskElement(s,this.actionPath+".md",this.displayTitle,n||!1)}eq(t){return this.actionPath===t.actionPath}};function Ie(l){return _.ViewPlugin.fromClass(class{constructor(c){this.decorations=this.buildDecorations(c)}update(c){(c.docChanged||c.viewportChanged)&&(this.decorations=this.buildDecorations(c.view))}buildDecorations(c){let t=[],e=/^(\s*)- \[[ x]\] \[\[(gtd\/actions\/)?(\d{8}-\d{6})\|([^\]]+)\]\]\s*$/;for(let{from:s,to:n}of c.visibleRanges)for(let o=s;o<=n;){let r=c.state.doc.lineAt(o),i=r.text.match(e);if(i){let d=i[1],u=`gtd/actions/${i[3]}`,g=i[4],h=_.Decoration.replace({widget:new Kt(l,u,g)}),m=r.from+d.length;t.push(h.range(m,r.to))}o=r.to+1}return _.Decoration.set(t,!0)}},{decorations:c=>c.decorations})}function Re(l){return _.ViewPlugin.fromClass(class{constructor(c){this.view=c;this.pressTimer=null;this.startPosition=null;this.activeElement=null;this.preventNextClick=!1;this.handlePointerDown=c=>{let e=c.target.closest(".cm-line");if(!e)return;let s=this.view.posAtCoords({x:c.clientX,y:c.clientY});if(s===null)return;let n=this.view.state.doc.lineAt(s),o=n.text.match(/^(\s*)- \[ \] (.+)$/);if(!o||!o[2]||/\[\[(gtd\/actions\/)?\d{8}-\d{6}\|/.test(n.text))return;let i=s-n.from,d=o[1].length+6;i>d||(this.startPosition={x:c.clientX,y:c.clientY},this.activeElement=e,e.classList.add("minimal-tasks-long-press-active"),this.pressTimer=window.setTimeout(()=>{this.triggerLongPress(o[2],n.from,n.to,c)},we))};this.handlePointerUp=()=>{this.cancelPress()};this.handlePointerMove=c=>{if(!this.startPosition||!this.pressTimer)return;Math.sqrt(Math.pow(c.clientX-this.startPosition.x,2)+Math.pow(c.clientY-this.startPosition.y,2))>Te&&this.cancelPress()};this.handlePointerCancel=()=>{this.cancelPress()};this.handleClick=c=>{this.preventNextClick&&(c.preventDefault(),c.stopPropagation(),this.preventNextClick=!1)};this.view.dom.addEventListener("pointerdown",this.handlePointerDown),this.view.dom.addEventListener("pointerup",this.handlePointerUp),this.view.dom.addEventListener("pointermove",this.handlePointerMove),this.view.dom.addEventListener("pointercancel",this.handlePointerCancel),this.view.dom.addEventListener("click",this.handleClick,!0)}destroy(){this.view.dom.removeEventListener("pointerdown",this.handlePointerDown),this.view.dom.removeEventListener("pointerup",this.handlePointerUp),this.view.dom.removeEventListener("pointermove",this.handlePointerMove),this.view.dom.removeEventListener("pointercancel",this.handlePointerCancel),this.view.dom.removeEventListener("click",this.handleClick,!0),this.cancelPress()}cancelPress(){this.pressTimer&&(clearTimeout(this.pressTimer),this.pressTimer=null),this.activeElement&&(this.activeElement.classList.remove("minimal-tasks-long-press-active"),this.activeElement=null),this.startPosition=null}triggerLongPress(c,t,e,s){this.cancelPress(),this.preventNextClick=!0,"vibrate"in navigator&&navigator.vibrate(50),l.convertToAction(c,t,e,this.view)}update(c){}})}var $t=class extends k.Plugin{async onload(){console.log("Loading Minimal Tasks plugin"),await this.loadSettings(),window.MinimalTasks={renderTask:this.renderTask.bind(this),renderTaskList:this.renderTaskList.bind(this),settings:this.settings},this.registerDomEvent(document,"click",this.handleClick.bind(this)),this.registerDomEvent(document,"contextmenu",this.handleContextMenu.bind(this)),this.addSettingTab(new pt(this.app,this)),this.registerEditorExtension(Re(this)),this.registerEditorExtension(Ie(this)),this.registerMarkdownPostProcessor((t,e)=>{this.processActionLinks(t,e)}),this.addRibbonIcon("plus-circle","New Action",async()=>{await this.createNewAction()}),this.registerEvent(this.app.metadataCache.on("dataview:index-ready",()=>{setTimeout(()=>{try{this.app.commands.executeCommandById("dataview:dataview-rebuild-current-view")}catch(t){}},100)})),this.addCommand({id:"new-action",name:"Create new action",callback:async()=>{await this.createNewAction()}}),this.addCommand({id:"new-action-from-context",name:"Create new action from current note",callback:async()=>{await this.createNewActionFromContext()}}),this.addCommand({id:"edit-action",name:"Edit current action",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return e&&e.path.startsWith("gtd/actions/")?(t||new J(this.app,this,e.path).open(),!0):!1}})}async createNewAction(t){try{let n=`gtd/actions/${`${ut()}.md`}`,o=new Date().toISOString(),r={type:"action",title:"",status:"open",priority:"anytime",dateCreated:o,dateModified:o,tags:[],contexts:t!=null&&t.context?[t.context]:[],projects:t!=null&&t.project?[`"[[${t.project}]]"`]:[],area:t!=null&&t.area?`"[[${this.settings.areasFolder}${t.area}|${t.area}]]"`:'""'};new J(this.app,this,n,r,t==null?void 0:t.body).open()}catch(e){console.error("Error creating action:",e),new k.Notice("Error creating action: "+e.message)}}async createNewActionFromContext(){var o,r,i;let t=this.app.workspace.getActiveFile();if(!t){await this.createNewAction();return}let e=this.app.metadataCache.getFileCache(t),s=(o=e==null?void 0:e.frontmatter)==null?void 0:o.type,n={};if(s==="project")n.project=t.path;else if(s==="event"||s==="meeting"){let d=(r=e==null?void 0:e.frontmatter)==null?void 0:r.project;if(d){let u=String(d).match(/\[\[([^\]|]+)/);if(u){let g=(i=u[1].split("/").pop())==null?void 0:i.replace(/\.md$/,""),h=this.app.vault.getMarkdownFiles().find(m=>m.basename===g&&m.path.startsWith("gtd/projects/"));h&&(n.project=h.path)}}}else t.path.startsWith(this.settings.areasFolder)&&(n.area=t.basename);if(s==="checklist-template"||s==="checklist"){let d=await this.app.vault.read(t),g=W(d).body.replace(/```dataviewjs\s*\n[\s\S]*?\n```\s*/g,"").replace(/---\s*$/g,"").trim();if(g){let h=`From: [[${t.path.replace(/\.md$/,"")}]]`;n.body=`${h}

${g}`}}await this.createNewAction(n)}async loadSettings(){this.settings=Object.assign({},Yt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),window.MinimalTasks&&(window.MinimalTasks.settings=this.settings)}async renderTaskList(t,e,s={}){let n=Array.isArray(e)?e:e.array(),o=await Promise.all(n.map(async d=>({task:d,hasNotes:await this.hasNoteContent(d.file),enrichedTask:await this.enrichTaskData(t,d)})));return this.sortTasks(o).map(d=>this.renderTask(d.enrichedTask,{...s,hasNotes:d.hasNotes})).join("<br>")}async enrichTaskData(t,e){let n=e[this.settings.titleField]||e.file.name.replace(/\.md$/,""),o=`<a data-href="${e.file.path}" href="${e.file.path}" class="internal-link" target="_blank" rel="noopener">${n}</a>`,r,i=e[this.settings.projectField];return i&&i.length>0&&(r=i.map(d=>{var b;let u=typeof d=="string"?d:String(d),g=u.match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(!g)return{link:u};let h=g[1],m=g[2]||((b=h.split("/").pop())==null?void 0:b.replace(/\.md$/,""))||h,w=`<a data-href="${h}" href="${h}" class="internal-link" target="_blank" rel="noopener">${m}</a>`,E=t.page(h);if(!E)return{link:w};if(E[this.settings.dueField]){let P=t.date(E[this.settings.dueField]),S=t.date("today"),F=P.toFormat("MMM dd");return{link:w,due:E[this.settings.dueField],dueFormatted:F,overdue:P<S}}return{link:w}})),{status:e[this.settings.statusField],priority:e[this.settings.priorityField],link:o,file:{path:e.file.path},contexts:e[this.settings.contextsField],"discuss-with":e[this.settings.discussWithField],"discuss-during":e[this.settings.discussDuringField],store:e[this.settings.storeField],due:e[this.settings.dueField],scheduled:e[this.settings.scheduledField],rrule:e[this.settings.rruleField],projects:i,projectsWithMeta:r}}async hasNoteContent(t){var e;try{let s=t.path||((e=t.file)==null?void 0:e.path);if(!s)return!1;let n=this.app.vault.getAbstractFileByPath(s);if(!n||!(n instanceof k.TFile))return!1;let o=await this.app.vault.read(n),r=/^---\n[\s\S]*?\n---\n/,i=o.replace(r,"").trim();if(this.settings.noteContentIgnorePattern)try{let d=new RegExp(this.settings.noteContentIgnorePattern);i=i.replace(d,"").trim()}catch(d){console.error("Invalid noteContentIgnorePattern regex:",d)}return i.length>0}catch(s){return!1}}getEffectiveDueDate(t){var o;let e=t.task[this.settings.dueField],s=((o=t.enrichedTask.projectsWithMeta)==null?void 0:o.map(r=>r.due).filter(Boolean))||[],n=[e,...s].filter(Boolean);return n.length===0?null:n.sort()[0]}sortTasks(t){return t.sort((e,s)=>{let n=this.settings.statusField,o=this.settings.priorityField,r=e.task[n]==="in-progress",i=s.task[n]==="in-progress";if(r&&!i)return-1;if(!r&&i)return 1;let d=e.task[o]==="today",u=s.task[o]==="today";if(d&&!u)return-1;if(!d&&u)return 1;let g=this.getEffectiveDueDate(e),h=this.getEffectiveDueDate(s);if(g&&!h)return-1;if(!g&&h)return 1;if(g&&h){if(g<h)return-1;if(g>h)return 1}return e.task.file.ctime-s.task.file.ctime})}renderTask(t,e={}){let{hasNotes:s=!1,showProjects:n=!0,showContexts:o=!1,excludePills:r=[]}=e,i;if(t.file&&t.file.path)i=t.file.path;else if(t.path)i=t.path;else return console.error("MinimalTasks: No path found in task object",t),"Error: No task path";let d=t[this.settings.statusField]||"none",u=t[this.settings.priorityField]||"anytime",g=d==="done"||d==="dropped",h=this.createControls(u,d,i),m=this.createContent(t,s,g,o,r,i),w=this.createMainLine(h,m),E=this.createProjectsSection(t,n);return`<div class="minimal-task-row" data-task-path="${i}" data-status="${d}" data-priority="${u}">${w}${E}</div>`}createControls(t,e,s){return`<div class="minimal-task-controls">${Pt(t,s)}${xt(e,s)}</div>`}createContent(t,e,s,n,o,r){let i=this.createTitle(t,s),d=`<span class="minimal-task-edit-icon" data-task-path="${r}" title="Edit task">\u22EF</span>`,u=e&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",g=this.createMetadata(t,n,o);return`<div class="minimal-task-content">${`<span class="minimal-task-title-group">${i}${u}${d}</span>`}${g}</div>`}createTitle(t,e){let s=t.link||"Untitled";return`<span class="minimal-task-title${e?" is-completed":""}">${s}</span>`}createMetadata(t,e,s){let n=[],o=this.renderDateBadges(t);o&&n.push(o);let r=t[this.settings.rruleField];r&&!s.includes("recurrence")&&n.push(Mt(r));let i=t[this.settings.contextsField]||[];e&&i.length>0&&!s.includes("contexts")&&n.push(Ft(i));let d=t[this.settings.discussWithField];d&&!s.includes("person")&&n.push(qt(d));let u=t[this.settings.discussDuringField];u&&!s.includes("meeting")&&n.push(Gt(u));let g=t[this.settings.storeField];return g&&!s.includes("store")&&n.push(Qt(g)),n.length===0?"":`<span class="minimal-task-metadata">${n.join("")}</span>`}createMainLine(t,e){return`<div class="minimal-task-main">${t}${e}</div>`}createProjectsSection(t,e){if(!this.settings.showProjects||!e)return"";let s=t[this.settings.projectField]||[];return s.length===0?"":`<div class="minimal-task-projects">${(t.projectsWithMeta||s).map(r=>this.createProjectItem(r)).join("")}</div>`}createProjectItem(t){let e="";if(t.link){let s=t;if(e=s.link,this.settings.showProjectDueDates&&s.due){let n=s.dueFormatted||s.due,o=s.overdue?" is-overdue":"";e+=` <span class="minimal-badge minimal-badge-date${o}">\u{1F4C5} ${n}</span>`}}else e=typeof t=="string"?t:String(t);return`<div class="minimal-task-project">${e}</div>`}renderInlineTaskHTML(t,e,s,n){let o=t[this.settings.statusField]||"open",r=t[this.settings.priorityField]||"anytime",i=t[this.settings.titleField]||s,d=o==="done"||o==="dropped",u=e.replace(".md",""),g=Pt(r,e),h=xt(o,e),w=`<a class="internal-link${d?" is-completed":""}" data-href="${u}" href="${u}">${at(i)}</a>`,E=n&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",b=`<span class="minimal-task-edit-icon" data-task-path="${e}" title="Edit task">\u22EF</span>`,P=[],S=t[this.settings.scheduledField];S&&P.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${S}</span>`);let F=t[this.settings.dueField];if(F){let X=new Date(F)<new Date(new Date().toDateString())?" is-overdue":"";P.push(`<span class="minimal-badge minimal-badge-date${X}">\u{1F4C5} ${F}</span>`)}let N=t[this.settings.rruleField];N&&P.push(Mt(N));let R=t[this.settings.contextsField]||[];R.length>0&&P.push(Ft(R));let K=t[this.settings.projectField]||[];K.length>0&&P.push(Jt(K));let U=P.length>0?` <span class="minimal-task-metadata">${P.join("")}</span>`:"",L=`<span class="minimal-task-title-group">${w}${E}${b}</span>`;return`${g}${h} ${L}${U}`}createInlineTaskElement(t,e,s,n){let o=this.renderInlineTaskHTML(t,e,s,n);return new DOMParser().parseFromString(`<span class="minimal-task-inline">${o}</span>`,"text/html").body.firstChild}renderDateBadges(t){let e=[],s=t[this.settings.dueField],n=t[this.settings.scheduledField];if(n){let o=new Date(n);o.setHours(0,0,0,0);let r=Et(o);e.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${r}</span>`)}if(s){let o=new Date(s);o.setHours(0,0,0,0);let r=new Date;r.setHours(0,0,0,0);let i=o<r,d=Et(o),u=i?"\u26A0\uFE0F":"\u{1F4C5}",g=i?" is-overdue":"";e.push(`<span class="minimal-badge minimal-badge-date${g}">${u} ${d}</span>`)}return e.join("")}async handleClick(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),await this.cycleStatus(e);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),await this.cyclePriority(e);return}if(e.classList.contains("minimal-task-edit-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskPath;s&&new J(this.app,this,s).open();return}}handleContextMenu(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),this.showStatusMenu(e,t);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),this.showPriorityMenu(e,t);return}}showStatusMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.status;if(!s)return;let o=new k.Menu;[{value:"none",label:"\u26AA None",icon:"\u26AA"},{value:"open",label:"\u{1F535} Open",icon:"\u{1F535}"},{value:"in-progress",label:"\u{1F7E1} In Progress",icon:"\u{1F7E1}"},{value:"done",label:"\u2705 Done",icon:"\u2705"},{value:"dropped",label:"\u{1F534} Dropped",icon:"\u{1F534}"}].forEach(i=>{o.addItem(d=>{d.setTitle(i.label+(n===i.value?" \u2713":"")).onClick(async()=>{await this.setStatus(t,s,i.value)})})}),o.showAtMouseEvent(e)}showPriorityMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.priority;if(!s)return;let o=new k.Menu;[{value:"anytime",label:"\u2022 Anytime",icon:"\u2022"},{value:"today",label:"\u2B50 Today",icon:"\u2B50"},{value:"someday",label:"\u{1F4AD} Someday",icon:"\u{1F4AD}"}].forEach(i=>{o.addItem(d=>{d.setTitle(i.label+(n===i.value?" \u2713":"")).onClick(async()=>{await this.setPriority(t,s,i.value)})})}),o.showAtMouseEvent(e)}async setStatus(t,e,s){try{await this.updateTaskField(e,"status",s);let n=t.closest(".minimal-task-row");n&&n.setAttribute("data-status",s),t.dataset.status=s;let o=n==null?void 0:n.querySelector(".minimal-task-title");o&&(s==="done"||s==="dropped"?o.classList.add("is-completed"):o.classList.remove("is-completed"));let r={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new k.Notice(r[s]||s)}catch(n){console.error("Error setting status:",n),new k.Notice("Error updating task status")}}async setPriority(t,e,s){try{await this.updateTaskField(e,"priority",s),t.dataset.priority=s,t.textContent=ht(s);let n={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new k.Notice(n[s]||s)}catch(n){console.error("Error setting priority:",n),new k.Notice("Error updating task priority")}}async cycleStatus(t){let e=t.dataset.taskPath,s=t.dataset.status;if(!e)return;let n=["none","open","in-progress","done","dropped"],o=n.indexOf(s||"none"),r=n[(o+1)%n.length];try{await this.updateTaskField(e,"status",r);let i=t.closest(".minimal-task-row");i&&i.setAttribute("data-status",r),t.dataset.status=r;let d=i==null?void 0:i.querySelector(".minimal-task-title");d&&(r==="done"||r==="dropped"?d.classList.add("is-completed"):d.classList.remove("is-completed"));let u={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new k.Notice(u[r]||r)}catch(i){console.error("Error cycling status:",i),new k.Notice("Error updating task status")}}async cyclePriority(t){let e=t.dataset.taskPath,s=t.dataset.priority;if(!e)return;let n=["anytime","today","someday"],o=n.indexOf(s||"anytime"),r=n[(o+1)%n.length];try{await this.updateTaskField(e,"priority",r),t.dataset.priority=r,t.textContent=ht(r);let i={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new k.Notice(i[r]||r)}catch(i){console.error("Error cycling priority:",i),new k.Notice("Error updating task priority")}}async updateTaskField(t,e,s){let n=this.app.vault.getAbstractFileByPath(t);if(!n||!(n instanceof k.TFile))throw new Error(`Task file not found: ${t}`);let o=await this.app.vault.read(n),{frontmatter:r,body:i}=W(o);r.rrule&&String(r.rrule).trim().length>0&&(e==="status"&&s==="done")&&await this.createNextRecurringInstance(r,i),r[e]=s,e==="status"&&s==="done"&&!r.completedDate&&(r.completedDate=new Date().toISOString().split("T")[0]),e==="status"&&s!=="done"&&r.completedDate&&delete r.completedDate;let g=Q(r,i);await this.app.vault.modify(n,g)}async createNextRecurringInstance(t,e){try{new k.Notice("\u{1F501} Creating next instance...",2e3);let s=String(t.rrule).replace(/^["']|["']$/g,""),n=new Date().toISOString().split("T")[0],o=Ut(s,n),r=new Date,g=`gtd/actions/${`${r.toISOString().replace(/[:.]/g,"-").replace("T","-").split("-").slice(0,6).join("").replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1$2$3-$4$5$6")}.md`}`,h=r.toISOString(),m={status:"open",priority:"anytime",dateCreated:h,dateModified:h,tags:t.tags||"[]",type:"action",title:t.title||"",contexts:t.contexts||[],area:t.area||'""',scheduled:o,rrule:`"${s}"`};if(t.projects&&(m.projects=t.projects),t.due&&t.scheduled){let b=new Date(t.scheduled),S=new Date(t.due).getTime()-b.getTime(),F=new Date(new Date(o).getTime()+S);m.due=F.toISOString().split("T")[0]}else t.due&&(m.due=t.due);t.recurrence_start&&(m.recurrence_start=t.recurrence_start),t.store&&(m.store=t.store),t["discuss-with"]&&(m["discuss-with"]=t["discuss-with"]),t["discuss-during"]&&(m["discuss-during"]=t["discuss-during"]);let w=e.replace(/- \[[xX]\]/g,"- [ ]"),E=Q(m,w);await this.app.vault.create(g,E),new k.Notice(`\u2705 Completed! Next: ${o}`,3e3)}catch(s){console.error("Failed to create recurring task instance:",s),new k.Notice("\u26A0\uFE0F Failed to create next instance: "+s.message,5e3)}}refreshDataview(){setTimeout(()=>{try{this.app.commands.executeCommandById("dataview:dataview-rebuild-current-view")}catch(t){this.app.metadataCache.trigger("changed")}},100)}processActionLinks(t,e){var n;let s=t.querySelectorAll("li.task-list-item");for(let o of Array.from(s)){let r=o.querySelectorAll("a.internal-link"),i=!1;for(let d of Array.from(r)){let g=(d.getAttribute("data-href")||"").match(/^(gtd\/actions\/)?(\d{8}-\d{6})$/);if(!g)continue;i=!0;let h=`gtd/actions/${g[2]}.md`,m=d.textContent||g[2],w=this.app.vault.getAbstractFileByPath(h);if(!(w instanceof k.TFile))continue;let E=this.app.metadataCache.getFileCache(w),b=(E==null?void 0:E.frontmatter)||{},P=(n=E==null?void 0:E.sections)==null?void 0:n.some(N=>N.type==="paragraph"||N.type==="list"||N.type==="heading"),S=this.createInlineTaskElement(b,h,m,P||!1);d.replaceWith(S);let F=o.querySelector('input[type="checkbox"]');F&&(F.style.display="none")}if(!i){let d=o.querySelector('input[type="checkbox"]');if(!d)continue;let u=this.getTaskTextFromListItem(o);if(!u||u.trim()==="")continue;this.attachLongPressToCheckbox(d,u,e.sourcePath)}}}attachLongPressToCheckbox(t,e,s){let n=null,o=null,r=!1,i=()=>{n&&(clearTimeout(n),n=null),t.classList.remove("minimal-tasks-long-press-active"),o=null},d=m=>{o={x:m.clientX,y:m.clientY},t.classList.add("minimal-tasks-long-press-active"),n=window.setTimeout(()=>{i(),r=!0,"vibrate"in navigator&&navigator.vibrate(50),this.convertToActionFromReading(e,s)},we)},u=()=>{i()},g=m=>{if(!o||!n)return;Math.sqrt(Math.pow(m.clientX-o.x,2)+Math.pow(m.clientY-o.y,2))>Te&&i()},h=m=>{r&&(m.preventDefault(),m.stopPropagation(),r=!1)};t.addEventListener("pointerdown",d),t.addEventListener("pointerup",u),t.addEventListener("pointermove",g),t.addEventListener("pointercancel",u),t.addEventListener("click",h,!0)}getTaskTextFromListItem(t){var n;let e=t.cloneNode(!0),s=e.querySelector('input[type="checkbox"]');return s&&s.remove(),((n=e.textContent)==null?void 0:n.trim())||""}async convertToAction(t,e,s,n){try{let o=await this.detectNoteContext(),r=ut(),d=`gtd/actions/${`${r}.md`}`,u=this.buildConvertFrontmatter(t,o),g=this.app.workspace.getActiveFile(),h=g==null?void 0:g.path,m=this.buildActionContent(u,h);await this.app.vault.create(d,m);let w=`- [ ] [[${r}|${t}]]`;n.dispatch({changes:{from:e,to:s,insert:w}}),new k.Notice(`Created action: ${t}`)}catch(o){console.error("Error converting task:",o),new k.Notice("Error converting task: "+o.message)}}async convertToActionFromReading(t,e){var s;try{let n=this.app.vault.getAbstractFileByPath(e);if(!(n instanceof k.TFile)){new k.Notice("Source file not found");return}let o=await this.app.vault.read(n),{frontmatter:r}=W(o),i={};e.startsWith("gtd/projects/")&&!e.includes("archive")?i={projects:[`[[${((s=e.split("/").pop())==null?void 0:s.replace(".md",""))||""}]]`]}:r.type==="event"&&r.project?i={projects:[r.project]}:r.area&&(i={area:r.area});let d=ut(),g=`gtd/actions/${`${d}.md`}`,h=this.buildConvertFrontmatter(t,i),m=this.buildActionContent(h,e);await this.app.vault.create(g,m);let w=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),E=new RegExp(`^(\\s*)- \\[[ x]\\] ${w}$`,"m"),b=o.replace(E,`$1- [ ] [[${d}|${t}]]`);b!==o?(await this.app.vault.modify(n,b),new k.Notice(`Created action: ${t}`)):new k.Notice("Could not find task in source file")}catch(n){console.error("Error converting task:",n),new k.Notice("Error converting task: "+n.message)}}async detectNoteContext(){let t=this.app.workspace.getActiveFile();if(!t)return{};let e=await this.app.vault.read(t),{frontmatter:s}=W(e);return t.path.startsWith("gtd/projects/")&&!t.path.includes("archive")?{projects:[`[[${t.basename}]]`]}:s.type==="event"&&s.project?{projects:[s.project]}:s.area?{area:s.area}:{}}buildConvertFrontmatter(t,e){let s=new Date().toISOString(),n={type:"action",title:t,status:"open",priority:"anytime",dateCreated:s,dateModified:s,tags:[],contexts:[]},o=(e.projects||[]).filter(r=>r?(typeof r=="string"?r:String(r)).trim().length>0:!1);return o.length>0?(n.projects=o,n.area='""'):e.area&&e.area.trim()&&e.area!=='""'?(n.projects=[],n.area=e.area):(n.projects=[],n.area='""'),n}buildActionContent(t,e){let s='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n';if(e){let n=e.replace(".md","");s+=`
Created from [[${n}]]
`}return Q(t,s)}onunload(){console.log("Unloading Minimal Tasks plugin"),delete window.MinimalTasks}};
