/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var wt=Object.defineProperty;var Jt=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var zt=Object.prototype.hasOwnProperty;var Xt=(x,v)=>{for(var t in v)wt(x,t,{get:v[t],enumerable:!0})},Zt=(x,v,t,e)=>{if(v&&typeof v=="object"||typeof v=="function")for(let s of Kt(v))!zt.call(x,s)&&s!==t&&wt(x,s,{get:()=>v[s],enumerable:!(e=Jt(v,s))||e.enumerable});return x};var te=x=>Zt(wt({},"__esModule",{value:!0}),x);var ae={};Xt(ae,{default:()=>pt});module.exports=te(ae);var p=require("obsidian"),N=require("@codemirror/view"),ee={projectField:"projects",dueField:"due",scheduledField:"scheduled",contextsField:"contexts",discussWithField:"discuss-with",discussDuringField:"discuss-during",storeField:"store",areaField:"area",titleField:"title",statusField:"status",priorityField:"priority",rruleField:"rrule",showProjects:!0,showProjectDueDates:!0,showNoteIcon:!0,showContextPills:!1,noteContentIgnorePattern:'^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*',enableConvertIcon:!0,statuses:["none","open","in-progress","done","dropped"],priorities:["anytime","today","someday"]},kt=class extends N.WidgetType{constructor(t,e,s,n){super();this.plugin=t;this.taskText=e;this.lineFrom=s;this.lineTo=n}toDOM(t){let e=document.createElement("span");return e.className="minimal-tasks-convert-icon",e.textContent="\u2795",e.title="Convert to action",e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.plugin.convertToAction(this.taskText,this.lineFrom,this.lineTo,t)}),e}eq(t){return this.taskText===t.taskText&&this.lineFrom===t.lineFrom}},bt=class extends N.WidgetType{constructor(t,e,s){super();this.plugin=t;this.actionPath=e;this.displayTitle=s}toDOM(){var r;let t=this.plugin.app.vault.getAbstractFileByPath(this.actionPath+".md"),e=t?this.plugin.app.metadataCache.getFileCache(t):null,s=(e==null?void 0:e.frontmatter)||{},n=(r=e==null?void 0:e.sections)==null?void 0:r.some(i=>i.type==="paragraph"||i.type==="list"||i.type==="heading");return this.plugin.createInlineTaskElement(s,this.actionPath+".md",this.displayTitle,n||!1)}eq(t){return this.actionPath===t.actionPath}};function se(x){return N.ViewPlugin.fromClass(class{constructor(v){this.decorations=this.buildDecorations(v)}update(v){(v.docChanged||v.viewportChanged)&&(this.decorations=this.buildDecorations(v.view))}buildDecorations(v){let t=[],e=/^(\s*)- \[[ x]\] \[\[(gtd\/actions\/)?(\d{8}-\d{6})\|([^\]]+)\]\]\s*$/;for(let{from:s,to:n}of v.visibleRanges)for(let r=s;r<=n;){let i=v.state.doc.lineAt(r),c=i.text.match(e);if(c){let l=c[1],o=`gtd/actions/${c[3]}`,u=c[4],g=N.Decoration.replace({widget:new bt(x,o,u)}),f=i.from+l.length;t.push(g.range(f,i.to))}r=i.to+1}return N.Decoration.set(t,!0)}},{decorations:v=>v.decorations})}function ne(x){return N.ViewPlugin.fromClass(class{constructor(v){this.decorations=this.buildDecorations(v)}update(v){(v.docChanged||v.viewportChanged)&&(this.decorations=this.buildDecorations(v.view))}buildDecorations(v){let t=[],e=/^(\s*)- \[ \] (.+)$/,s=/\[\[(gtd\/actions\/)?\d{8}-\d{6}\|/;for(let{from:n,to:r}of v.visibleRanges)for(let i=n;i<=r;){let c=v.state.doc.lineAt(i),l=c.text.match(e);if(l&&l[2]&&!s.test(c.text)){let o=N.Decoration.widget({widget:new kt(x,l[2],c.from,c.to),side:1});t.push(o.range(c.to))}i=c.to+1}return N.Decoration.set(t,!0)}},{decorations:v=>v.decorations})}var at=class extends p.Modal{constructor(t,e,s,n,r){super(t);this.frontmatter={};this.body="";this.isCreateMode=!1;this.didSave=!1;this.plugin=e,this.taskPath=s,n&&(this.isCreateMode=!0,this.frontmatter=n,this.body='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n',r&&(this.body+=`
`+r))}async onOpen(){let{contentEl:t}=this;if(t.addClass("edit-task-modal"),this.isCreateMode){this.buildForm();return}let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof p.TFile)){t.createEl("p",{text:"Error: Task file not found"});return}let s=await this.app.vault.read(e),n=this.plugin.parseFrontmatter(s);this.frontmatter=n.frontmatter,this.body=n.body,this.buildForm()}buildForm(){let{contentEl:t}=this;t.empty();let e,s,n,i=t.createDiv({cls:"edit-task-title-container"}).createEl("input",{cls:"edit-task-title-input",attr:{type:"text",placeholder:"Task title...",value:String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")}});i.addEventListener("change",()=>{this.frontmatter.title=i.value}),setTimeout(()=>i.focus(),0);let c=t.createDiv({cls:"edit-task-section"});c.createDiv({cls:"edit-task-section-label",text:"Contexts"});let l=c.createDiv({cls:"edit-task-contexts"}),o=["focus","quick","relax","home","office","brf","school","errands","agenda","waiting"],u=this.getArrayField("contexts"),g=()=>{var d,D;let a=this.getActiveContexts(l);if(e){let F=((d=this.frontmatter["discuss-with"])==null?void 0:d.length)>0||((D=this.frontmatter["discuss-during"])==null?void 0:D.length)>0;e.style.display=a.includes("agenda")||F?"":"none"}if(s){let F=this.frontmatter.store&&String(this.frontmatter.store).replace(/^["']|["']$/g,"").trim()!=="";s.style.display=a.includes("errands")||F?"":"none"}};o.forEach(a=>{let d=l.createSpan({cls:"context-pill"+(u.includes(a)?" active":""),text:"@"+a});d.addEventListener("click",()=>{d.toggleClass("active",!d.hasClass("active")),this.updateContexts(l),g()})});let w=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),b=w.createDiv({cls:"edit-task-inline-group"});b.createSpan({cls:"edit-task-label",text:"\u{1F4C2} Project"});let k=b.createEl("select",{cls:"edit-task-select-project"});k.createEl("option",{value:"",text:"(none)"});let T={Personal:"\u{1F468}\u200D\u{1F4BB}",Family:"\u{1F9D1}\u200D\u{1F3A8}",Social:"\u{1F57A}",Home:"\u{1F3E0}",Opper:"\u{1F3E2}",Solv\u00E4ndan:"\u2600\uFE0F",Garage:"\u{1F697}"},C=["Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage",""],$=this.app.vault.getMarkdownFiles().filter(a=>a.path.startsWith("gtd/projects/")&&!a.path.includes("archive")).map(a=>{var O;let d=this.app.metadataCache.getFileCache(a),D=(O=d==null?void 0:d.frontmatter)==null?void 0:O.area,F="";if(D&&typeof D=="string"&&(D=D.replace(/^["']|["']$/g,""),D.includes("|"))){let X=D.split("|");X.length>=2&&(F=X[1].replace(/\]\]$/,"").trim())}return{file:a,area:F}}).sort((a,d)=>a.file.basename.localeCompare(d.file.basename)),S=new Map;$.forEach(a=>{let d=a.area||"";S.has(d)||S.set(d,[]),S.get(d).push(a)});let M=this.getProjectBasename();C.forEach(a=>{let d=S.get(a);if(!d||d.length===0)return;let D=T[a]||"\u{1F4E6}",F=a?`${D} ${a}`:"\u{1F4E6} No Area",O=k.createEl("optgroup",{attr:{label:F}});d.forEach(X=>{let Qt=O.createEl("option",{value:X.file.path,text:X.file.basename});X.file.basename===M&&(Qt.selected=!0)})});let W=w.createDiv({cls:"edit-task-inline-group"});W.createSpan({cls:"edit-task-label",text:"\u{1F5C2}\uFE0F Area"});let j=W.createEl("select",{cls:"edit-task-select-small"}),Z=["","Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage"],it=this.getAreaName();Z.forEach(a=>{let d=a?T[a]||"\u{1F4E6}":"",D=a?`${d} ${a}`:"(none)",F=j.createEl("option",{value:a,text:D});a===it&&(F.selected=!0)}),j.addEventListener("change",()=>{j.value?this.frontmatter.area=`"[[gtd/areas/${j.value}|${j.value}]]"`:this.frontmatter.area='""'}),k.addEventListener("change",()=>{if(k.value){let a=$.find(d=>d.file.path===k.value);a&&(this.frontmatter.projects=[`"[[${a.file.path}|${a.file.basename}]]"`],j.value="",this.frontmatter.area='""')}else this.frontmatter.projects=[]}),e=t.createDiv({cls:"edit-task-section"});let q=e.createDiv({cls:"edit-task-row-inline"}),tt=q.createDiv({cls:"edit-task-inline-group"});tt.createSpan({cls:"edit-task-label",text:"\u{1F464} With"});let y=tt.createEl("select",{cls:"edit-task-select-small"});y.createEl("option",{value:"",text:"(none)"});let A=this.app.vault.getMarkdownFiles().filter(a=>a.path.startsWith("notes/person/")).sort((a,d)=>a.basename.localeCompare(d.basename)),h=this.getDiscussWithBasename();A.forEach(a=>{let d=y.createEl("option",{value:a.path,text:a.basename});a.basename===h&&(d.selected=!0)}),y.addEventListener("change",()=>{if(y.value){let a=A.find(d=>d.path===y.value);a&&(this.frontmatter["discuss-with"]=[`"[[${a.path}|${a.basename}]]"`])}else delete this.frontmatter["discuss-with"]});let m=q.createDiv({cls:"edit-task-inline-group"});m.createSpan({cls:"edit-task-label",text:"\u{1F4C5} During"});let E=m.createEl("select",{cls:"edit-task-select-small"});E.createEl("option",{value:"",text:"(none)"});let P=this.app.vault.getMarkdownFiles().filter(a=>a.path.startsWith("events/")).sort((a,d)=>d.basename.localeCompare(a.basename)).slice(0,50),B=this.getDiscussDuringBasename();P.forEach(a=>{let d=a.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,""),D=E.createEl("option",{value:a.path,text:d});(a.basename===B||d===B)&&(D.selected=!0)}),E.addEventListener("change",()=>{if(E.value){let a=P.find(d=>d.path===E.value);if(a){let d=a.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${a.path}|${d}]]"`]}}else delete this.frontmatter["discuss-during"]}),s=t.createDiv({cls:"edit-task-section"});let et=s.createDiv({cls:"edit-task-row-inline"}),st=et.createDiv({cls:"edit-task-inline-group"});st.createSpan({cls:"edit-task-label",text:"\u{1F3EA} Store"});let V=st.createEl("input",{cls:"edit-task-input-small",attr:{type:"text",placeholder:"Type or select...",list:"store-suggestions",value:String(this.frontmatter.store||"").replace(/^["']|["']$/g,"")}}),Wt=et.createEl("datalist",{attr:{id:"store-suggestions"}}),St=new Set;this.app.vault.getMarkdownFiles().filter(a=>a.path.startsWith("gtd/actions/")).forEach(a=>{var F;let d=this.app.metadataCache.getFileCache(a),D=(F=d==null?void 0:d.frontmatter)==null?void 0:F.store;if(D){let O=String(D).replace(/^["']|["']$/g,"");O&&St.add(O)}}),Array.from(St).sort().forEach(a=>{Wt.createEl("option",{value:a})}),V.addEventListener("change",()=>{V.value?this.frontmatter.store=V.value:delete this.frontmatter.store}),g();let Tt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),Et=Tt.createDiv({cls:"edit-task-inline-group"});Et.createSpan({cls:"edit-task-label",text:"\u{1F5D3}\uFE0F Scheduled"}),n=Et.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:this.formatDateForInput(this.frontmatter.scheduled)}}),n.addEventListener("change",()=>{this.frontmatter.scheduled=n.value||void 0,n.value||delete this.frontmatter.scheduled});let Ft=Tt.createDiv({cls:"edit-task-inline-group"});Ft.createSpan({cls:"edit-task-label",text:"\u{1F4C5} Due"});let rt=Ft.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:this.formatDateForInput(this.frontmatter.due)}});rt.addEventListener("change",()=>{this.frontmatter.due=rt.value||void 0,rt.value||delete this.frontmatter.due});let Pt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),L=Pt.createDiv({cls:"edit-task-inline-group"});L.createSpan({cls:"edit-task-label",text:"\u{1F501} Every"});let gt=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],ot=["MO","TU","WE","TH","FR","SA","SU"],U=L.createEl("input",{cls:"edit-task-input-small",attr:{type:"number",min:"1",max:"99",value:"1"}});U.style.width="45px",U.style.display="none";let H=L.createEl("select",{cls:"edit-task-select-small"});H.createEl("option",{value:"",text:"(none)"}),H.createEl("option",{value:"day",text:"day"}),H.createEl("option",{value:"week",text:"week"}),H.createEl("option",{value:"month",text:"month"}),H.createEl("option",{value:"year",text:"year"});let xt=L.createSpan({cls:"edit-task-label",text:"on"});xt.style.display="none";let G=L.createEl("select",{cls:"edit-task-select-small"});gt.forEach((a,d)=>{G.createEl("option",{value:ot[d],text:a})}),G.style.display="none";let R=L.createEl("select",{cls:"edit-task-select-small"});R.createEl("option",{value:"day",text:"day"}),gt.forEach((a,d)=>{R.createEl("option",{value:ot[d],text:a})}),R.style.display="none";let Q=L.createEl("select",{cls:"edit-task-select-small"}),$t=[{label:"1st",value:"1"},{label:"2nd",value:"2"},{label:"3rd",value:"3"},{label:"4th",value:"4"},{label:"last",value:"-1"}];$t.forEach(a=>{Q.createEl("option",{value:a.value,text:a.label})}),Q.style.display="none";let J=L.createEl("select",{cls:"edit-task-select-small"});for(let a=1;a<=31;a++){let d=a===1||a===21||a===31?"st":a===2||a===22?"nd":a===3||a===23?"rd":"th";J.createEl("option",{value:String(a),text:`${a}${d}`})}J.style.display="none";let _=L.createEl("select",{cls:"edit-task-select-small"});["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((a,d)=>{_.createEl("option",{value:String(d+1),text:a})}),_.style.display="none";let Y=L.createEl("select",{cls:"edit-task-select-small"});Y.createEl("option",{value:"day",text:"day"}),gt.forEach((a,d)=>{Y.createEl("option",{value:ot[d],text:a})}),Y.style.display="none";let K=L.createEl("select",{cls:"edit-task-select-small"});$t.forEach(a=>{K.createEl("option",{value:a.value,text:a.label})}),K.style.display="none";let z=L.createEl("select",{cls:"edit-task-select-small"});for(let a=1;a<=31;a++)z.createEl("option",{value:String(a),text:String(a)});z.style.display="none";let ct=Pt.createDiv({cls:"edit-task-inline-group"});ct.createSpan({cls:"edit-task-label",text:"from"});let lt=ct.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date"}});ct.style.display="none";let Mt=String(this.frontmatter.rrule||"").replace(/^["']|["']$/g,""),nt="",At=1,Ct=ot[(new Date().getDay()+6)%7],dt=new Date().getDate(),jt=new Date().getMonth()+1,ht="day",mt="day",Lt="1",It="1",Nt=this.frontmatter.recurrence_start?String(this.frontmatter.recurrence_start).replace(/^["']|["']$/g,""):n.value||new Date().toISOString().split("T")[0];if(Mt){let a=this.plugin.parseRRule(Mt);if(a.DTSTART){let d=a.DTSTART;d.length===8&&(Nt=`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`)}At=parseInt(a.INTERVAL||"1"),a.FREQ==="DAILY"?nt="day":a.FREQ==="WEEKLY"?(nt="week",a.BYDAY&&(Ct=a.BYDAY)):a.FREQ==="MONTHLY"?(nt="month",a.BYSETPOS&&a.BYDAY?(ht=a.BYDAY,Lt=a.BYSETPOS):a.BYMONTHDAY&&(ht="day",dt=parseInt(a.BYMONTHDAY))):a.FREQ==="YEARLY"&&(nt="year",a.BYMONTH&&(jt=parseInt(a.BYMONTH)),a.BYSETPOS&&a.BYDAY?(mt=a.BYDAY,It=a.BYSETPOS):a.BYMONTHDAY&&(mt="day",dt=parseInt(a.BYMONTHDAY)))}H.value=nt,U.value=String(At),G.value=Ct,J.value=String(dt),_.value=String(jt),z.value=String(dt),R.value=ht,Y.value=mt,Q.value=Lt,K.value=It,lt.value=Nt;let ut=()=>{let a=H.value,d=R.value,D=Y.value,F=a==="month"&&d!=="day",O=a==="year"&&D!=="day";U.style.display=a?"":"none",xt.style.display=a==="week"||a==="month"||a==="year"?"":"none",G.style.display=a==="week"?"":"none",R.style.display=a==="month"?"":"none",Q.style.display=F?"":"none",J.style.display=a==="month"&&!F?"":"none",_.style.display=a==="year"?"":"none",Y.style.display=a==="year"?"":"none",K.style.display=O?"":"none",z.style.display=a==="year"&&!O?"":"none",ct.style.display=a?"":"none"};ut(),R.addEventListener("change",ut),Y.addEventListener("change",ut);let Vt=()=>{let a=lt.value||n.value||new Date().toISOString().split("T")[0],d=this.plugin.formatDTSTART(a),D=H.value,F=parseInt(U.value)||1;switch(D){case"day":return`DTSTART:${d};FREQ=DAILY;INTERVAL=${F}`;case"week":return`DTSTART:${d};FREQ=WEEKLY;INTERVAL=${F};BYDAY=${G.value}`;case"month":return R.value!=="day"?`DTSTART:${d};FREQ=MONTHLY;INTERVAL=${F};BYDAY=${R.value};BYSETPOS=${Q.value}`:`DTSTART:${d};FREQ=MONTHLY;INTERVAL=${F};BYMONTHDAY=${J.value}`;case"year":return Y.value!=="day"?`DTSTART:${d};FREQ=YEARLY;INTERVAL=${F};BYMONTH=${_.value};BYDAY=${Y.value};BYSETPOS=${K.value}`:`DTSTART:${d};FREQ=YEARLY;INTERVAL=${F};BYMONTH=${_.value};BYMONTHDAY=${z.value}`;default:return""}},I=()=>{let a=Vt();if(a){let d=lt.value||n.value||new Date().toISOString().split("T")[0];this.frontmatter.rrule=a,this.frontmatter.recurrence_start=d}else delete this.frontmatter.rrule,delete this.frontmatter.recurrence_start};H.addEventListener("change",()=>{ut(),I()}),U.addEventListener("change",I),G.addEventListener("change",I),J.addEventListener("change",I),R.addEventListener("change",I),Q.addEventListener("change",I),_.addEventListener("change",I),Y.addEventListener("change",I),K.addEventListener("change",I),z.addEventListener("change",I),lt.addEventListener("change",I);let Rt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),Yt=Rt.createDiv({cls:"edit-task-inline-group"});Yt.createSpan({cls:"edit-task-label",text:"Status"});let yt=Yt.createDiv({cls:"edit-task-icon-group"}),_t=[{value:"none",icon:"\u26AA"},{value:"open",icon:"\u{1F535}"},{value:"in-progress",icon:"\u{1F7E1}"},{value:"done",icon:"\u2705"},{value:"dropped",icon:"\u{1F534}"}],qt=this.frontmatter.status||"none";_t.forEach(a=>{let d=yt.createSpan({cls:"edit-task-icon"+(qt===a.value?" active":""),text:a.icon,attr:{title:a.value}});d.addEventListener("click",()=>{yt.querySelectorAll(".edit-task-icon").forEach(D=>D.removeClass("active")),d.addClass("active"),this.frontmatter.status=a.value})});let Ot=Rt.createDiv({cls:"edit-task-inline-group"});Ot.createSpan({cls:"edit-task-label",text:"Priority"});let ft=Ot.createDiv({cls:"edit-task-icon-group"}),Ut=[{value:"anytime",icon:"\u2022"},{value:"today",icon:"\u2B50"},{value:"someday",icon:"\u{1F4AD}"}],Gt=this.frontmatter.priority||"anytime";Ut.forEach(a=>{let d=ft.createSpan({cls:"edit-task-icon"+(Gt===a.value?" active":""),text:a.icon,attr:{title:a.value}});d.addEventListener("click",()=>{ft.querySelectorAll(".edit-task-icon").forEach(D=>D.removeClass("active")),d.addClass("active"),this.frontmatter.priority=a.value})});let vt=t.createDiv({cls:"edit-task-button-row"}),Ht=vt.createEl("button",{cls:"edit-task-delete",text:"\u{1F5D1}\uFE0F"});Ht.setAttribute("title","Delete task"),Ht.addEventListener("click",()=>this.deleteTask());let Bt=vt.createEl("button",{cls:"edit-task-ai",text:"\u2728"});Bt.setAttribute("title","AI suggest fields"),Bt.addEventListener("click",()=>this.suggestFieldsWithAI(i,yt,ft,rt,n,l,k,j,y,E,V,g)),vt.createEl("button",{cls:"edit-task-save",text:"Save Changes"}).addEventListener("click",()=>this.saveChanges()),this.scope.register(["Mod"],"Enter",a=>(a.preventDefault(),this.saveChanges(),!1))}async deleteTask(){if(this.isCreateMode){this.close();return}let t=this.app.vault.getAbstractFileByPath(this.taskPath);if(!t||!(t instanceof p.TFile)){new p.Notice("Error: Task file not found");return}let e=String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")||t.basename;confirm(`Delete "${e}"?`)&&(await this.app.vault.delete(t),this.didSave=!0,new p.Notice("Task deleted"),this.close())}async suggestFieldsWithAI(t,e,s,n,r,i,c,l,o,u,g,f){try{let w=this.app.plugins.plugins["opper-ai"];if(!w){new p.Notice("Opper AI plugin not found. Please install and enable it.");return}if(!w.api){new p.Notice("Opper AI plugin API not initialized. Please reload Obsidian.");return}new p.Notice("\u2728 Analyzing task...",2e3);let k=new Date().toISOString().split("T")[0],T=this.app.vault.getMarkdownFiles().filter(h=>h.path.startsWith("gtd/projects/")&&!h.path.includes("archive")),C=T.map(h=>{var et,st;let m=this.app.metadataCache.getFileCache(h),E=(et=m==null?void 0:m.frontmatter)==null?void 0:et.state,P=(st=m==null?void 0:m.frontmatter)==null?void 0:st.area,B="No Area";if(P&&typeof P=="string"&&(P=P.replace(/^["']|["']$/g,""),P.includes("|"))){let V=P.split("|");V.length>=2&&(B=V[1].replace(/\]\]$/,"").trim())}return{name:h.basename,area:B,state:E}}).filter(h=>h.state==="active"),$=this.app.vault.getMarkdownFiles().filter(h=>h.path.startsWith("notes/person/")),S=$.map(h=>h.basename),M=this.app.vault.getMarkdownFiles().filter(h=>h.path.startsWith("events/")),W=M.filter(h=>{var P;let m=this.app.metadataCache.getFileCache(h),E=(P=m==null?void 0:m.frontmatter)==null?void 0:P.date;return E?E>=k:!0}).map(h=>h.basename),j=new Set;this.app.vault.getMarkdownFiles().filter(h=>h.path.startsWith("gtd/actions/")).forEach(h=>{var P;let m=this.app.metadataCache.getFileCache(h),E=(P=m==null?void 0:m.frontmatter)==null?void 0:P.store;if(E){let B=String(E).replace(/^["']|["']$/g,"");B&&j.add(B)}});let Z=Array.from(j),it=t.value||"",q=this.body||"",tt=await w.api.call("detect-action-fields",{task_title:it,task_body:q,current_date:k,available_contexts:["focus","quick","relax","home","office","brf","school","errands","agenda","waiting"],available_projects:C,available_areas:["Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage"],available_people:S,available_meetings:W,available_stores:Z},{instructions:this.getAIInstructions(),outputSchema:this.getAIOutputSchema(),model:"gcp/gemini-flash-latest"});if(!tt.json_payload){new p.Notice("No suggestions from AI");return}let y=tt.json_payload,A=[];if(y.title&&y.title.trim()&&(t.value=y.title,this.frontmatter.title=y.title,A.push("title")),y.priority){s.querySelectorAll(".edit-task-icon").forEach(m=>m.removeClass("active"));let h=s.querySelector(`[title="${y.priority}"]`);h&&(h.addClass("active"),this.frontmatter.priority=y.priority,A.push("priority"))}if(y.context){let h=i.querySelector(".context-pill:not(.active)");i.querySelectorAll(".context-pill").forEach(m=>{var P;(((P=m.textContent)==null?void 0:P.replace("@",""))||"")===y.context&&!m.hasClass("active")&&(m.addClass("active"),A.push("context"))}),this.updateContexts(i),f()}if(y.projects&&y.projects.length>0){let h=y.projects[0],m=T.find(E=>E.basename===h);m&&(c.value=m.path,this.frontmatter.projects=[`"[[${m.path}|${m.basename}]]"`],A.push("project"))}if(y.area&&(!y.projects||y.projects.length===0)&&Array.from(l.options).find(m=>m.value===y.area)&&(l.value=y.area,this.frontmatter.area=`"[[gtd/areas/${y.area}|${y.area}]]"`,A.push("area")),y.discuss_with&&y.discuss_with.length>0){let h=y.discuss_with[0],m=$.find(E=>E.basename===h);m&&(o.value=m.path,this.frontmatter["discuss-with"]=[`"[[${m.path}|${m.basename}]]"`],A.push("discuss-with"))}if(y.discuss_during&&y.discuss_during.length>0){let h=y.discuss_during[0],m=M.find(E=>E.basename===h||E.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")===h);if(m){u.value=m.path;let E=m.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${m.path}|${E}]]"`],A.push("discuss-during")}}if(y.store&&(g.value=y.store,this.frontmatter.store=y.store,A.push("store")),y.due){let h=this.parseNaturalDate(y.due,k);h&&(n.value=h,this.frontmatter.due=h,A.push("due"))}if(y.scheduled){let h=this.parseNaturalDate(y.scheduled,k);h&&(r.value=h,this.frontmatter.scheduled=h,A.push("scheduled"))}f(),A.length>0?new p.Notice(`\u2728 Applied: ${A.join(", ")}`):new p.Notice("No fields detected")}catch(w){console.error("AI suggestion failed:",w),new p.Notice("AI suggestion failed: "+w.message)}}parseNaturalDate(t,e){if(!t)return null;let s=t.toLowerCase().trim(),n=new Date(e);if(s==="today")return e;if(s==="tomorrow"){let i=new Date(n);return i.setDate(i.getDate()+1),i.toISOString().split("T")[0]}if(s.startsWith("next ")){let i=s.replace("next ",""),l=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(i);if(l>=0){let o=new Date(n),u=o.getDay(),g=l-u;return g<=0&&(g+=7),o.setDate(o.getDate()+g),o.toISOString().split("T")[0]}}let r=s.match(/\d{4}-\d{2}-\d{2}/);return r?r[0]:null}getAIInstructions(){return`Analyze the task title and body to detect relevant GTD fields.

**Context Detection Rules:**
Suggest ONE primary context:
- "focus": Deep work (write, design, review)
- "quick": Tasks under 5 minutes (send email, reply, check)
- "relax": Low-energy tasks (read, watch, browse)
- "home"/"office"/"brf"/"school": Location-specific
- "errands": Shopping or pickup (buy, pick up, get)
- "agenda": Discussion topics (when people/meetings mentioned)
- "waiting": Waiting on something/someone

**Priority Detection:**
- "today": Urgent cues (urgent, ASAP, today, now)
- "someday": Later cues (maybe, someday, consider)
- "anytime": Default

**Date Detection:**
Return dates as natural language (e.g., "next friday", "tomorrow").

**Project/Area:**
- If project matches \u2192 return project, leave area empty
- If no project \u2192 suggest area based on keywords

**People/Meeting Detection:**
Match to available lists when discussion is mentioned.

**Store Detection:**
For errands, extract store names.

**Title Generation:**
If title can be improved (more concise, action-oriented), suggest improvement.`}getAIOutputSchema(){return{type:"object",properties:{context:{type:"string",description:"Single primary context or empty"},projects:{type:"array",items:{type:"string"},description:"Detected project names"},area:{type:"string",description:"Suggested area if no projects"},priority:{type:"string",enum:["anytime","today","someday"]},scheduled:{type:"string",description:"Natural language scheduled date"},due:{type:"string",description:"Natural language due date"},discuss_with:{type:"array",items:{type:"string"},description:"People to discuss with"},discuss_during:{type:"array",items:{type:"string"},description:"Meetings"},store:{type:"string",description:"Store name for errands"},title:{type:"string",description:"Suggested title improvement"},confidence_scores:{type:"object",properties:{context:{type:"number"},projects:{type:"number"},area:{type:"number"},priority:{type:"number"},scheduled:{type:"number"},due:{type:"number"},discuss_with:{type:"number"},discuss_during:{type:"number"},store:{type:"number"},title:{type:"number"}}}},required:["context","projects","area","priority","scheduled","due","discuss_with","discuss_during","store","title","confidence_scores"]}}formatDateForInput(t){if(!t)return"";let e=String(t).replace(/^["']|["']$/g,"");return e.length>=10?e.substring(0,10):""}getArrayField(t){let e=this.frontmatter[t];return Array.isArray(e)?e.map(s=>String(s).replace(/^["']|["']$/g,"")):[]}getProjectBasename(){var e;let t=this.frontmatter.projects;if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getAreaName(){let t=this.frontmatter.area;if(!t)return"";let s=String(t).replace(/^["']|["']$/g,"").match(/\|([^\]]+)\]\]/);return s?s[1]:""}getDiscussWithBasename(){var e;let t=this.frontmatter["discuss-with"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getDiscussDuringBasename(){var e;let t=this.frontmatter["discuss-during"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}updateContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];e.forEach(n=>{var i;let r=((i=n.textContent)==null?void 0:i.replace("@",""))||"";r&&s.push(r)}),this.frontmatter.contexts=s}getActiveContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];return e.forEach(n=>{var i;let r=((i=n.textContent)==null?void 0:i.replace("@",""))||"";r&&s.push(r)}),s}async saveChanges(){this.frontmatter.dateModified=new Date().toISOString();let t=this.plugin.rebuildContent(this.frontmatter,this.body);if(this.isCreateMode)await this.app.vault.create(this.taskPath,t),new p.Notice("Action created");else{let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof p.TFile)){new p.Notice("Error: Task file not found");return}await this.app.vault.modify(e,t),new p.Notice("Task updated")}this.didSave=!0,this.close()}onClose(){let{contentEl:t}=this;t.empty(),this.didSave&&this.plugin.refreshDataview()}},pt=class extends p.Plugin{async onload(){console.log("Loading Minimal Tasks plugin"),await this.loadSettings(),window.MinimalTasks={renderTask:this.renderTask.bind(this),renderTaskList:this.renderTaskList.bind(this),settings:this.settings},this.registerDomEvent(document,"click",this.handleClick.bind(this)),this.registerDomEvent(document,"contextmenu",this.handleContextMenu.bind(this)),this.addSettingTab(new Dt(this.app,this)),this.settings.enableConvertIcon&&this.registerEditorExtension(ne(this)),this.registerEditorExtension(se(this)),this.registerMarkdownPostProcessor((t,e)=>{this.processActionLinks(t,e)}),this.addRibbonIcon("plus-circle","New Action",async()=>{await this.createNewAction()}),this.addCommand({id:"new-action",name:"Create new action",callback:async()=>{await this.createNewAction()}}),this.addCommand({id:"new-action-from-context",name:"Create new action from current note",callback:async()=>{await this.createNewActionFromContext()}}),this.addCommand({id:"edit-action",name:"Edit current action",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return e&&e.path.startsWith("gtd/actions/")?(t||new at(this.app,this,e.path).open(),!0):!1}})}async createNewAction(t){try{let n=`gtd/actions/${`${this.generateTimestamp()}.md`}`,r=new Date().toISOString(),i={type:"action",title:"",status:"open",priority:"anytime",dateCreated:r,dateModified:r,tags:[],contexts:t!=null&&t.context?[t.context]:[],projects:t!=null&&t.project?[`"[[${t.project}]]"`]:[],area:t!=null&&t.area?`"[[gtd/areas/${t.area}|${t.area}]]"`:'""'};new at(this.app,this,n,i,t==null?void 0:t.body).open()}catch(e){console.error("Error creating action:",e),new p.Notice("Error creating action: "+e.message)}}async createNewActionFromContext(){var r,i,c;let t=this.app.workspace.getActiveFile();if(!t){await this.createNewAction();return}let e=this.app.metadataCache.getFileCache(t),s=(r=e==null?void 0:e.frontmatter)==null?void 0:r.type,n={};if(s==="project")n.project=t.path;else if(s==="event"||s==="meeting"){let l=(i=e==null?void 0:e.frontmatter)==null?void 0:i.project;if(l){let o=String(l).match(/\[\[([^\]|]+)/);if(o){let u=(c=o[1].split("/").pop())==null?void 0:c.replace(/\.md$/,""),g=this.app.vault.getMarkdownFiles().find(f=>f.basename===u&&f.path.startsWith("gtd/projects/"));g&&(n.project=g.path)}}}else t.path.startsWith("gtd/areas/")&&(n.area=t.basename);if(s==="checklist-template"||s==="checklist"){let l=await this.app.vault.read(t),u=this.parseFrontmatter(l).body.replace(/```dataviewjs\s*\n[\s\S]*?\n```\s*/g,"").replace(/---\s*$/g,"").trim();if(u){let g=`From: [[${t.path.replace(/\.md$/,"")}]]`;n.body=`${g}

${u}`}}await this.createNewAction(n)}async loadSettings(){this.settings=Object.assign({},ee,await this.loadData())}async saveSettings(){await this.saveData(this.settings),window.MinimalTasks&&(window.MinimalTasks.settings=this.settings)}async renderTaskList(t,e,s={}){let n=Array.isArray(e)?e:e.array(),r=await Promise.all(n.map(async l=>({task:l,hasNotes:await this.hasNoteContent(l.file),enrichedTask:await this.enrichTaskData(t,l)})));return this.sortTasks(r).map(l=>this.renderTask(l.enrichedTask,{...s,hasNotes:l.hasNotes})).join("<br>")}async enrichTaskData(t,e){let n=e[this.settings.titleField]||e.file.name.replace(/\.md$/,""),r=`<a data-href="${e.file.path}" href="${e.file.path}" class="internal-link" target="_blank" rel="noopener">${n}</a>`,i,c=e[this.settings.projectField];return c&&c.length>0&&(i=c.map(l=>{var k;let o=typeof l=="string"?l:String(l),u=o.match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(!u)return{link:o};let g=u[1],f=u[2]||((k=g.split("/").pop())==null?void 0:k.replace(/\.md$/,""))||g,w=`<a data-href="${g}" href="${g}" class="internal-link" target="_blank" rel="noopener">${f}</a>`,b=t.page(g);if(!b)return{link:w};if(b[this.settings.dueField]){let T=t.date(b[this.settings.dueField]),C=t.date("today"),$=T.toFormat("MMM dd");return{link:w,due:b[this.settings.dueField],dueFormatted:$,overdue:T<C}}return{link:w}})),{status:e[this.settings.statusField],priority:e[this.settings.priorityField],link:r,file:{path:e.file.path},contexts:e[this.settings.contextsField],"discuss-with":e[this.settings.discussWithField],"discuss-during":e[this.settings.discussDuringField],store:e[this.settings.storeField],due:e[this.settings.dueField],scheduled:e[this.settings.scheduledField],rrule:e[this.settings.rruleField],projects:c,projectsWithMeta:i}}async hasNoteContent(t){var e;try{let s=t.path||((e=t.file)==null?void 0:e.path);if(!s)return!1;let n=this.app.vault.getAbstractFileByPath(s);if(!n||!(n instanceof p.TFile))return!1;let r=await this.app.vault.read(n),i=/^---\n[\s\S]*?\n---\n/,c=r.replace(i,"").trim();if(this.settings.noteContentIgnorePattern)try{let l=new RegExp(this.settings.noteContentIgnorePattern);c=c.replace(l,"").trim()}catch(l){console.error("Invalid noteContentIgnorePattern regex:",l)}return c.length>0}catch(s){return!1}}getEffectiveDueDate(t){var r;let e=t.task[this.settings.dueField],s=((r=t.enrichedTask.projectsWithMeta)==null?void 0:r.map(i=>i.due).filter(Boolean))||[],n=[e,...s].filter(Boolean);return n.length===0?null:n.sort()[0]}sortTasks(t){return t.sort((e,s)=>{let n=this.settings.statusField,r=this.settings.priorityField,i=e.task[n]==="in-progress",c=s.task[n]==="in-progress";if(i&&!c)return-1;if(!i&&c)return 1;let l=e.task[r]==="today",o=s.task[r]==="today";if(l&&!o)return-1;if(!l&&o)return 1;let u=this.getEffectiveDueDate(e),g=this.getEffectiveDueDate(s);if(u&&!g)return-1;if(!u&&g)return 1;if(u&&g){if(u<g)return-1;if(u>g)return 1}return e.task.file.ctime-s.task.file.ctime})}renderTask(t,e={}){let{hasNotes:s=!1,showProjects:n=!0,showContexts:r=!1,excludePills:i=[]}=e,c;if(t.file&&t.file.path)c=t.file.path;else if(t.path)c=t.path;else return console.error("MinimalTasks: No path found in task object",t),"Error: No task path";let l=t[this.settings.statusField]||"none",o=t[this.settings.priorityField]||"anytime",u=l==="done"||l==="dropped",g=this.createControls(o,l,c),f=this.createContent(t,s,u,r,i,c),w=this.createMainLine(g,f),b=this.createProjectsSection(t,n);return`<div class="minimal-task-row" data-task-path="${c}" data-status="${l}" data-priority="${o}">${w}${b}</div>`}createControls(t,e,s){return`<div class="minimal-task-controls">${this.renderPriorityBadge(t,s)}${this.renderStatusDot(e,s)}</div>`}createContent(t,e,s,n,r,i){let c=this.createTitle(t,s),l=`<span class="minimal-task-edit-icon" data-task-path="${i}" title="Edit task">\u22EF</span>`,o=e&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",u=this.createMetadata(t,n,r);return`<div class="minimal-task-content">${`<span class="minimal-task-title-group">${c}${o}${l}</span>`}${u}</div>`}createTitle(t,e){let s=t.link||"Untitled";return`<span class="minimal-task-title${e?" is-completed":""}">${s}</span>`}createMetadata(t,e,s){let n=[],r=this.renderDateBadges(t);r&&n.push(r);let i=t[this.settings.rruleField];i&&!s.includes("recurrence")&&n.push(this.renderRecurrencePill(i));let c=t[this.settings.contextsField]||[];e&&c.length>0&&!s.includes("contexts")&&n.push(this.renderContextPills(c));let l=t[this.settings.discussWithField];l&&!s.includes("person")&&n.push(this.renderDiscussWithPills(l));let o=t[this.settings.discussDuringField];o&&!s.includes("meeting")&&n.push(this.renderDiscussDuringPills(o));let u=t[this.settings.storeField];return u&&!s.includes("store")&&n.push(this.renderStorePill(u)),n.length===0?"":`<span class="minimal-task-metadata">${n.join("")}</span>`}createMainLine(t,e){return`<div class="minimal-task-main">${t}${e}</div>`}createProjectsSection(t,e){if(!this.settings.showProjects||!e)return"";let s=t[this.settings.projectField]||[];return s.length===0?"":`<div class="minimal-task-projects">${(t.projectsWithMeta||s).map(i=>this.createProjectItem(i)).join("")}</div>`}createProjectItem(t){let e="";if(t.link){let s=t;if(e=s.link,this.settings.showProjectDueDates&&s.due){let n=s.dueFormatted||s.due,r=s.overdue?" is-overdue":"";e+=` <span class="minimal-badge minimal-badge-date${r}">\u{1F4C5} ${n}</span>`}}else e=typeof t=="string"?t:String(t);return`<div class="minimal-task-project">${e}</div>`}renderStatusDot(t,e){return`<span class="task-status-dot" data-status="${t}" data-task-path="${e}" title="Status: ${t} (click to cycle)"></span>`}renderPriorityBadge(t,e){let s=this.getPriorityIcon(t);return`<span class="task-priority-badge" data-priority="${t}" data-task-path="${e}" title="Priority: ${t} (click to cycle)">${s}</span>`}renderContextPills(t){return(Array.isArray(t)?t:[t]).map(e=>`<span class="minimal-badge minimal-badge-context">@${e}</span>`).join("")}renderDiscussWithPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=this.extractDisplayName(e),n=this.extractLinkPath(e);return n?`<span class="minimal-badge minimal-badge-person"><a class="internal-link" data-href="${n}" href="${n}" target="_blank" rel="noopener">\u{1F464}${s}</a></span>`:`<span class="minimal-badge minimal-badge-person">\u{1F464}${s}</span>`}).join("")}extractDisplayName(t){if(!t)return t;let e=String(t),s=e.match(/\[\[(?:[^\]|]+\|)?([^\]]+)\]\]/);return s?s[1]:e}extractLinkPath(t){if(!t)return null;let s=String(t).match(/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/);return s?s[1]:null}stripEventPrefix(t){return t&&t.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")}renderDiscussDuringPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=this.extractDisplayName(e);return`<span class="minimal-badge minimal-badge-meeting">\u{1F4C5}${this.stripEventPrefix(s)}</span>`}).join("")}renderStorePill(t){return`<span class="minimal-badge minimal-badge-store">\u{1F3EA}${t}</span>`}renderRecurrencePill(t){return`<span class="minimal-badge minimal-badge-recurrence">\u{1F501} ${this.formatRRuleReadable(t)}</span>`}renderInlineTaskHTML(t,e,s,n){let r=t[this.settings.statusField]||"open",i=t[this.settings.priorityField]||"anytime",c=t[this.settings.titleField]||s,l=r==="done"||r==="dropped",o=e.replace(".md",""),u=this.renderPriorityBadge(i,e),g=this.renderStatusDot(r,e),w=`<a class="internal-link${l?" is-completed":""}" data-href="${o}" href="${o}">${this.escapeHtml(c)}</a>`,b=n&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",k=`<span class="minimal-task-edit-icon" data-task-path="${e}" title="Edit task">\u22EF</span>`,T=[],C=t[this.settings.scheduledField];C&&T.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${C}</span>`);let $=t[this.settings.dueField];if($){let q=new Date($)<new Date(new Date().toDateString())?" is-overdue":"";T.push(`<span class="minimal-badge minimal-badge-date${q}">\u{1F4C5} ${$}</span>`)}let S=t[this.settings.rruleField];S&&T.push(this.renderRecurrencePill(S));let M=t[this.settings.contextsField]||[];M.length>0&&T.push(this.renderContextPills(M));let W=t[this.settings.projectField]||[];W.length>0&&T.push(this.renderProjectPills(W));let j=T.length>0?` <span class="minimal-task-metadata">${T.join("")}</span>`:"",Z=`<span class="minimal-task-title-group">${w}${b}${k}</span>`;return`${u}${g} ${Z}${j}`}renderProjectPills(t){return(Array.isArray(t)?t:[t]).filter(e=>e).map(e=>{let s=this.extractDisplayName(e),n=this.extractLinkPath(e);return n?`<span class="minimal-badge minimal-badge-project"><a class="internal-link" data-href="${n}" href="${n}">\u{1F4C1} ${this.escapeHtml(s)}</a></span>`:`<span class="minimal-badge minimal-badge-project">\u{1F4C1} ${this.escapeHtml(s)}</span>`}).join("")}escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.textContent||""}createInlineTaskElement(t,e,s,n){let r=this.renderInlineTaskHTML(t,e,s,n);return new DOMParser().parseFromString(`<span class="minimal-task-inline">${r}</span>`,"text/html").body.firstChild}formatRRuleReadable(t){if(!t)return"";try{let e=this.parseRRule(t),s=e.FREQ,n=parseInt(e.INTERVAL||"1"),r=e.BYDAY,i=e.BYMONTHDAY,c=e.BYMONTH,l=e.BYSETPOS,o="";if(n===1)switch(s){case"DAILY":o="Daily";break;case"WEEKLY":o="Weekly";break;case"MONTHLY":o="Monthly";break;case"YEARLY":o="Yearly";break}else if(s==="MONTHLY"&&n===3)o="Quarterly";else if(s==="MONTHLY"&&n===6)o="Biannually";else switch(s){case"DAILY":o=`Every ${n} days`;break;case"WEEKLY":o=`Every ${n} weeks`;break;case"MONTHLY":o=`Every ${n} months`;break;case"YEARLY":o=`Every ${n} years`;break}if(l&&r){let g={SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"}[r]||r,f=parseInt(l),w=f===-1?"last":this.ordinalNumber(f);o+=` on the ${w} ${g}`}else if(r){let u=r.split(",").map(g=>({SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"})[g]||g);o+=" on "+u.join(", ")}return i&&(o+=" on the "+i+this.ordinalSuffix(parseInt(i))),c&&(o+=" in "+["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(c)]),o}catch(e){return console.error("Failed to format RRULE:",e),"Recurring"}}parseRRule(t){let e={};return t.split(";").forEach(n=>{let[r,i]=n.split(":").length===2?n.split(":"):n.split("=");r&&i&&(e[r]=i)}),e}ordinalSuffix(t){let e=t%10,s=t%100;return e===1&&s!==11?"st":e===2&&s!==12?"nd":e===3&&s!==13?"rd":"th"}ordinalNumber(t){return t+this.ordinalSuffix(t)}formatDTSTART(t){let e=new Date(t),s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${s}${n}${r}`}renderDateBadges(t){let e=[],s=t[this.settings.dueField],n=t[this.settings.scheduledField];if(n){let r=new Date(n);r.setHours(0,0,0,0);let i=this.formatDate(r);e.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${i}</span>`)}if(s){let r=new Date(s);r.setHours(0,0,0,0);let i=new Date;i.setHours(0,0,0,0);let c=r<i,l=this.formatDate(r),o=c?"\u26A0\uFE0F":"\u{1F4C5}",u=c?" is-overdue":"";e.push(`<span class="minimal-badge minimal-badge-date${u}">${o} ${l}</span>`)}return e.join("")}formatDate(t){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}`}getPriorityIcon(t){return{today:"\u2B50",someday:"\u{1F4AD}",anytime:"\u2022"}[t]||"\u2022"}async handleClick(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),await this.cycleStatus(e);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),await this.cyclePriority(e);return}if(e.classList.contains("minimal-task-edit-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskPath;s&&new at(this.app,this,s).open();return}if(e.classList.contains("minimal-tasks-convert-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskText,n=e.dataset.sourcePath;s&&n&&await this.convertToActionFromReading(s,n);return}}handleContextMenu(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),this.showStatusMenu(e,t);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),this.showPriorityMenu(e,t);return}}showStatusMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.status;if(!s)return;let r=new p.Menu;[{value:"none",label:"\u26AA None",icon:"\u26AA"},{value:"open",label:"\u{1F535} Open",icon:"\u{1F535}"},{value:"in-progress",label:"\u{1F7E1} In Progress",icon:"\u{1F7E1}"},{value:"done",label:"\u2705 Done",icon:"\u2705"},{value:"dropped",label:"\u{1F534} Dropped",icon:"\u{1F534}"}].forEach(c=>{r.addItem(l=>{l.setTitle(c.label+(n===c.value?" \u2713":"")).onClick(async()=>{await this.setStatus(t,s,c.value)})})}),r.showAtMouseEvent(e)}showPriorityMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.priority;if(!s)return;let r=new p.Menu;[{value:"anytime",label:"\u2022 Anytime",icon:"\u2022"},{value:"today",label:"\u2B50 Today",icon:"\u2B50"},{value:"someday",label:"\u{1F4AD} Someday",icon:"\u{1F4AD}"}].forEach(c=>{r.addItem(l=>{l.setTitle(c.label+(n===c.value?" \u2713":"")).onClick(async()=>{await this.setPriority(t,s,c.value)})})}),r.showAtMouseEvent(e)}async setStatus(t,e,s){try{await this.updateTaskField(e,"status",s);let n=t.closest(".minimal-task-row");n&&n.setAttribute("data-status",s),t.dataset.status=s;let r=n==null?void 0:n.querySelector(".minimal-task-title");r&&(s==="done"||s==="dropped"?r.classList.add("is-completed"):r.classList.remove("is-completed"));let i={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new p.Notice(i[s]||s)}catch(n){console.error("Error setting status:",n),new p.Notice("Error updating task status")}}async setPriority(t,e,s){try{await this.updateTaskField(e,"priority",s),t.dataset.priority=s,t.textContent=this.getPriorityIcon(s);let n={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new p.Notice(n[s]||s)}catch(n){console.error("Error setting priority:",n),new p.Notice("Error updating task priority")}}async cycleStatus(t){let e=t.dataset.taskPath,s=t.dataset.status;if(!e)return;let n=["none","open","in-progress","done","dropped"],r=n.indexOf(s||"none"),i=n[(r+1)%n.length];try{await this.updateTaskField(e,"status",i);let c=t.closest(".minimal-task-row");c&&c.setAttribute("data-status",i),t.dataset.status=i;let l=c==null?void 0:c.querySelector(".minimal-task-title");l&&(i==="done"||i==="dropped"?l.classList.add("is-completed"):l.classList.remove("is-completed"));let o={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new p.Notice(o[i]||i)}catch(c){console.error("Error cycling status:",c),new p.Notice("Error updating task status")}}async cyclePriority(t){let e=t.dataset.taskPath,s=t.dataset.priority;if(!e)return;let n=["anytime","today","someday"],r=n.indexOf(s||"anytime"),i=n[(r+1)%n.length];try{await this.updateTaskField(e,"priority",i),t.dataset.priority=i,t.textContent=this.getPriorityIcon(i);let c={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new p.Notice(c[i]||i)}catch(c){console.error("Error cycling priority:",c),new p.Notice("Error updating task priority")}}async updateTaskField(t,e,s){let n=this.app.vault.getAbstractFileByPath(t);if(!n||!(n instanceof p.TFile))throw new Error(`Task file not found: ${t}`);let r=await this.app.vault.read(n),{frontmatter:i,body:c}=this.parseFrontmatter(r);i.rrule&&String(i.rrule).trim().length>0&&(e==="status"&&s==="done")&&await this.createNextRecurringInstance(i,c),i[e]=s,e==="status"&&s==="done"&&!i.completedDate&&(i.completedDate=new Date().toISOString().split("T")[0]),e==="status"&&s!=="done"&&i.completedDate&&delete i.completedDate;let u=this.rebuildContent(i,c);await this.app.vault.modify(n,u)}async createNextRecurringInstance(t,e){try{new p.Notice("\u{1F501} Creating next instance...",2e3);let s=String(t.rrule).replace(/^["']|["']$/g,""),n=new Date().toISOString().split("T")[0],r=this.calculateNextOccurrence(s,n),i=new Date,u=`gtd/actions/${`${i.toISOString().replace(/[:.]/g,"-").replace("T","-").split("-").slice(0,6).join("").replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1$2$3-$4$5$6")}.md`}`,g=i.toISOString(),f={status:"open",priority:t.priority||"anytime",dateCreated:g,dateModified:g,tags:t.tags||"[]",type:"action",title:t.title||"",contexts:t.contexts||[],area:t.area||'""',scheduled:r,rrule:`"${s}"`};if(t.projects&&(f.projects=t.projects),t.due&&t.scheduled){let b=new Date(t.scheduled),T=new Date(t.due).getTime()-b.getTime(),C=new Date(new Date(r).getTime()+T);f.due=C.toISOString().split("T")[0]}else t.due&&(f.due=t.due);t.recurrence_start&&(f.recurrence_start=t.recurrence_start),t.store&&(f.store=t.store),t["discuss-with"]&&(f["discuss-with"]=t["discuss-with"]),t["discuss-during"]&&(f["discuss-during"]=t["discuss-during"]);let w=this.rebuildContent(f,e);await this.app.vault.create(u,w),new p.Notice(`\u2705 Completed! Next: ${r}`,3e3)}catch(s){console.error("Failed to create recurring task instance:",s),new p.Notice("\u26A0\uFE0F Failed to create next instance: "+s.message,5e3)}}calculateNextOccurrence(t,e){let s=this.parseRRule(t),n=new Date(e);n.setDate(n.getDate()+1);let r=s.DTSTART;if(!r)throw new Error("DTSTART is required in RRULE");let i=new Date(parseInt(r.substring(0,4)),parseInt(r.substring(4,6))-1,parseInt(r.substring(6,8))),c=s.FREQ;if(!c)throw new Error("FREQ is required in RRULE");let l=parseInt(s.INTERVAL||"1"),o;switch(c){case"DAILY":if(o=new Date(n),s.BYDAY){let S=s.BYDAY.split(",").map(this.dayCodeToNumber);for(;!S.includes(o.getDay());)o.setDate(o.getDate()+1)}else{let M=Math.floor((o.getTime()-i.getTime())/864e5)%l;M!==0&&o.setDate(o.getDate()+(l-M))}break;case"WEEKLY":o=new Date(n);let b=(s.BYDAY||["SU","MO","TU","WE","TH","FR","SA"][i.getDay()]).split(",").map(this.dayCodeToNumber),k=!1;for(let S=0;S<7&&!k;S++){if(b.includes(o.getDay())){if(l===1){k=!0;break}if(Math.floor((o.getTime()-i.getTime())/(1e3*60*60*24*7))%l===0){k=!0;break}}o.setDate(o.getDate()+1)}if(!k)for(o=new Date(n),o.setDate(o.getDate()+l*7);!b.includes(o.getDay());)o.setDate(o.getDate()+1);break;case"MONTHLY":o=new Date(n);let T=s.BYMONTHDAY?parseInt(s.BYMONTHDAY):i.getDate();if(o.setDate(T),o<=n)o.setMonth(o.getMonth()+l);else{let S=(o.getFullYear()-i.getFullYear())*12+(o.getMonth()-i.getMonth());if(S%l!==0){let M=S%l;o.setMonth(o.getMonth()+(l-M))}}for(;o.getDate()!==T;)o.setDate(0),o.setMonth(o.getMonth()+1);break;case"YEARLY":o=new Date(n);let C=s.BYMONTH?parseInt(s.BYMONTH)-1:i.getMonth(),$=s.BYMONTHDAY?parseInt(s.BYMONTHDAY):i.getDate();if(o.setMonth(C),o.setDate($),o<=n)o.setFullYear(o.getFullYear()+l);else{let S=o.getFullYear()-i.getFullYear();if(S%l!==0){let M=S%l;o.setFullYear(o.getFullYear()+(l-M))}}break;default:throw new Error("Unsupported FREQ: "+c)}let u=o.getFullYear(),g=String(o.getMonth()+1).padStart(2,"0"),f=String(o.getDate()).padStart(2,"0");return`${u}-${g}-${f}`}dayCodeToNumber(t){return{SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[t]||0}parseFrontmatter(t){let e=/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/,s=t.match(e);if(!s)return{frontmatter:{},body:t};let n=s[1],r=s[2],i={},c=n.split(`
`),l=null,o=null;for(let u of c){if(u.trim().startsWith("- ")){o&&o.push(u.trim().substring(2));continue}let g=u.indexOf(":");if(g>0){let f=u.substring(0,g).trim(),w=u.substring(g+1).trim();l=f,w===""?(o=[],i[f]=o):(i[f]=w,o=null)}}return{frontmatter:i,body:r}}rebuildContent(t,e){let s=[];for(let[r,i]of Object.entries(t))Array.isArray(i)?i.length===0?s.push(`${r}: []`):(s.push(`${r}:`),i.forEach(c=>{s.push(`  - ${c}`)})):s.push(`${r}: ${i}`);return`---
${s.join(`
`)}
---
${e}`}refreshDataview(){setTimeout(()=>{try{this.app.commands.executeCommandById("dataview:dataview-rebuild-current-view")}catch(t){this.app.metadataCache.trigger("changed")}},100)}processActionLinks(t,e){var n;let s=t.querySelectorAll("li.task-list-item");for(let r of Array.from(s)){let i=r.querySelectorAll("a.internal-link"),c=!1;for(let l of Array.from(i)){let u=(l.getAttribute("data-href")||"").match(/^(gtd\/actions\/)?(\d{8}-\d{6})$/);if(!u)continue;c=!0;let g=`gtd/actions/${u[2]}.md`,f=l.textContent||u[2],w=this.app.vault.getAbstractFileByPath(g);if(!(w instanceof p.TFile))continue;let b=this.app.metadataCache.getFileCache(w),k=(b==null?void 0:b.frontmatter)||{},T=(n=b==null?void 0:b.sections)==null?void 0:n.some(S=>S.type==="paragraph"||S.type==="list"||S.type==="heading"),C=this.createInlineTaskElement(k,g,f,T||!1);l.replaceWith(C);let $=r.querySelector('input[type="checkbox"]');$&&($.style.display="none")}if(!c){if(!r.querySelector('input[type="checkbox"]'))continue;let o=this.getTaskTextFromListItem(r);if(!o||o.trim()==="")continue;let u=document.createElement("span");u.className="minimal-tasks-convert-icon",u.textContent="\u2795",u.setAttribute("data-task-text",o),u.setAttribute("data-source-path",e.sourcePath),r.appendChild(u)}}}getTaskTextFromListItem(t){var r;let e=t.cloneNode(!0),s=e.querySelector('input[type="checkbox"]');s&&s.remove();let n=e.querySelector(".minimal-tasks-convert-icon");return n&&n.remove(),((r=e.textContent)==null?void 0:r.trim())||""}async convertToAction(t,e,s,n){try{let r=await this.detectNoteContext(),i=this.generateTimestamp(),l=`gtd/actions/${`${i}.md`}`,o=this.buildConvertFrontmatter(t,r),u=this.app.workspace.getActiveFile(),g=u==null?void 0:u.path,f=this.buildActionContent(o,g);await this.app.vault.create(l,f);let w=`- [ ] [[${i}|${t}]]`;n.dispatch({changes:{from:e,to:s,insert:w}}),new p.Notice(`Created action: ${t}`)}catch(r){console.error("Error converting task:",r),new p.Notice("Error converting task: "+r.message)}}async convertToActionFromReading(t,e){var s;try{let n=this.app.vault.getAbstractFileByPath(e);if(!(n instanceof p.TFile)){new p.Notice("Source file not found");return}let r=await this.app.vault.read(n),{frontmatter:i}=this.parseFrontmatter(r),c={};e.startsWith("gtd/projects/")&&!e.includes("archive")?c={projects:[`[[${((s=e.split("/").pop())==null?void 0:s.replace(".md",""))||""}]]`]}:i.type==="event"&&i.project?c={projects:[i.project]}:i.area&&(c={area:i.area});let l=this.generateTimestamp(),u=`gtd/actions/${`${l}.md`}`,g=this.buildConvertFrontmatter(t,c),f=this.buildActionContent(g,e);await this.app.vault.create(u,f);let w=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),b=new RegExp(`^(\\s*)- \\[[ x]\\] ${w}$`,"m"),k=r.replace(b,`$1- [ ] [[${l}|${t}]]`);k!==r?(await this.app.vault.modify(n,k),new p.Notice(`Created action: ${t}`)):new p.Notice("Could not find task in source file")}catch(n){console.error("Error converting task:",n),new p.Notice("Error converting task: "+n.message)}}async detectNoteContext(){let t=this.app.workspace.getActiveFile();if(!t)return{};let e=await this.app.vault.read(t),{frontmatter:s}=this.parseFrontmatter(e);return t.path.startsWith("gtd/projects/")&&!t.path.includes("archive")?{projects:[`[[${t.basename}]]`]}:s.type==="event"&&s.project?{projects:[s.project]}:s.area?{area:s.area}:{}}generateTimestamp(){let t=new Date,e=s=>s.toString().padStart(2,"0");return`${t.getFullYear()}${e(t.getMonth()+1)}${e(t.getDate())}-${e(t.getHours())}${e(t.getMinutes())}${e(t.getSeconds())}`}buildConvertFrontmatter(t,e){let s=new Date().toISOString(),n={type:"action",title:t,status:"open",priority:"anytime",dateCreated:s,dateModified:s,tags:[],contexts:[]},r=(e.projects||[]).filter(i=>i?(typeof i=="string"?i:String(i)).trim().length>0:!1);return r.length>0?(n.projects=r,n.area='""'):e.area&&e.area.trim()&&e.area!=='""'?(n.projects=[],n.area=e.area):(n.projects=[],n.area='""'),n}buildActionContent(t,e){let s='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n';if(e){let n=e.replace(".md","");s+=`
Created from [[${n}]]
`}return this.rebuildContent(t,s)}onunload(){console.log("Unloading Minimal Tasks plugin"),delete window.MinimalTasks}},Dt=class extends p.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Minimal Tasks Settings"}),t.createEl("h3",{text:"Frontmatter Field Names"}),t.createEl("p",{text:"Customize which frontmatter fields are used for task metadata.",cls:"setting-item-description"}),new p.Setting(t).setName("Status field").setDesc("Frontmatter field for task status").addText(e=>e.setPlaceholder("status").setValue(this.plugin.settings.statusField).onChange(async s=>{this.plugin.settings.statusField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Priority field").setDesc("Frontmatter field for task priority").addText(e=>e.setPlaceholder("priority").setValue(this.plugin.settings.priorityField).onChange(async s=>{this.plugin.settings.priorityField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Projects field").setDesc("Frontmatter field for project links (array)").addText(e=>e.setPlaceholder("projects").setValue(this.plugin.settings.projectField).onChange(async s=>{this.plugin.settings.projectField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Contexts field").setDesc("Frontmatter field for contexts (array)").addText(e=>e.setPlaceholder("contexts").setValue(this.plugin.settings.contextsField).onChange(async s=>{this.plugin.settings.contextsField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Due date field").setDesc("Frontmatter field for due date").addText(e=>e.setPlaceholder("due").setValue(this.plugin.settings.dueField).onChange(async s=>{this.plugin.settings.dueField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Scheduled field").setDesc("Frontmatter field for scheduled date").addText(e=>e.setPlaceholder("scheduled").setValue(this.plugin.settings.scheduledField).onChange(async s=>{this.plugin.settings.scheduledField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Discuss-with field").setDesc("Frontmatter field for people to discuss with (array)").addText(e=>e.setPlaceholder("discuss-with").setValue(this.plugin.settings.discussWithField).onChange(async s=>{this.plugin.settings.discussWithField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Discuss-during field").setDesc("Frontmatter field for meetings to discuss during (array)").addText(e=>e.setPlaceholder("discuss-during").setValue(this.plugin.settings.discussDuringField).onChange(async s=>{this.plugin.settings.discussDuringField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Store field").setDesc("Frontmatter field for store/location (errands)").addText(e=>e.setPlaceholder("store").setValue(this.plugin.settings.storeField).onChange(async s=>{this.plugin.settings.storeField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Area field").setDesc("Frontmatter field for area/category").addText(e=>e.setPlaceholder("area").setValue(this.plugin.settings.areaField).onChange(async s=>{this.plugin.settings.areaField=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Title field").setDesc("Frontmatter field for task title").addText(e=>e.setPlaceholder("title").setValue(this.plugin.settings.titleField).onChange(async s=>{this.plugin.settings.titleField=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Display Options"}),new p.Setting(t).setName("Show projects").setDesc("Display project links below tasks").addToggle(e=>e.setValue(this.plugin.settings.showProjects).onChange(async s=>{this.plugin.settings.showProjects=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Show project due dates").setDesc("Show due date warnings for projects").addToggle(e=>e.setValue(this.plugin.settings.showProjectDueDates).onChange(async s=>{this.plugin.settings.showProjectDueDates=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Show note icon").setDesc("Show \u2630 icon for tasks with content").addToggle(e=>e.setValue(this.plugin.settings.showNoteIcon).onChange(async s=>{this.plugin.settings.showNoteIcon=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Enable convert icon").setDesc("Show a convert icon at the end of markdown task lines in edit mode. Click to convert to an action file. Requires restart to take effect.").addToggle(e=>e.setValue(this.plugin.settings.enableConvertIcon).onChange(async s=>{this.plugin.settings.enableConvertIcon=s,await this.plugin.saveSettings()})),new p.Setting(t).setName("Note content ignore pattern").setDesc("Regex pattern to ignore when detecting note content. Useful for stripping boilerplate code blocks like ribbons. Leave empty to disable.").addTextArea(e=>e.setPlaceholder('^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*').setValue(this.plugin.settings.noteContentIgnorePattern).onChange(async s=>{this.plugin.settings.noteContentIgnorePattern=s,await this.plugin.saveSettings()}))}};
