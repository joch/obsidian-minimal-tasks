/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var $t=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var ge=Object.prototype.hasOwnProperty;var he=(g,l)=>{for(var t in l)$t(g,t,{get:l[t],enumerable:!0})},me=(g,l,t,e)=>{if(l&&typeof l=="object"||typeof l=="function")for(let s of pe(l))!ge.call(g,s)&&s!==t&&$t(g,s,{get:()=>l[s],enumerable:!(e=ue(l,s))||e.enumerable});return g};var fe=g=>me($t({},"__esModule",{value:!0}),g);var we={};he(we,{default:()=>St});module.exports=fe(we);var u=require("obsidian"),I=require("@codemirror/view");var At={projectField:"projects",dueField:"due",scheduledField:"scheduled",contextsField:"contexts",discussWithField:"discuss-with",discussDuringField:"discuss-during",storeField:"store",areaField:"area",titleField:"title",statusField:"status",priorityField:"priority",rruleField:"rrule",showProjects:!0,showProjectDueDates:!0,showNoteIcon:!0,showContextPills:!1,noteContentIgnorePattern:'^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*',enableConvertIcon:!0,statuses:["none","open","in-progress","done","dropped"],priorities:["anytime","today","someday"]};function it(g){let l=document.createElement("div");return l.textContent=g,l.textContent||""}function rt(){let g=new Date,l=t=>t.toString().padStart(2,"0");return`${g.getFullYear()}${l(g.getMonth()+1)}${l(g.getDate())}-${l(g.getHours())}${l(g.getMinutes())}${l(g.getSeconds())}`}function yt(g){let l=g%10,t=g%100;return l===1&&t!==11?"st":l===2&&t!==12?"nd":l===3&&t!==13?"rd":"th"}function Mt(g){return g+yt(g)}function vt(g){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][g.getMonth()]} ${g.getDate()}`}function wt(g){if(!g)return"";let l=String(g).replace(/^["']|["']$/g,"");return l.length>=10?l.substring(0,10):""}function ot(g){if(!g)return g;let l=String(g),t=l.match(/\[\[(?:[^\]|]+\|)?([^\]]+)\]\]/);return t?t[1]:l}function kt(g){if(!g)return null;let t=String(g).match(/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/);return t?t[1]:null}function Ct(g){return g&&g.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")}function Z(g){let l=/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/,t=g.match(l);if(!t)return{frontmatter:{},body:g};let e=t[1],s=t[2],n={},o=e.split(`
`),r=null,a=null;for(let c of o){if(c.trim().startsWith("- ")){a&&a.push(c.trim().substring(2));continue}let h=c.indexOf(":");if(h>0){let p=c.substring(0,h).trim(),m=c.substring(h+1).trim();r=p,m===""?(a=[],n[p]=a):(n[p]=m,a=null)}}return{frontmatter:n,body:s}}function ct(g,l){let t=[];for(let[s,n]of Object.entries(g))Array.isArray(n)?n.length===0?t.push(`${s}: []`):(t.push(`${s}:`),n.forEach(o=>{t.push(`  - ${o}`)})):t.push(`${s}: ${n}`);return`---
${t.join(`
`)}
---
${l}`}function Dt(g){let l={};return g.split(";").forEach(e=>{let[s,n]=e.split(":").length===2?e.split(":"):e.split("=");s&&n&&(l[s]=n)}),l}function jt(g){if(!g)return"";try{let l=Dt(g),t=l.FREQ,e=parseInt(l.INTERVAL||"1"),s=l.BYDAY,n=l.BYMONTHDAY,o=l.BYMONTH,r=l.BYSETPOS,a="";if(e===1)switch(t){case"DAILY":a="Daily";break;case"WEEKLY":a="Weekly";break;case"MONTHLY":a="Monthly";break;case"YEARLY":a="Yearly";break}else if(t==="MONTHLY"&&e===3)a="Quarterly";else if(t==="MONTHLY"&&e===6)a="Biannually";else switch(t){case"DAILY":a=`Every ${e} days`;break;case"WEEKLY":a=`Every ${e} weeks`;break;case"MONTHLY":a=`Every ${e} months`;break;case"YEARLY":a=`Every ${e} years`;break}if(r&&s){let h={SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"}[s]||s,p=parseInt(r),m=p===-1?"last":Mt(p);a+=` on the ${m} ${h}`}else if(s){let c=s.split(",").map(h=>({SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"})[h]||h);a+=" on "+c.join(", ")}return n&&(a+=" on the "+n+yt(parseInt(n))),o&&(a+=" in "+["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(o)]),a}catch(l){return console.error("Failed to format RRULE:",l),"Recurring"}}function Lt(g){return{SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[g]||0}function It(g,l){let t=Dt(g),e=new Date(l);e.setDate(e.getDate()+1);let s=t.DTSTART;if(!s)throw new Error("DTSTART is required in RRULE");let n=new Date(parseInt(s.substring(0,4)),parseInt(s.substring(4,6))-1,parseInt(s.substring(6,8))),o=t.FREQ;if(!o)throw new Error("FREQ is required in RRULE");let r=parseInt(t.INTERVAL||"1"),a;switch(o){case"DAILY":if(a=new Date(e),t.BYDAY){let T=t.BYDAY.split(",").map(Lt);for(;!T.includes(a.getDay());)a.setDate(a.getDate()+1)}else{let P=Math.floor((a.getTime()-n.getTime())/864e5)%r;P!==0&&a.setDate(a.getDate()+(r-P))}break;case"WEEKLY":a=new Date(e);let w=(t.BYDAY||["SU","MO","TU","WE","TH","FR","SA"][n.getDay()]).split(",").map(Lt),k=!1;for(let T=0;T<7&&!k;T++){if(w.includes(a.getDay())){if(r===1){k=!0;break}if(Math.floor((a.getTime()-n.getTime())/(1e3*60*60*24*7))%r===0){k=!0;break}}a.setDate(a.getDate()+1)}if(!k)for(a=new Date(e),a.setDate(a.getDate()+r*7);!w.includes(a.getDay());)a.setDate(a.getDate()+1);break;case"MONTHLY":a=new Date(e);let D=t.BYMONTHDAY?parseInt(t.BYMONTHDAY):n.getDate();if(a.setDate(D),a<=e)a.setMonth(a.getMonth()+r);else{let T=(a.getFullYear()-n.getFullYear())*12+(a.getMonth()-n.getMonth());if(T%r!==0){let P=T%r;a.setMonth(a.getMonth()+(r-P))}}for(;a.getDate()!==D;)a.setDate(0),a.setMonth(a.getMonth()+1);break;case"YEARLY":a=new Date(e);let b=t.BYMONTH?parseInt(t.BYMONTH)-1:n.getMonth(),x=t.BYMONTHDAY?parseInt(t.BYMONTHDAY):n.getDate();if(a.setMonth(b),a.setDate(x),a<=e)a.setFullYear(a.getFullYear()+r);else{let T=a.getFullYear()-n.getFullYear();if(T%r!==0){let P=T%r;a.setFullYear(a.getFullYear()+(r-P))}}break;default:throw new Error("Unsupported FREQ: "+o)}let c=a.getFullYear(),h=String(a.getMonth()+1).padStart(2,"0"),p=String(a.getDate()).padStart(2,"0");return`${c}-${h}-${p}`}var Nt=class extends I.WidgetType{constructor(t,e,s,n){super();this.plugin=t;this.taskText=e;this.lineFrom=s;this.lineTo=n}toDOM(t){let e=document.createElement("span");return e.className="minimal-tasks-convert-icon",e.textContent="\u2795",e.title="Convert to action",e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.plugin.convertToAction(this.taskText,this.lineFrom,this.lineTo,t)}),e}eq(t){return this.taskText===t.taskText&&this.lineFrom===t.lineFrom}},Rt=class extends I.WidgetType{constructor(t,e,s){super();this.plugin=t;this.actionPath=e;this.displayTitle=s}toDOM(){var o;let t=this.plugin.app.vault.getAbstractFileByPath(this.actionPath+".md"),e=t?this.plugin.app.metadataCache.getFileCache(t):null,s=(e==null?void 0:e.frontmatter)||{},n=(o=e==null?void 0:e.sections)==null?void 0:o.some(r=>r.type==="paragraph"||r.type==="list"||r.type==="heading");return this.plugin.createInlineTaskElement(s,this.actionPath+".md",this.displayTitle,n||!1)}eq(t){return this.actionPath===t.actionPath}};function ye(g){return I.ViewPlugin.fromClass(class{constructor(l){this.decorations=this.buildDecorations(l)}update(l){(l.docChanged||l.viewportChanged)&&(this.decorations=this.buildDecorations(l.view))}buildDecorations(l){let t=[],e=/^(\s*)- \[[ x]\] \[\[(gtd\/actions\/)?(\d{8}-\d{6})\|([^\]]+)\]\]\s*$/;for(let{from:s,to:n}of l.visibleRanges)for(let o=s;o<=n;){let r=l.state.doc.lineAt(o),a=r.text.match(e);if(a){let c=a[1],h=`gtd/actions/${a[3]}`,p=a[4],m=I.Decoration.replace({widget:new Rt(g,h,p)}),w=r.from+c.length;t.push(m.range(w,r.to))}o=r.to+1}return I.Decoration.set(t,!0)}},{decorations:l=>l.decorations})}function ve(g){return I.ViewPlugin.fromClass(class{constructor(l){this.decorations=this.buildDecorations(l)}update(l){(l.docChanged||l.viewportChanged)&&(this.decorations=this.buildDecorations(l.view))}buildDecorations(l){let t=[],e=/^(\s*)- \[ \] (.+)$/,s=/\[\[(gtd\/actions\/)?\d{8}-\d{6}\|/;for(let{from:n,to:o}of l.visibleRanges)for(let r=n;r<=o;){let a=l.state.doc.lineAt(r),c=a.text.match(e);if(c&&c[2]&&!s.test(a.text)){let h=I.Decoration.widget({widget:new Nt(g,c[2],a.from,a.to),side:1});t.push(h.range(a.to))}r=a.to+1}return I.Decoration.set(t,!0)}},{decorations:l=>l.decorations})}var lt=class extends u.Modal{constructor(t,e,s,n,o){super(t);this.frontmatter={};this.body="";this.isCreateMode=!1;this.didSave=!1;this.plugin=e,this.taskPath=s,n&&(this.isCreateMode=!0,this.frontmatter=n,this.body='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n',o&&(this.body+=`
`+o))}async onOpen(){let{contentEl:t}=this;if(t.addClass("edit-task-modal"),this.isCreateMode){this.buildForm();return}let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof u.TFile)){t.createEl("p",{text:"Error: Task file not found"});return}let s=await this.app.vault.read(e),n=this.plugin.parseFrontmatter(s);this.frontmatter=n.frontmatter,this.body=n.body,this.buildForm()}buildForm(){let{contentEl:t}=this;t.empty();let e,s,n,r=t.createDiv({cls:"edit-task-title-container"}).createEl("input",{cls:"edit-task-title-input",attr:{type:"text",placeholder:"Task title...",value:String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")}});r.addEventListener("change",()=>{this.frontmatter.title=r.value}),setTimeout(()=>r.focus(),0);let a=t.createDiv({cls:"edit-task-section"});a.createDiv({cls:"edit-task-section-label",text:"Contexts"});let c=a.createDiv({cls:"edit-task-contexts"}),h=["focus","quick","relax","home","office","brf","school","errands","agenda","waiting"],p=this.getArrayField("contexts"),m=()=>{var d,S;let i=this.getActiveContexts(c);if(e){let F=((d=this.frontmatter["discuss-with"])==null?void 0:d.length)>0||((S=this.frontmatter["discuss-during"])==null?void 0:S.length)>0;e.style.display=i.includes("agenda")||F?"":"none"}if(s){let F=this.frontmatter.store&&String(this.frontmatter.store).replace(/^["']|["']$/g,"").trim()!=="";s.style.display=i.includes("errands")||F?"":"none"}};h.forEach(i=>{let d=c.createSpan({cls:"context-pill"+(p.includes(i)?" active":""),text:"@"+i});d.addEventListener("click",()=>{d.toggleClass("active",!d.hasClass("active")),this.updateContexts(c),m()})});let k=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),D=k.createDiv({cls:"edit-task-inline-group"});D.createSpan({cls:"edit-task-label",text:"\u{1F4C2} Project"});let b=D.createEl("select",{cls:"edit-task-select-project"});b.createEl("option",{value:"",text:"(none)"});let x={Personal:"\u{1F468}\u200D\u{1F4BB}",Family:"\u{1F9D1}\u200D\u{1F3A8}",Social:"\u{1F57A}",Home:"\u{1F3E0}",Opper:"\u{1F3E2}",Solv\u00E4ndan:"\u2600\uFE0F",Garage:"\u{1F697}"},T=["Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage",""],P=this.app.vault.getMarkdownFiles().filter(i=>i.path.startsWith("gtd/projects/")&&!i.path.includes("archive")).map(i=>{var Y;let d=this.app.metadataCache.getFileCache(i),S=(Y=d==null?void 0:d.frontmatter)==null?void 0:Y.area,F="";if(S&&typeof S=="string"&&(S=S.replace(/^["']|["']$/g,""),S.includes("|"))){let X=S.split("|");X.length>=2&&(F=X[1].replace(/\]\]$/,"").trim())}return{file:i,area:F}}).sort((i,d)=>i.file.basename.localeCompare(d.file.basename)),M=new Map;P.forEach(i=>{let d=i.area||"";M.has(d)||M.set(d,[]),M.get(d).push(i)});let B=this.getProjectBasename();T.forEach(i=>{let d=M.get(i);if(!d||d.length===0)return;let S=x[i]||"\u{1F4E6}",F=i?`${S} ${i}`:"\u{1F4E6} No Area",Y=b.createEl("optgroup",{attr:{label:F}});d.forEach(X=>{let de=Y.createEl("option",{value:X.file.path,text:X.file.basename});X.file.basename===B&&(de.selected=!0)})});let W=k.createDiv({cls:"edit-task-inline-group"});W.createSpan({cls:"edit-task-label",text:"\u{1F5C2}\uFE0F Area"});let C=W.createEl("select",{cls:"edit-task-select-small"}),tt=["","Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage"],dt=this.getAreaName();tt.forEach(i=>{let d=i?x[i]||"\u{1F4E6}":"",S=i?`${d} ${i}`:"(none)",F=C.createEl("option",{value:i,text:S});i===dt&&(F.selected=!0)}),C.addEventListener("change",()=>{C.value?this.frontmatter.area=`"[[gtd/areas/${C.value}|${C.value}]]"`:this.frontmatter.area='""'}),b.addEventListener("change",()=>{if(b.value){let i=P.find(d=>d.file.path===b.value);i&&(this.frontmatter.projects=[`"[[${i.file.path}|${i.file.basename}]]"`],C.value="",this.frontmatter.area='""')}else this.frontmatter.projects=[]}),e=t.createDiv({cls:"edit-task-section"});let q=e.createDiv({cls:"edit-task-row-inline"}),et=q.createDiv({cls:"edit-task-inline-group"});et.createSpan({cls:"edit-task-label",text:"\u{1F464} With"});let v=et.createEl("select",{cls:"edit-task-select-small"});v.createEl("option",{value:"",text:"(none)"});let A=this.app.vault.getMarkdownFiles().filter(i=>i.path.startsWith("notes/person/")).sort((i,d)=>i.basename.localeCompare(d.basename)),f=this.getDiscussWithBasename();A.forEach(i=>{let d=v.createEl("option",{value:i.path,text:i.basename});i.basename===f&&(d.selected=!0)}),v.addEventListener("change",()=>{if(v.value){let i=A.find(d=>d.path===v.value);i&&(this.frontmatter["discuss-with"]=[`"[[${i.path}|${i.basename}]]"`])}else delete this.frontmatter["discuss-with"]});let y=q.createDiv({cls:"edit-task-inline-group"});y.createSpan({cls:"edit-task-label",text:"\u{1F4C5} During"});let E=y.createEl("select",{cls:"edit-task-select-small"});E.createEl("option",{value:"",text:"(none)"});let $=this.app.vault.getMarkdownFiles().filter(i=>i.path.startsWith("events/")).sort((i,d)=>d.basename.localeCompare(i.basename)).slice(0,50),H=this.getDiscussDuringBasename();$.forEach(i=>{let d=i.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,""),S=E.createEl("option",{value:i.path,text:d});(i.basename===H||d===H)&&(S.selected=!0)}),E.addEventListener("change",()=>{if(E.value){let i=$.find(d=>d.path===E.value);if(i){let d=i.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${i.path}|${d}]]"`]}}else delete this.frontmatter["discuss-during"]}),s=t.createDiv({cls:"edit-task-section"});let st=s.createDiv({cls:"edit-task-row-inline"}),nt=st.createDiv({cls:"edit-task-inline-group"});nt.createSpan({cls:"edit-task-label",text:"\u{1F3EA} Store"});let V=nt.createEl("input",{cls:"edit-task-input-small",attr:{type:"text",placeholder:"Type or select...",list:"store-suggestions",value:String(this.frontmatter.store||"").replace(/^["']|["']$/g,"")}}),ae=st.createEl("datalist",{attr:{id:"store-suggestions"}}),Ot=new Set;this.app.vault.getMarkdownFiles().filter(i=>i.path.startsWith("gtd/actions/")).forEach(i=>{var F;let d=this.app.metadataCache.getFileCache(i),S=(F=d==null?void 0:d.frontmatter)==null?void 0:F.store;if(S){let Y=String(S).replace(/^["']|["']$/g,"");Y&&Ot.add(Y)}}),Array.from(Ot).sort().forEach(i=>{ae.createEl("option",{value:i})}),V.addEventListener("change",()=>{V.value?this.frontmatter.store=V.value:delete this.frontmatter.store}),m();let Ht=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),Bt=Ht.createDiv({cls:"edit-task-inline-group"});Bt.createSpan({cls:"edit-task-label",text:"\u{1F5D3}\uFE0F Scheduled"}),n=Bt.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:wt(this.frontmatter.scheduled)}}),n.addEventListener("change",()=>{this.frontmatter.scheduled=n.value||void 0,n.value||delete this.frontmatter.scheduled});let Wt=Ht.createDiv({cls:"edit-task-inline-group"});Wt.createSpan({cls:"edit-task-label",text:"\u{1F4C5} Due"});let ut=Wt.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:wt(this.frontmatter.due)}});ut.addEventListener("change",()=>{this.frontmatter.due=ut.value||void 0,ut.value||delete this.frontmatter.due});let Vt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),j=Vt.createDiv({cls:"edit-task-inline-group"});j.createSpan({cls:"edit-task-label",text:"\u{1F501} Every"});let bt=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],pt=["MO","TU","WE","TH","FR","SA","SU"],U=j.createEl("input",{cls:"edit-task-input-small",attr:{type:"number",min:"1",max:"99",value:"1"}});U.style.width="45px",U.style.display="none";let O=j.createEl("select",{cls:"edit-task-select-small"});O.createEl("option",{value:"",text:"(none)"}),O.createEl("option",{value:"day",text:"day"}),O.createEl("option",{value:"week",text:"week"}),O.createEl("option",{value:"month",text:"month"}),O.createEl("option",{value:"year",text:"year"});let _t=j.createSpan({cls:"edit-task-label",text:"on"});_t.style.display="none";let G=j.createEl("select",{cls:"edit-task-select-small"});bt.forEach((i,d)=>{G.createEl("option",{value:pt[d],text:i})}),G.style.display="none";let N=j.createEl("select",{cls:"edit-task-select-small"});N.createEl("option",{value:"day",text:"day"}),bt.forEach((i,d)=>{N.createEl("option",{value:pt[d],text:i})}),N.style.display="none";let Q=j.createEl("select",{cls:"edit-task-select-small"}),qt=[{label:"1st",value:"1"},{label:"2nd",value:"2"},{label:"3rd",value:"3"},{label:"4th",value:"4"},{label:"last",value:"-1"}];qt.forEach(i=>{Q.createEl("option",{value:i.value,text:i.label})}),Q.style.display="none";let J=j.createEl("select",{cls:"edit-task-select-small"});for(let i=1;i<=31;i++){let d=i===1||i===21||i===31?"st":i===2||i===22?"nd":i===3||i===23?"rd":"th";J.createEl("option",{value:String(i),text:`${i}${d}`})}J.style.display="none";let _=j.createEl("select",{cls:"edit-task-select-small"});["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((i,d)=>{_.createEl("option",{value:String(d+1),text:i})}),_.style.display="none";let R=j.createEl("select",{cls:"edit-task-select-small"});R.createEl("option",{value:"day",text:"day"}),bt.forEach((i,d)=>{R.createEl("option",{value:pt[d],text:i})}),R.style.display="none";let K=j.createEl("select",{cls:"edit-task-select-small"});qt.forEach(i=>{K.createEl("option",{value:i.value,text:i.label})}),K.style.display="none";let z=j.createEl("select",{cls:"edit-task-select-small"});for(let i=1;i<=31;i++)z.createEl("option",{value:String(i),text:String(i)});z.style.display="none";let gt=Vt.createDiv({cls:"edit-task-inline-group"});gt.createSpan({cls:"edit-task-label",text:"from"});let ht=gt.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date"}});gt.style.display="none";let Ut=String(this.frontmatter.rrule||"").replace(/^["']|["']$/g,""),at="",Gt=1,Qt=pt[(new Date().getDay()+6)%7],mt=new Date().getDate(),Jt=new Date().getMonth()+1,Tt="day",Et="day",Kt="1",zt="1",Xt=this.frontmatter.recurrence_start?String(this.frontmatter.recurrence_start).replace(/^["']|["']$/g,""):n.value||new Date().toISOString().split("T")[0];if(Ut){let i=this.plugin.parseRRule(Ut);if(i.DTSTART){let d=i.DTSTART;d.length===8&&(Xt=`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`)}Gt=parseInt(i.INTERVAL||"1"),i.FREQ==="DAILY"?at="day":i.FREQ==="WEEKLY"?(at="week",i.BYDAY&&(Qt=i.BYDAY)):i.FREQ==="MONTHLY"?(at="month",i.BYSETPOS&&i.BYDAY?(Tt=i.BYDAY,Kt=i.BYSETPOS):i.BYMONTHDAY&&(Tt="day",mt=parseInt(i.BYMONTHDAY))):i.FREQ==="YEARLY"&&(at="year",i.BYMONTH&&(Jt=parseInt(i.BYMONTH)),i.BYSETPOS&&i.BYDAY?(Et=i.BYDAY,zt=i.BYSETPOS):i.BYMONTHDAY&&(Et="day",mt=parseInt(i.BYMONTHDAY)))}O.value=at,U.value=String(Gt),G.value=Qt,J.value=String(mt),_.value=String(Jt),z.value=String(mt),N.value=Tt,R.value=Et,Q.value=Kt,K.value=zt,ht.value=Xt;let ft=()=>{let i=O.value,d=N.value,S=R.value,F=i==="month"&&d!=="day",Y=i==="year"&&S!=="day";U.style.display=i?"":"none",_t.style.display=i==="week"||i==="month"||i==="year"?"":"none",G.style.display=i==="week"?"":"none",N.style.display=i==="month"?"":"none",Q.style.display=F?"":"none",J.style.display=i==="month"&&!F?"":"none",_.style.display=i==="year"?"":"none",R.style.display=i==="year"?"":"none",K.style.display=Y?"":"none",z.style.display=i==="year"&&!Y?"":"none",gt.style.display=i?"":"none"};ft(),N.addEventListener("change",ft),R.addEventListener("change",ft);let ie=()=>{let i=ht.value||n.value||new Date().toISOString().split("T")[0],d=this.plugin.formatDTSTART(i),S=O.value,F=parseInt(U.value)||1;switch(S){case"day":return`DTSTART:${d};FREQ=DAILY;INTERVAL=${F}`;case"week":return`DTSTART:${d};FREQ=WEEKLY;INTERVAL=${F};BYDAY=${G.value}`;case"month":return N.value!=="day"?`DTSTART:${d};FREQ=MONTHLY;INTERVAL=${F};BYDAY=${N.value};BYSETPOS=${Q.value}`:`DTSTART:${d};FREQ=MONTHLY;INTERVAL=${F};BYMONTHDAY=${J.value}`;case"year":return R.value!=="day"?`DTSTART:${d};FREQ=YEARLY;INTERVAL=${F};BYMONTH=${_.value};BYDAY=${R.value};BYSETPOS=${K.value}`:`DTSTART:${d};FREQ=YEARLY;INTERVAL=${F};BYMONTH=${_.value};BYMONTHDAY=${z.value}`;default:return""}},L=()=>{let i=ie();if(i){let d=ht.value||n.value||new Date().toISOString().split("T")[0];this.frontmatter.rrule=i,this.frontmatter.recurrence_start=d}else delete this.frontmatter.rrule,delete this.frontmatter.recurrence_start};O.addEventListener("change",()=>{ft(),L()}),U.addEventListener("change",L),G.addEventListener("change",L),J.addEventListener("change",L),N.addEventListener("change",L),Q.addEventListener("change",L),_.addEventListener("change",L),R.addEventListener("change",L),K.addEventListener("change",L),z.addEventListener("change",L),ht.addEventListener("change",L);let Zt=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),te=Zt.createDiv({cls:"edit-task-inline-group"});te.createSpan({cls:"edit-task-label",text:"Status"});let xt=te.createDiv({cls:"edit-task-icon-group"}),re=[{value:"none",icon:"\u26AA"},{value:"open",icon:"\u{1F535}"},{value:"in-progress",icon:"\u{1F7E1}"},{value:"done",icon:"\u2705"},{value:"dropped",icon:"\u{1F534}"}],oe=this.frontmatter.status||"none";re.forEach(i=>{let d=xt.createSpan({cls:"edit-task-icon"+(oe===i.value?" active":""),text:i.icon,attr:{title:i.value}});d.addEventListener("click",()=>{xt.querySelectorAll(".edit-task-icon").forEach(S=>S.removeClass("active")),d.addClass("active"),this.frontmatter.status=i.value})});let ee=Zt.createDiv({cls:"edit-task-inline-group"});ee.createSpan({cls:"edit-task-label",text:"Priority"});let Ft=ee.createDiv({cls:"edit-task-icon-group"}),ce=[{value:"anytime",icon:"\u2022"},{value:"today",icon:"\u2B50"},{value:"someday",icon:"\u{1F4AD}"}],le=this.frontmatter.priority||"anytime";ce.forEach(i=>{let d=Ft.createSpan({cls:"edit-task-icon"+(le===i.value?" active":""),text:i.icon,attr:{title:i.value}});d.addEventListener("click",()=>{Ft.querySelectorAll(".edit-task-icon").forEach(S=>S.removeClass("active")),d.addClass("active"),this.frontmatter.priority=i.value})});let Pt=t.createDiv({cls:"edit-task-button-row"}),se=Pt.createEl("button",{cls:"edit-task-delete",text:"\u{1F5D1}\uFE0F"});se.setAttribute("title","Delete task"),se.addEventListener("click",()=>this.deleteTask());let ne=Pt.createEl("button",{cls:"edit-task-ai",text:"\u2728"});ne.setAttribute("title","AI suggest fields"),ne.addEventListener("click",()=>this.suggestFieldsWithAI(r,xt,Ft,ut,n,c,b,C,v,E,V,m)),Pt.createEl("button",{cls:"edit-task-save",text:"Save Changes"}).addEventListener("click",()=>this.saveChanges()),this.scope.register(["Mod"],"Enter",i=>(i.preventDefault(),this.saveChanges(),!1))}async deleteTask(){if(this.isCreateMode){this.close();return}let t=this.app.vault.getAbstractFileByPath(this.taskPath);if(!t||!(t instanceof u.TFile)){new u.Notice("Error: Task file not found");return}let e=String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")||t.basename;confirm(`Delete "${e}"?`)&&(await this.app.vault.delete(t),this.didSave=!0,new u.Notice("Task deleted"),this.close())}async suggestFieldsWithAI(t,e,s,n,o,r,a,c,h,p,m,w){try{let k=this.app.plugins.plugins["opper-ai"];if(!k){new u.Notice("Opper AI plugin not found. Please install and enable it.");return}if(!k.api){new u.Notice("Opper AI plugin API not initialized. Please reload Obsidian.");return}new u.Notice("\u2728 Analyzing task...",2e3);let b=new Date().toISOString().split("T")[0],x=this.app.vault.getMarkdownFiles().filter(f=>f.path.startsWith("gtd/projects/")&&!f.path.includes("archive")),T=x.map(f=>{var st,nt;let y=this.app.metadataCache.getFileCache(f),E=(st=y==null?void 0:y.frontmatter)==null?void 0:st.state,$=(nt=y==null?void 0:y.frontmatter)==null?void 0:nt.area,H="No Area";if($&&typeof $=="string"&&($=$.replace(/^["']|["']$/g,""),$.includes("|"))){let V=$.split("|");V.length>=2&&(H=V[1].replace(/\]\]$/,"").trim())}return{name:f.basename,area:H,state:E}}).filter(f=>f.state==="active"),P=this.app.vault.getMarkdownFiles().filter(f=>f.path.startsWith("notes/person/")),M=P.map(f=>f.basename),B=this.app.vault.getMarkdownFiles().filter(f=>f.path.startsWith("events/")),W=B.filter(f=>{var $;let y=this.app.metadataCache.getFileCache(f),E=($=y==null?void 0:y.frontmatter)==null?void 0:$.date;return E?E>=b:!0}).map(f=>f.basename),C=new Set;this.app.vault.getMarkdownFiles().filter(f=>f.path.startsWith("gtd/actions/")).forEach(f=>{var $;let y=this.app.metadataCache.getFileCache(f),E=($=y==null?void 0:y.frontmatter)==null?void 0:$.store;if(E){let H=String(E).replace(/^["']|["']$/g,"");H&&C.add(H)}});let tt=Array.from(C),dt=t.value||"",q=this.body||"",et=await k.api.call("detect-action-fields",{task_title:dt,task_body:q,current_date:b,available_contexts:["focus","quick","relax","home","office","brf","school","errands","agenda","waiting"],available_projects:T,available_areas:["Personal","Family","Social","Home","Opper","Solv\xE4ndan","Garage"],available_people:M,available_meetings:W,available_stores:tt},{instructions:this.getAIInstructions(),outputSchema:this.getAIOutputSchema(),model:"gcp/gemini-flash-latest"});if(!et.json_payload){new u.Notice("No suggestions from AI");return}let v=et.json_payload,A=[];if(v.title&&v.title.trim()&&(t.value=v.title,this.frontmatter.title=v.title,A.push("title")),v.priority){s.querySelectorAll(".edit-task-icon").forEach(y=>y.removeClass("active"));let f=s.querySelector(`[title="${v.priority}"]`);f&&(f.addClass("active"),this.frontmatter.priority=v.priority,A.push("priority"))}if(v.context){let f=r.querySelector(".context-pill:not(.active)");r.querySelectorAll(".context-pill").forEach(y=>{var $;((($=y.textContent)==null?void 0:$.replace("@",""))||"")===v.context&&!y.hasClass("active")&&(y.addClass("active"),A.push("context"))}),this.updateContexts(r),w()}if(v.projects&&v.projects.length>0){let f=v.projects[0],y=x.find(E=>E.basename===f);y&&(a.value=y.path,this.frontmatter.projects=[`"[[${y.path}|${y.basename}]]"`],A.push("project"))}if(v.area&&(!v.projects||v.projects.length===0)&&Array.from(c.options).find(y=>y.value===v.area)&&(c.value=v.area,this.frontmatter.area=`"[[gtd/areas/${v.area}|${v.area}]]"`,A.push("area")),v.discuss_with&&v.discuss_with.length>0){let f=v.discuss_with[0],y=P.find(E=>E.basename===f);y&&(h.value=y.path,this.frontmatter["discuss-with"]=[`"[[${y.path}|${y.basename}]]"`],A.push("discuss-with"))}if(v.discuss_during&&v.discuss_during.length>0){let f=v.discuss_during[0],y=B.find(E=>E.basename===f||E.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")===f);if(y){p.value=y.path;let E=y.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${y.path}|${E}]]"`],A.push("discuss-during")}}if(v.store&&(m.value=v.store,this.frontmatter.store=v.store,A.push("store")),v.due){let f=this.parseNaturalDate(v.due,b);f&&(n.value=f,this.frontmatter.due=f,A.push("due"))}if(v.scheduled){let f=this.parseNaturalDate(v.scheduled,b);f&&(o.value=f,this.frontmatter.scheduled=f,A.push("scheduled"))}w(),A.length>0?new u.Notice(`\u2728 Applied: ${A.join(", ")}`):new u.Notice("No fields detected")}catch(k){console.error("AI suggestion failed:",k),new u.Notice("AI suggestion failed: "+k.message)}}parseNaturalDate(t,e){if(!t)return null;let s=t.toLowerCase().trim(),n=new Date(e);if(s==="today")return e;if(s==="tomorrow"){let r=new Date(n);return r.setDate(r.getDate()+1),r.toISOString().split("T")[0]}if(s.startsWith("next ")){let r=s.replace("next ",""),c=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(r);if(c>=0){let h=new Date(n),p=h.getDay(),m=c-p;return m<=0&&(m+=7),h.setDate(h.getDate()+m),h.toISOString().split("T")[0]}}let o=s.match(/\d{4}-\d{2}-\d{2}/);return o?o[0]:null}getAIInstructions(){return`Analyze the task title and body to detect relevant GTD fields.

**Context Detection Rules:**
Suggest ONE primary context:
- "focus": Deep work (write, design, review)
- "quick": Tasks under 5 minutes (send email, reply, check)
- "relax": Low-energy tasks (read, watch, browse)
- "home"/"office"/"brf"/"school": Location-specific
- "errands": Shopping or pickup (buy, pick up, get)
- "agenda": Discussion topics (when people/meetings mentioned)
- "waiting": Waiting on something/someone

**Priority Detection:**
- "today": Urgent cues (urgent, ASAP, today, now)
- "someday": Later cues (maybe, someday, consider)
- "anytime": Default

**Date Detection:**
Return dates as natural language (e.g., "next friday", "tomorrow").

**Project/Area:**
- If project matches \u2192 return project, leave area empty
- If no project \u2192 suggest area based on keywords

**People/Meeting Detection:**
Match to available lists when discussion is mentioned.

**Store Detection:**
For errands, extract store names.

**Title Generation:**
If title can be improved (more concise, action-oriented), suggest improvement.`}getAIOutputSchema(){return{type:"object",properties:{context:{type:"string",description:"Single primary context or empty"},projects:{type:"array",items:{type:"string"},description:"Detected project names"},area:{type:"string",description:"Suggested area if no projects"},priority:{type:"string",enum:["anytime","today","someday"]},scheduled:{type:"string",description:"Natural language scheduled date"},due:{type:"string",description:"Natural language due date"},discuss_with:{type:"array",items:{type:"string"},description:"People to discuss with"},discuss_during:{type:"array",items:{type:"string"},description:"Meetings"},store:{type:"string",description:"Store name for errands"},title:{type:"string",description:"Suggested title improvement"},confidence_scores:{type:"object",properties:{context:{type:"number"},projects:{type:"number"},area:{type:"number"},priority:{type:"number"},scheduled:{type:"number"},due:{type:"number"},discuss_with:{type:"number"},discuss_during:{type:"number"},store:{type:"number"},title:{type:"number"}}}},required:["context","projects","area","priority","scheduled","due","discuss_with","discuss_during","store","title","confidence_scores"]}}getArrayField(t){let e=this.frontmatter[t];return Array.isArray(e)?e.map(s=>String(s).replace(/^["']|["']$/g,"")):[]}getProjectBasename(){var e;let t=this.frontmatter.projects;if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getAreaName(){let t=this.frontmatter.area;if(!t)return"";let s=String(t).replace(/^["']|["']$/g,"").match(/\|([^\]]+)\]\]/);return s?s[1]:""}getDiscussWithBasename(){var e;let t=this.frontmatter["discuss-with"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getDiscussDuringBasename(){var e;let t=this.frontmatter["discuss-during"];if(Array.isArray(t)&&t.length>0){let n=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(n)return n[2]||((e=n[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}updateContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];e.forEach(n=>{var r;let o=((r=n.textContent)==null?void 0:r.replace("@",""))||"";o&&s.push(o)}),this.frontmatter.contexts=s}getActiveContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];return e.forEach(n=>{var r;let o=((r=n.textContent)==null?void 0:r.replace("@",""))||"";o&&s.push(o)}),s}async saveChanges(){this.frontmatter.dateModified=new Date().toISOString();let t=this.plugin.rebuildContent(this.frontmatter,this.body);if(this.isCreateMode)await this.app.vault.create(this.taskPath,t),new u.Notice("Action created");else{let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof u.TFile)){new u.Notice("Error: Task file not found");return}await this.app.vault.modify(e,t),new u.Notice("Task updated")}this.didSave=!0,this.close()}onClose(){let{contentEl:t}=this;t.empty(),this.didSave&&this.plugin.refreshDataview()}},St=class extends u.Plugin{async onload(){console.log("Loading Minimal Tasks plugin"),await this.loadSettings(),window.MinimalTasks={renderTask:this.renderTask.bind(this),renderTaskList:this.renderTaskList.bind(this),settings:this.settings},this.registerDomEvent(document,"click",this.handleClick.bind(this)),this.registerDomEvent(document,"contextmenu",this.handleContextMenu.bind(this)),this.addSettingTab(new Yt(this.app,this)),this.settings.enableConvertIcon&&this.registerEditorExtension(ve(this)),this.registerEditorExtension(ye(this)),this.registerMarkdownPostProcessor((t,e)=>{this.processActionLinks(t,e)}),this.addRibbonIcon("plus-circle","New Action",async()=>{await this.createNewAction()}),this.addCommand({id:"new-action",name:"Create new action",callback:async()=>{await this.createNewAction()}}),this.addCommand({id:"new-action-from-context",name:"Create new action from current note",callback:async()=>{await this.createNewActionFromContext()}}),this.addCommand({id:"edit-action",name:"Edit current action",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return e&&e.path.startsWith("gtd/actions/")?(t||new lt(this.app,this,e.path).open(),!0):!1}})}async createNewAction(t){try{let n=`gtd/actions/${`${rt()}.md`}`,o=new Date().toISOString(),r={type:"action",title:"",status:"open",priority:"anytime",dateCreated:o,dateModified:o,tags:[],contexts:t!=null&&t.context?[t.context]:[],projects:t!=null&&t.project?[`"[[${t.project}]]"`]:[],area:t!=null&&t.area?`"[[gtd/areas/${t.area}|${t.area}]]"`:'""'};new lt(this.app,this,n,r,t==null?void 0:t.body).open()}catch(e){console.error("Error creating action:",e),new u.Notice("Error creating action: "+e.message)}}async createNewActionFromContext(){var o,r,a;let t=this.app.workspace.getActiveFile();if(!t){await this.createNewAction();return}let e=this.app.metadataCache.getFileCache(t),s=(o=e==null?void 0:e.frontmatter)==null?void 0:o.type,n={};if(s==="project")n.project=t.path;else if(s==="event"||s==="meeting"){let c=(r=e==null?void 0:e.frontmatter)==null?void 0:r.project;if(c){let h=String(c).match(/\[\[([^\]|]+)/);if(h){let p=(a=h[1].split("/").pop())==null?void 0:a.replace(/\.md$/,""),m=this.app.vault.getMarkdownFiles().find(w=>w.basename===p&&w.path.startsWith("gtd/projects/"));m&&(n.project=m.path)}}}else t.path.startsWith("gtd/areas/")&&(n.area=t.basename);if(s==="checklist-template"||s==="checklist"){let c=await this.app.vault.read(t),p=Z(c).body.replace(/```dataviewjs\s*\n[\s\S]*?\n```\s*/g,"").replace(/---\s*$/g,"").trim();if(p){let m=`From: [[${t.path.replace(/\.md$/,"")}]]`;n.body=`${m}

${p}`}}await this.createNewAction(n)}async loadSettings(){this.settings=Object.assign({},At,await this.loadData())}async saveSettings(){await this.saveData(this.settings),window.MinimalTasks&&(window.MinimalTasks.settings=this.settings)}async renderTaskList(t,e,s={}){let n=Array.isArray(e)?e:e.array(),o=await Promise.all(n.map(async c=>({task:c,hasNotes:await this.hasNoteContent(c.file),enrichedTask:await this.enrichTaskData(t,c)})));return this.sortTasks(o).map(c=>this.renderTask(c.enrichedTask,{...s,hasNotes:c.hasNotes})).join("<br>")}async enrichTaskData(t,e){let n=e[this.settings.titleField]||e.file.name.replace(/\.md$/,""),o=`<a data-href="${e.file.path}" href="${e.file.path}" class="internal-link" target="_blank" rel="noopener">${n}</a>`,r,a=e[this.settings.projectField];return a&&a.length>0&&(r=a.map(c=>{var b;let h=typeof c=="string"?c:String(c),p=h.match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(!p)return{link:h};let m=p[1],w=p[2]||((b=m.split("/").pop())==null?void 0:b.replace(/\.md$/,""))||m,k=`<a data-href="${m}" href="${m}" class="internal-link" target="_blank" rel="noopener">${w}</a>`,D=t.page(m);if(!D)return{link:k};if(D[this.settings.dueField]){let x=t.date(D[this.settings.dueField]),T=t.date("today"),P=x.toFormat("MMM dd");return{link:k,due:D[this.settings.dueField],dueFormatted:P,overdue:x<T}}return{link:k}})),{status:e[this.settings.statusField],priority:e[this.settings.priorityField],link:o,file:{path:e.file.path},contexts:e[this.settings.contextsField],"discuss-with":e[this.settings.discussWithField],"discuss-during":e[this.settings.discussDuringField],store:e[this.settings.storeField],due:e[this.settings.dueField],scheduled:e[this.settings.scheduledField],rrule:e[this.settings.rruleField],projects:a,projectsWithMeta:r}}async hasNoteContent(t){var e;try{let s=t.path||((e=t.file)==null?void 0:e.path);if(!s)return!1;let n=this.app.vault.getAbstractFileByPath(s);if(!n||!(n instanceof u.TFile))return!1;let o=await this.app.vault.read(n),r=/^---\n[\s\S]*?\n---\n/,a=o.replace(r,"").trim();if(this.settings.noteContentIgnorePattern)try{let c=new RegExp(this.settings.noteContentIgnorePattern);a=a.replace(c,"").trim()}catch(c){console.error("Invalid noteContentIgnorePattern regex:",c)}return a.length>0}catch(s){return!1}}getEffectiveDueDate(t){var o;let e=t.task[this.settings.dueField],s=((o=t.enrichedTask.projectsWithMeta)==null?void 0:o.map(r=>r.due).filter(Boolean))||[],n=[e,...s].filter(Boolean);return n.length===0?null:n.sort()[0]}sortTasks(t){return t.sort((e,s)=>{let n=this.settings.statusField,o=this.settings.priorityField,r=e.task[n]==="in-progress",a=s.task[n]==="in-progress";if(r&&!a)return-1;if(!r&&a)return 1;let c=e.task[o]==="today",h=s.task[o]==="today";if(c&&!h)return-1;if(!c&&h)return 1;let p=this.getEffectiveDueDate(e),m=this.getEffectiveDueDate(s);if(p&&!m)return-1;if(!p&&m)return 1;if(p&&m){if(p<m)return-1;if(p>m)return 1}return e.task.file.ctime-s.task.file.ctime})}renderTask(t,e={}){let{hasNotes:s=!1,showProjects:n=!0,showContexts:o=!1,excludePills:r=[]}=e,a;if(t.file&&t.file.path)a=t.file.path;else if(t.path)a=t.path;else return console.error("MinimalTasks: No path found in task object",t),"Error: No task path";let c=t[this.settings.statusField]||"none",h=t[this.settings.priorityField]||"anytime",p=c==="done"||c==="dropped",m=this.createControls(h,c,a),w=this.createContent(t,s,p,o,r,a),k=this.createMainLine(m,w),D=this.createProjectsSection(t,n);return`<div class="minimal-task-row" data-task-path="${a}" data-status="${c}" data-priority="${h}">${k}${D}</div>`}createControls(t,e,s){return`<div class="minimal-task-controls">${this.renderPriorityBadge(t,s)}${this.renderStatusDot(e,s)}</div>`}createContent(t,e,s,n,o,r){let a=this.createTitle(t,s),c=`<span class="minimal-task-edit-icon" data-task-path="${r}" title="Edit task">\u22EF</span>`,h=e&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",p=this.createMetadata(t,n,o);return`<div class="minimal-task-content">${`<span class="minimal-task-title-group">${a}${h}${c}</span>`}${p}</div>`}createTitle(t,e){let s=t.link||"Untitled";return`<span class="minimal-task-title${e?" is-completed":""}">${s}</span>`}createMetadata(t,e,s){let n=[],o=this.renderDateBadges(t);o&&n.push(o);let r=t[this.settings.rruleField];r&&!s.includes("recurrence")&&n.push(this.renderRecurrencePill(r));let a=t[this.settings.contextsField]||[];e&&a.length>0&&!s.includes("contexts")&&n.push(this.renderContextPills(a));let c=t[this.settings.discussWithField];c&&!s.includes("person")&&n.push(this.renderDiscussWithPills(c));let h=t[this.settings.discussDuringField];h&&!s.includes("meeting")&&n.push(this.renderDiscussDuringPills(h));let p=t[this.settings.storeField];return p&&!s.includes("store")&&n.push(this.renderStorePill(p)),n.length===0?"":`<span class="minimal-task-metadata">${n.join("")}</span>`}createMainLine(t,e){return`<div class="minimal-task-main">${t}${e}</div>`}createProjectsSection(t,e){if(!this.settings.showProjects||!e)return"";let s=t[this.settings.projectField]||[];return s.length===0?"":`<div class="minimal-task-projects">${(t.projectsWithMeta||s).map(r=>this.createProjectItem(r)).join("")}</div>`}createProjectItem(t){let e="";if(t.link){let s=t;if(e=s.link,this.settings.showProjectDueDates&&s.due){let n=s.dueFormatted||s.due,o=s.overdue?" is-overdue":"";e+=` <span class="minimal-badge minimal-badge-date${o}">\u{1F4C5} ${n}</span>`}}else e=typeof t=="string"?t:String(t);return`<div class="minimal-task-project">${e}</div>`}renderStatusDot(t,e){return`<span class="task-status-dot" data-status="${t}" data-task-path="${e}" title="Status: ${t} (click to cycle)"></span>`}renderPriorityBadge(t,e){let s=this.getPriorityIcon(t);return`<span class="task-priority-badge" data-priority="${t}" data-task-path="${e}" title="Priority: ${t} (click to cycle)">${s}</span>`}renderContextPills(t){return(Array.isArray(t)?t:[t]).map(e=>`<span class="minimal-badge minimal-badge-context">@${e}</span>`).join("")}renderDiscussWithPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=ot(e),n=kt(e);return n?`<span class="minimal-badge minimal-badge-person"><a class="internal-link" data-href="${n}" href="${n}" target="_blank" rel="noopener">\u{1F464}${s}</a></span>`:`<span class="minimal-badge minimal-badge-person">\u{1F464}${s}</span>`}).join("")}renderDiscussDuringPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=ot(e);return`<span class="minimal-badge minimal-badge-meeting">\u{1F4C5}${Ct(s)}</span>`}).join("")}renderStorePill(t){return`<span class="minimal-badge minimal-badge-store">\u{1F3EA}${t}</span>`}renderRecurrencePill(t){return`<span class="minimal-badge minimal-badge-recurrence">\u{1F501} ${jt(t)}</span>`}renderInlineTaskHTML(t,e,s,n){let o=t[this.settings.statusField]||"open",r=t[this.settings.priorityField]||"anytime",a=t[this.settings.titleField]||s,c=o==="done"||o==="dropped",h=e.replace(".md",""),p=this.renderPriorityBadge(r,e),m=this.renderStatusDot(o,e),k=`<a class="internal-link${c?" is-completed":""}" data-href="${h}" href="${h}">${it(a)}</a>`,D=n&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u203A</span>':"",b=`<span class="minimal-task-edit-icon" data-task-path="${e}" title="Edit task">\u22EF</span>`,x=[],T=t[this.settings.scheduledField];T&&x.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${T}</span>`);let P=t[this.settings.dueField];if(P){let q=new Date(P)<new Date(new Date().toDateString())?" is-overdue":"";x.push(`<span class="minimal-badge minimal-badge-date${q}">\u{1F4C5} ${P}</span>`)}let M=t[this.settings.rruleField];M&&x.push(this.renderRecurrencePill(M));let B=t[this.settings.contextsField]||[];B.length>0&&x.push(this.renderContextPills(B));let W=t[this.settings.projectField]||[];W.length>0&&x.push(this.renderProjectPills(W));let C=x.length>0?` <span class="minimal-task-metadata">${x.join("")}</span>`:"",tt=`<span class="minimal-task-title-group">${k}${D}${b}</span>`;return`${p}${m} ${tt}${C}`}renderProjectPills(t){return(Array.isArray(t)?t:[t]).filter(e=>e).map(e=>{let s=ot(e),n=kt(e);return n?`<span class="minimal-badge minimal-badge-project"><a class="internal-link" data-href="${n}" href="${n}">\u{1F4C1} ${it(s)}</a></span>`:`<span class="minimal-badge minimal-badge-project">\u{1F4C1} ${it(s)}</span>`}).join("")}createInlineTaskElement(t,e,s,n){let o=this.renderInlineTaskHTML(t,e,s,n);return new DOMParser().parseFromString(`<span class="minimal-task-inline">${o}</span>`,"text/html").body.firstChild}renderDateBadges(t){let e=[],s=t[this.settings.dueField],n=t[this.settings.scheduledField];if(n){let o=new Date(n);o.setHours(0,0,0,0);let r=vt(o);e.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${r}</span>`)}if(s){let o=new Date(s);o.setHours(0,0,0,0);let r=new Date;r.setHours(0,0,0,0);let a=o<r,c=vt(o),h=a?"\u26A0\uFE0F":"\u{1F4C5}",p=a?" is-overdue":"";e.push(`<span class="minimal-badge minimal-badge-date${p}">${h} ${c}</span>`)}return e.join("")}getPriorityIcon(t){return{today:"\u2B50",someday:"\u{1F4AD}",anytime:"\u2022"}[t]||"\u2022"}async handleClick(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),await this.cycleStatus(e);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),await this.cyclePriority(e);return}if(e.classList.contains("minimal-task-edit-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskPath;s&&new lt(this.app,this,s).open();return}if(e.classList.contains("minimal-tasks-convert-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskText,n=e.dataset.sourcePath;s&&n&&await this.convertToActionFromReading(s,n);return}}handleContextMenu(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),this.showStatusMenu(e,t);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),this.showPriorityMenu(e,t);return}}showStatusMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.status;if(!s)return;let o=new u.Menu;[{value:"none",label:"\u26AA None",icon:"\u26AA"},{value:"open",label:"\u{1F535} Open",icon:"\u{1F535}"},{value:"in-progress",label:"\u{1F7E1} In Progress",icon:"\u{1F7E1}"},{value:"done",label:"\u2705 Done",icon:"\u2705"},{value:"dropped",label:"\u{1F534} Dropped",icon:"\u{1F534}"}].forEach(a=>{o.addItem(c=>{c.setTitle(a.label+(n===a.value?" \u2713":"")).onClick(async()=>{await this.setStatus(t,s,a.value)})})}),o.showAtMouseEvent(e)}showPriorityMenu(t,e){let s=t.dataset.taskPath,n=t.dataset.priority;if(!s)return;let o=new u.Menu;[{value:"anytime",label:"\u2022 Anytime",icon:"\u2022"},{value:"today",label:"\u2B50 Today",icon:"\u2B50"},{value:"someday",label:"\u{1F4AD} Someday",icon:"\u{1F4AD}"}].forEach(a=>{o.addItem(c=>{c.setTitle(a.label+(n===a.value?" \u2713":"")).onClick(async()=>{await this.setPriority(t,s,a.value)})})}),o.showAtMouseEvent(e)}async setStatus(t,e,s){try{await this.updateTaskField(e,"status",s);let n=t.closest(".minimal-task-row");n&&n.setAttribute("data-status",s),t.dataset.status=s;let o=n==null?void 0:n.querySelector(".minimal-task-title");o&&(s==="done"||s==="dropped"?o.classList.add("is-completed"):o.classList.remove("is-completed"));let r={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new u.Notice(r[s]||s)}catch(n){console.error("Error setting status:",n),new u.Notice("Error updating task status")}}async setPriority(t,e,s){try{await this.updateTaskField(e,"priority",s),t.dataset.priority=s,t.textContent=this.getPriorityIcon(s);let n={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new u.Notice(n[s]||s)}catch(n){console.error("Error setting priority:",n),new u.Notice("Error updating task priority")}}async cycleStatus(t){let e=t.dataset.taskPath,s=t.dataset.status;if(!e)return;let n=["none","open","in-progress","done","dropped"],o=n.indexOf(s||"none"),r=n[(o+1)%n.length];try{await this.updateTaskField(e,"status",r);let a=t.closest(".minimal-task-row");a&&a.setAttribute("data-status",r),t.dataset.status=r;let c=a==null?void 0:a.querySelector(".minimal-task-title");c&&(r==="done"||r==="dropped"?c.classList.add("is-completed"):c.classList.remove("is-completed"));let h={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new u.Notice(h[r]||r)}catch(a){console.error("Error cycling status:",a),new u.Notice("Error updating task status")}}async cyclePriority(t){let e=t.dataset.taskPath,s=t.dataset.priority;if(!e)return;let n=["anytime","today","someday"],o=n.indexOf(s||"anytime"),r=n[(o+1)%n.length];try{await this.updateTaskField(e,"priority",r),t.dataset.priority=r,t.textContent=this.getPriorityIcon(r);let a={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new u.Notice(a[r]||r)}catch(a){console.error("Error cycling priority:",a),new u.Notice("Error updating task priority")}}async updateTaskField(t,e,s){let n=this.app.vault.getAbstractFileByPath(t);if(!n||!(n instanceof u.TFile))throw new Error(`Task file not found: ${t}`);let o=await this.app.vault.read(n),{frontmatter:r,body:a}=Z(o);r.rrule&&String(r.rrule).trim().length>0&&(e==="status"&&s==="done")&&await this.createNextRecurringInstance(r,a),r[e]=s,e==="status"&&s==="done"&&!r.completedDate&&(r.completedDate=new Date().toISOString().split("T")[0]),e==="status"&&s!=="done"&&r.completedDate&&delete r.completedDate;let p=ct(r,a);await this.app.vault.modify(n,p)}async createNextRecurringInstance(t,e){try{new u.Notice("\u{1F501} Creating next instance...",2e3);let s=String(t.rrule).replace(/^["']|["']$/g,""),n=new Date().toISOString().split("T")[0],o=It(s,n),r=new Date,p=`gtd/actions/${`${r.toISOString().replace(/[:.]/g,"-").replace("T","-").split("-").slice(0,6).join("").replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1$2$3-$4$5$6")}.md`}`,m=r.toISOString(),w={status:"open",priority:t.priority||"anytime",dateCreated:m,dateModified:m,tags:t.tags||"[]",type:"action",title:t.title||"",contexts:t.contexts||[],area:t.area||'""',scheduled:o,rrule:`"${s}"`};if(t.projects&&(w.projects=t.projects),t.due&&t.scheduled){let D=new Date(t.scheduled),x=new Date(t.due).getTime()-D.getTime(),T=new Date(new Date(o).getTime()+x);w.due=T.toISOString().split("T")[0]}else t.due&&(w.due=t.due);t.recurrence_start&&(w.recurrence_start=t.recurrence_start),t.store&&(w.store=t.store),t["discuss-with"]&&(w["discuss-with"]=t["discuss-with"]),t["discuss-during"]&&(w["discuss-during"]=t["discuss-during"]);let k=ct(w,e);await this.app.vault.create(p,k),new u.Notice(`\u2705 Completed! Next: ${o}`,3e3)}catch(s){console.error("Failed to create recurring task instance:",s),new u.Notice("\u26A0\uFE0F Failed to create next instance: "+s.message,5e3)}}refreshDataview(){setTimeout(()=>{try{this.app.commands.executeCommandById("dataview:dataview-rebuild-current-view")}catch(t){this.app.metadataCache.trigger("changed")}},100)}processActionLinks(t,e){var n;let s=t.querySelectorAll("li.task-list-item");for(let o of Array.from(s)){let r=o.querySelectorAll("a.internal-link"),a=!1;for(let c of Array.from(r)){let p=(c.getAttribute("data-href")||"").match(/^(gtd\/actions\/)?(\d{8}-\d{6})$/);if(!p)continue;a=!0;let m=`gtd/actions/${p[2]}.md`,w=c.textContent||p[2],k=this.app.vault.getAbstractFileByPath(m);if(!(k instanceof u.TFile))continue;let D=this.app.metadataCache.getFileCache(k),b=(D==null?void 0:D.frontmatter)||{},x=(n=D==null?void 0:D.sections)==null?void 0:n.some(M=>M.type==="paragraph"||M.type==="list"||M.type==="heading"),T=this.createInlineTaskElement(b,m,w,x||!1);c.replaceWith(T);let P=o.querySelector('input[type="checkbox"]');P&&(P.style.display="none")}if(!a){if(!o.querySelector('input[type="checkbox"]'))continue;let h=this.getTaskTextFromListItem(o);if(!h||h.trim()==="")continue;let p=document.createElement("span");p.className="minimal-tasks-convert-icon",p.textContent="\u2795",p.setAttribute("data-task-text",h),p.setAttribute("data-source-path",e.sourcePath),o.appendChild(p)}}}getTaskTextFromListItem(t){var o;let e=t.cloneNode(!0),s=e.querySelector('input[type="checkbox"]');s&&s.remove();let n=e.querySelector(".minimal-tasks-convert-icon");return n&&n.remove(),((o=e.textContent)==null?void 0:o.trim())||""}async convertToAction(t,e,s,n){try{let o=await this.detectNoteContext(),r=rt(),c=`gtd/actions/${`${r}.md`}`,h=this.buildConvertFrontmatter(t,o),p=this.app.workspace.getActiveFile(),m=p==null?void 0:p.path,w=this.buildActionContent(h,m);await this.app.vault.create(c,w);let k=`- [ ] [[${r}|${t}]]`;n.dispatch({changes:{from:e,to:s,insert:k}}),new u.Notice(`Created action: ${t}`)}catch(o){console.error("Error converting task:",o),new u.Notice("Error converting task: "+o.message)}}async convertToActionFromReading(t,e){var s;try{let n=this.app.vault.getAbstractFileByPath(e);if(!(n instanceof u.TFile)){new u.Notice("Source file not found");return}let o=await this.app.vault.read(n),{frontmatter:r}=Z(o),a={};e.startsWith("gtd/projects/")&&!e.includes("archive")?a={projects:[`[[${((s=e.split("/").pop())==null?void 0:s.replace(".md",""))||""}]]`]}:r.type==="event"&&r.project?a={projects:[r.project]}:r.area&&(a={area:r.area});let c=rt(),p=`gtd/actions/${`${c}.md`}`,m=this.buildConvertFrontmatter(t,a),w=this.buildActionContent(m,e);await this.app.vault.create(p,w);let k=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),D=new RegExp(`^(\\s*)- \\[[ x]\\] ${k}$`,"m"),b=o.replace(D,`$1- [ ] [[${c}|${t}]]`);b!==o?(await this.app.vault.modify(n,b),new u.Notice(`Created action: ${t}`)):new u.Notice("Could not find task in source file")}catch(n){console.error("Error converting task:",n),new u.Notice("Error converting task: "+n.message)}}async detectNoteContext(){let t=this.app.workspace.getActiveFile();if(!t)return{};let e=await this.app.vault.read(t),{frontmatter:s}=Z(e);return t.path.startsWith("gtd/projects/")&&!t.path.includes("archive")?{projects:[`[[${t.basename}]]`]}:s.type==="event"&&s.project?{projects:[s.project]}:s.area?{area:s.area}:{}}buildConvertFrontmatter(t,e){let s=new Date().toISOString(),n={type:"action",title:t,status:"open",priority:"anytime",dateCreated:s,dateModified:s,tags:[],contexts:[]},o=(e.projects||[]).filter(r=>r?(typeof r=="string"?r:String(r)).trim().length>0:!1);return o.length>0?(n.projects=o,n.area='""'):e.area&&e.area.trim()&&e.area!=='""'?(n.projects=[],n.area=e.area):(n.projects=[],n.area='""'),n}buildActionContent(t,e){let s='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n';if(e){let n=e.replace(".md","");s+=`
Created from [[${n}]]
`}return ct(t,s)}onunload(){console.log("Unloading Minimal Tasks plugin"),delete window.MinimalTasks}},Yt=class extends u.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Minimal Tasks Settings"}),t.createEl("h3",{text:"Frontmatter Field Names"}),t.createEl("p",{text:"Customize which frontmatter fields are used for task metadata.",cls:"setting-item-description"}),new u.Setting(t).setName("Status field").setDesc("Frontmatter field for task status").addText(e=>e.setPlaceholder("status").setValue(this.plugin.settings.statusField).onChange(async s=>{this.plugin.settings.statusField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Priority field").setDesc("Frontmatter field for task priority").addText(e=>e.setPlaceholder("priority").setValue(this.plugin.settings.priorityField).onChange(async s=>{this.plugin.settings.priorityField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Projects field").setDesc("Frontmatter field for project links (array)").addText(e=>e.setPlaceholder("projects").setValue(this.plugin.settings.projectField).onChange(async s=>{this.plugin.settings.projectField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Contexts field").setDesc("Frontmatter field for contexts (array)").addText(e=>e.setPlaceholder("contexts").setValue(this.plugin.settings.contextsField).onChange(async s=>{this.plugin.settings.contextsField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Due date field").setDesc("Frontmatter field for due date").addText(e=>e.setPlaceholder("due").setValue(this.plugin.settings.dueField).onChange(async s=>{this.plugin.settings.dueField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Scheduled field").setDesc("Frontmatter field for scheduled date").addText(e=>e.setPlaceholder("scheduled").setValue(this.plugin.settings.scheduledField).onChange(async s=>{this.plugin.settings.scheduledField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Discuss-with field").setDesc("Frontmatter field for people to discuss with (array)").addText(e=>e.setPlaceholder("discuss-with").setValue(this.plugin.settings.discussWithField).onChange(async s=>{this.plugin.settings.discussWithField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Discuss-during field").setDesc("Frontmatter field for meetings to discuss during (array)").addText(e=>e.setPlaceholder("discuss-during").setValue(this.plugin.settings.discussDuringField).onChange(async s=>{this.plugin.settings.discussDuringField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Store field").setDesc("Frontmatter field for store/location (errands)").addText(e=>e.setPlaceholder("store").setValue(this.plugin.settings.storeField).onChange(async s=>{this.plugin.settings.storeField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Area field").setDesc("Frontmatter field for area/category").addText(e=>e.setPlaceholder("area").setValue(this.plugin.settings.areaField).onChange(async s=>{this.plugin.settings.areaField=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Title field").setDesc("Frontmatter field for task title").addText(e=>e.setPlaceholder("title").setValue(this.plugin.settings.titleField).onChange(async s=>{this.plugin.settings.titleField=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Display Options"}),new u.Setting(t).setName("Show projects").setDesc("Display project links below tasks").addToggle(e=>e.setValue(this.plugin.settings.showProjects).onChange(async s=>{this.plugin.settings.showProjects=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Show project due dates").setDesc("Show due date warnings for projects").addToggle(e=>e.setValue(this.plugin.settings.showProjectDueDates).onChange(async s=>{this.plugin.settings.showProjectDueDates=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Show note icon").setDesc("Show \u2630 icon for tasks with content").addToggle(e=>e.setValue(this.plugin.settings.showNoteIcon).onChange(async s=>{this.plugin.settings.showNoteIcon=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Enable convert icon").setDesc("Show a convert icon at the end of markdown task lines in edit mode. Click to convert to an action file. Requires restart to take effect.").addToggle(e=>e.setValue(this.plugin.settings.enableConvertIcon).onChange(async s=>{this.plugin.settings.enableConvertIcon=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Note content ignore pattern").setDesc("Regex pattern to ignore when detecting note content. Useful for stripping boilerplate code blocks like ribbons. Leave empty to disable.").addTextArea(e=>e.setPlaceholder('^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*').setValue(this.plugin.settings.noteContentIgnorePattern).onChange(async s=>{this.plugin.settings.noteContentIgnorePattern=s,await this.plugin.saveSettings()}))}};
