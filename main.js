/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var gt=Object.getOwnPropertyNames;var pt=Object.prototype.hasOwnProperty;var ht=(y,h)=>{for(var t in h)L(y,t,{get:h[t],enumerable:!0})},mt=(y,h,t,e)=>{if(h&&typeof h=="object"||typeof h=="function")for(let s of gt(h))!pt.call(y,s)&&s!==t&&L(y,s,{get:()=>h[s],enumerable:!(e=ut(h,s))||e.enumerable});return y};var ft=y=>mt(L({},"__esModule",{value:!0}),y);var wt={};ht(wt,{default:()=>A});module.exports=ft(wt);var d=require("obsidian"),P=require("@codemirror/view"),yt={projectField:"projects",dueField:"due",scheduledField:"scheduled",contextsField:"contexts",discussWithField:"discuss-with",discussDuringField:"discuss-during",storeField:"store",areaField:"area",titleField:"title",statusField:"status",priorityField:"priority",rruleField:"rrule",showProjects:!0,showProjectDueDates:!0,showNoteIcon:!0,showContextPills:!1,noteContentIgnorePattern:'^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*',enableConvertIcon:!0,statuses:["none","open","in-progress","done","dropped"],priorities:["anytime","today","someday"]},R=class extends P.WidgetType{constructor(t,e,s,i){super();this.plugin=t;this.taskText=e;this.lineFrom=s;this.lineTo=i}toDOM(t){let e=document.createElement("span");return e.className="minimal-tasks-convert-icon",e.textContent="\u2795",e.title="Convert to action",e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.plugin.convertToAction(this.taskText,this.lineFrom,this.lineTo,t)}),e}eq(t){return this.taskText===t.taskText&&this.lineFrom===t.lineFrom}};function vt(y){return P.ViewPlugin.fromClass(class{constructor(h){this.decorations=this.buildDecorations(h)}update(h){(h.docChanged||h.viewportChanged)&&(this.decorations=this.buildDecorations(h.view))}buildDecorations(h){let t=[],e=/^(\s*)- \[ \] (.+)$/;for(let{from:s,to:i}of h.visibleRanges)for(let a=s;a<=i;){let n=h.state.doc.lineAt(a),c=n.text.match(e);if(c&&c[2]){let o=P.Decoration.widget({widget:new R(y,c[2],n.from,n.to),side:1});t.push(o.range(n.to))}a=n.to+1}return P.Decoration.set(t,!0)}},{decorations:h=>h.decorations})}var O=class extends d.Modal{constructor(t,e,s){super(t);this.frontmatter={};this.body="";this.plugin=e,this.taskPath=s}async onOpen(){let{contentEl:t}=this;t.addClass("edit-task-modal");let e=this.app.vault.getAbstractFileByPath(this.taskPath);if(!e||!(e instanceof d.TFile)){t.createEl("p",{text:"Error: Task file not found"});return}let s=await this.app.vault.read(e),i=this.plugin.parseFrontmatter(s);this.frontmatter=i.frontmatter,this.body=i.body,this.buildForm()}buildForm(){let{contentEl:t}=this;t.empty();let s=t.createDiv({cls:"edit-task-title-container"}).createEl("input",{cls:"edit-task-title-input",attr:{type:"text",placeholder:"Task title...",value:String(this.frontmatter.title||"").replace(/^["']|["']$/g,"")}});s.addEventListener("change",()=>{this.frontmatter.title=s.value});let a=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),n=a.createDiv({cls:"edit-task-inline-group"});n.createSpan({cls:"edit-task-label",text:"Status"});let c=n.createDiv({cls:"edit-task-icon-group"}),o=[{value:"none",icon:"\u26AA"},{value:"open",icon:"\u{1F535}"},{value:"in-progress",icon:"\u{1F7E1}"},{value:"done",icon:"\u2705"},{value:"dropped",icon:"\u{1F534}"}],r=this.frontmatter.status||"none";o.forEach(l=>{let g=c.createSpan({cls:"edit-task-icon"+(r===l.value?" active":""),text:l.icon,attr:{title:l.value}});g.addEventListener("click",()=>{c.querySelectorAll(".edit-task-icon").forEach(S=>S.removeClass("active")),g.addClass("active"),this.frontmatter.status=l.value})});let u=a.createDiv({cls:"edit-task-inline-group"});u.createSpan({cls:"edit-task-label",text:"Priority"});let p=u.createDiv({cls:"edit-task-icon-group"}),m=[{value:"anytime",icon:"\u2022"},{value:"today",icon:"\u2B50"},{value:"someday",icon:"\u{1F4AD}"}],v=this.frontmatter.priority||"anytime";m.forEach(l=>{let g=p.createSpan({cls:"edit-task-icon"+(v===l.value?" active":""),text:l.icon,attr:{title:l.value}});g.addEventListener("click",()=>{p.querySelectorAll(".edit-task-icon").forEach(S=>S.removeClass("active")),g.addClass("active"),this.frontmatter.priority=l.value})});let k=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),b=k.createDiv({cls:"edit-task-inline-group"});b.createSpan({cls:"edit-task-label",text:"\u{1F4C5} Due"});let F=b.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:this.formatDateForInput(this.frontmatter.due)}});F.addEventListener("change",()=>{this.frontmatter.due=F.value||void 0,F.value||delete this.frontmatter.due});let T=k.createDiv({cls:"edit-task-inline-group"});T.createSpan({cls:"edit-task-label",text:"\u{1F5D3}\uFE0F Scheduled"});let f=T.createEl("input",{cls:"edit-task-date-input-small",attr:{type:"date",value:this.formatDateForInput(this.frontmatter.scheduled)}});f.addEventListener("change",()=>{this.frontmatter.scheduled=f.value||void 0,f.value||delete this.frontmatter.scheduled});let D=t.createDiv({cls:"edit-task-section"});D.createDiv({cls:"edit-task-section-label",text:"Contexts"});let I=D.createDiv({cls:"edit-task-contexts"}),nt=["focus","quick","relax","home","office","brf","school","errands","agenda","waiting"],at=this.getArrayField("contexts"),$,j,W=()=>{let l=this.getActiveContexts(I);$&&($.style.display=l.includes("agenda")?"":"none"),j&&(j.style.display=l.includes("errands")?"":"none")};nt.forEach(l=>{let g=I.createSpan({cls:"context-pill"+(at.includes(l)?" active":""),text:"@"+l});g.addEventListener("click",()=>{g.toggleClass("active",!g.hasClass("active")),this.updateContexts(I),W()})});let H=t.createDiv({cls:"edit-task-section"}).createDiv({cls:"edit-task-row-inline"}),B=H.createDiv({cls:"edit-task-inline-group"});B.createSpan({cls:"edit-task-label",text:"\u{1F4C2} Project"});let E=B.createEl("select",{cls:"edit-task-select-small"});E.createEl("option",{value:"",text:"(none)"});let V=this.app.vault.getMarkdownFiles().filter(l=>l.path.startsWith("gtd/projects/")&&!l.path.includes("archive")).sort((l,g)=>l.basename.localeCompare(g.basename)),rt=this.getProjectBasename();V.forEach(l=>{let g=E.createEl("option",{value:l.path,text:l.basename});l.basename===rt&&(g.selected=!0)}),E.addEventListener("change",()=>{if(E.value){let l=V.find(g=>g.path===E.value);l&&(this.frontmatter.projects=[`"[[${l.path}|${l.basename}]]"`])}else this.frontmatter.projects=[]});let U=H.createDiv({cls:"edit-task-inline-group"});U.createSpan({cls:"edit-task-label",text:"\u{1F5C2}\uFE0F Area"});let x=U.createEl("select",{cls:"edit-task-select-small"}),ot=["","Personal","Family","Social","Opper","Solv\xE4ndan","Garage"],ct=this.getAreaName();ot.forEach(l=>{let g=x.createEl("option",{value:l,text:l||"(none)"});l===ct&&(g.selected=!0)}),x.addEventListener("change",()=>{x.value?this.frontmatter.area=`"[[gtd/areas/${x.value}|${x.value}]]"`:this.frontmatter.area='""'}),$=t.createDiv({cls:"edit-task-section"});let q=$.createDiv({cls:"edit-task-row-inline"}),G=q.createDiv({cls:"edit-task-inline-group"});G.createSpan({cls:"edit-task-label",text:"\u{1F464} With"});let C=G.createEl("select",{cls:"edit-task-select-small"});C.createEl("option",{value:"",text:"(none)"});let _=this.app.vault.getMarkdownFiles().filter(l=>l.path.startsWith("notes/person/")).sort((l,g)=>l.basename.localeCompare(g.basename)),lt=this.getDiscussWithBasename();_.forEach(l=>{let g=C.createEl("option",{value:l.path,text:l.basename});l.basename===lt&&(g.selected=!0)}),C.addEventListener("change",()=>{if(C.value){let l=_.find(g=>g.path===C.value);l&&(this.frontmatter["discuss-with"]=[`"[[${l.path}|${l.basename}]]"`])}else delete this.frontmatter["discuss-with"]});let J=q.createDiv({cls:"edit-task-inline-group"});J.createSpan({cls:"edit-task-label",text:"\u{1F4C5} During"});let M=J.createEl("select",{cls:"edit-task-select-small"});M.createEl("option",{value:"",text:"(none)"});let K=this.app.vault.getMarkdownFiles().filter(l=>l.path.startsWith("events/")).sort((l,g)=>g.basename.localeCompare(l.basename)).slice(0,50),Q=this.getDiscussDuringBasename();K.forEach(l=>{let g=l.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,""),S=M.createEl("option",{value:l.path,text:g});(l.basename===Q||g===Q)&&(S.selected=!0)}),M.addEventListener("change",()=>{if(M.value){let l=K.find(g=>g.path===M.value);if(l){let g=l.basename.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"");this.frontmatter["discuss-during"]=[`"[[${l.path}|${g}]]"`]}}else delete this.frontmatter["discuss-during"]}),j=t.createDiv({cls:"edit-task-section"});let z=j.createDiv({cls:"edit-task-row-inline"}),X=z.createDiv({cls:"edit-task-inline-group"});X.createSpan({cls:"edit-task-label",text:"\u{1F3EA} Store"});let N=X.createEl("input",{cls:"edit-task-input-small",attr:{type:"text",placeholder:"Type or select...",list:"store-suggestions",value:String(this.frontmatter.store||"").replace(/^["']|["']$/g,"")}}),dt=z.createEl("datalist",{attr:{id:"store-suggestions"}}),Z=new Set;this.app.vault.getMarkdownFiles().filter(l=>l.path.startsWith("gtd/actions/")).forEach(l=>{var st;let g=this.app.metadataCache.getFileCache(l),S=(st=g==null?void 0:g.frontmatter)==null?void 0:st.store;if(S){let it=String(S).replace(/^["']|["']$/g,"");it&&Z.add(it)}}),Array.from(Z).sort().forEach(l=>{dt.createEl("option",{value:l})}),N.addEventListener("change",()=>{N.value?this.frontmatter.store=N.value:delete this.frontmatter.store}),W();let tt=t.createDiv({cls:"edit-task-button-row"}),et=tt.createEl("button",{cls:"edit-task-delete",text:"\u{1F5D1}\uFE0F"});et.setAttribute("title","Delete task"),et.addEventListener("click",()=>this.deleteTask()),tt.createEl("button",{cls:"edit-task-save",text:"Save Changes"}).addEventListener("click",()=>this.saveChanges())}async deleteTask(){let t=this.app.vault.getAbstractFileByPath(this.taskPath);if(!t||!(t instanceof d.TFile)){new d.Notice("Error: Task file not found");return}confirm(`Delete "${this.frontmatter.title||t.basename}"?`)&&(await this.app.vault.delete(t),new d.Notice("Task deleted"),this.close())}formatDateForInput(t){if(!t)return"";let e=String(t).replace(/^["']|["']$/g,"");return e.length>=10?e.substring(0,10):""}getArrayField(t){let e=this.frontmatter[t];return Array.isArray(e)?e.map(s=>String(s).replace(/^["']|["']$/g,"")):[]}getProjectBasename(){var e;let t=this.frontmatter.projects;if(Array.isArray(t)&&t.length>0){let i=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(i)return i[2]||((e=i[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getAreaName(){let t=this.frontmatter.area;if(!t)return"";let s=String(t).replace(/^["']|["']$/g,"").match(/\|([^\]]+)\]\]/);return s?s[1]:""}getDiscussWithBasename(){var e;let t=this.frontmatter["discuss-with"];if(Array.isArray(t)&&t.length>0){let i=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(i)return i[2]||((e=i[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}getDiscussDuringBasename(){var e;let t=this.frontmatter["discuss-during"];if(Array.isArray(t)&&t.length>0){let i=String(t[0]).match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(i)return i[2]||((e=i[1].split("/").pop())==null?void 0:e.replace(/\.md$/,""))||""}return""}updateContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];e.forEach(i=>{var n;let a=((n=i.textContent)==null?void 0:n.replace("@",""))||"";a&&s.push(a)}),this.frontmatter.contexts=s}getActiveContexts(t){let e=t.querySelectorAll(".context-pill.active"),s=[];return e.forEach(i=>{var n;let a=((n=i.textContent)==null?void 0:n.replace("@",""))||"";a&&s.push(a)}),s}async saveChanges(){let t=this.app.vault.getAbstractFileByPath(this.taskPath);if(!t||!(t instanceof d.TFile)){new d.Notice("Error: Task file not found");return}this.frontmatter.dateModified=new Date().toISOString();let e=this.plugin.rebuildContent(this.frontmatter,this.body);await this.app.vault.modify(t,e),this.plugin.refreshDataview(),new d.Notice("Task updated"),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},A=class extends d.Plugin{async onload(){console.log("Loading Minimal Tasks plugin"),await this.loadSettings(),window.MinimalTasks={renderTask:this.renderTask.bind(this),renderTaskList:this.renderTaskList.bind(this),settings:this.settings},this.registerDomEvent(document,"click",this.handleClick.bind(this)),this.registerDomEvent(document,"contextmenu",this.handleContextMenu.bind(this)),this.addSettingTab(new Y(this.app,this)),this.settings.enableConvertIcon&&this.registerEditorExtension(vt(this))}async loadSettings(){this.settings=Object.assign({},yt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),window.MinimalTasks&&(window.MinimalTasks.settings=this.settings)}async renderTaskList(t,e,s={}){let i=Array.isArray(e)?e:e.array(),a=await Promise.all(i.map(async o=>({task:o,hasNotes:await this.hasNoteContent(o.file),enrichedTask:await this.enrichTaskData(t,o)})));return this.sortTasks(a).map(o=>this.renderTask(o.enrichedTask,{...s,hasNotes:o.hasNotes})).join("<br>")}async enrichTaskData(t,e){let i=e[this.settings.titleField]||e.file.name.replace(/\.md$/,""),a=`<a data-href="${e.file.path}" href="${e.file.path}" class="internal-link" target="_blank" rel="noopener">${i}</a>`,n,c=e[this.settings.projectField];return c&&c.length>0&&(n=c.map(o=>{var k;let r=typeof o=="string"?o:String(o),u=r.match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(!u)return{link:r};let p=u[1],m=u[2]||((k=p.split("/").pop())==null?void 0:k.replace(/\.md$/,""))||p,v=`<a data-href="${p}" href="${p}" class="internal-link" target="_blank" rel="noopener">${m}</a>`,w=t.page(p);if(!w)return{link:v};if(w[this.settings.dueField]){let b=t.date(w[this.settings.dueField]),F=t.date("today"),T=b.toFormat("MMM dd");return{link:v,due:w[this.settings.dueField],dueFormatted:T,overdue:b<F}}return{link:v}})),{status:e[this.settings.statusField],priority:e[this.settings.priorityField],link:a,file:{path:e.file.path},contexts:e[this.settings.contextsField],"discuss-with":e[this.settings.discussWithField],"discuss-during":e[this.settings.discussDuringField],store:e[this.settings.storeField],due:e[this.settings.dueField],scheduled:e[this.settings.scheduledField],rrule:e[this.settings.rruleField],projects:c,projectsWithMeta:n}}async hasNoteContent(t){var e;try{let s=t.path||((e=t.file)==null?void 0:e.path);if(!s)return!1;let i=this.app.vault.getAbstractFileByPath(s);if(!i||!(i instanceof d.TFile))return!1;let a=await this.app.vault.read(i),n=/^---\n[\s\S]*?\n---\n/,c=a.replace(n,"").trim();if(this.settings.noteContentIgnorePattern)try{let o=new RegExp(this.settings.noteContentIgnorePattern);c=c.replace(o,"").trim()}catch(o){console.error("Invalid noteContentIgnorePattern regex:",o)}return c.length>0}catch(s){return!1}}getEffectiveDueDate(t){var a;let e=t.task[this.settings.dueField],s=((a=t.enrichedTask.projectsWithMeta)==null?void 0:a.map(n=>n.due).filter(Boolean))||[],i=[e,...s].filter(Boolean);return i.length===0?null:i.sort()[0]}sortTasks(t){return t.sort((e,s)=>{let i=this.settings.statusField,a=this.settings.priorityField,n=e.task[i]==="in-progress",c=s.task[i]==="in-progress";if(n&&!c)return-1;if(!n&&c)return 1;let o=e.task[a]==="today",r=s.task[a]==="today";if(o&&!r)return-1;if(!o&&r)return 1;let u=this.getEffectiveDueDate(e),p=this.getEffectiveDueDate(s);if(u&&!p)return-1;if(!u&&p)return 1;if(u&&p){if(u<p)return-1;if(u>p)return 1}return e.task.file.ctime-s.task.file.ctime})}renderTask(t,e={}){let{hasNotes:s=!1,showProjects:i=!0,showContexts:a=!1,excludePills:n=[]}=e,c;if(t.file&&t.file.path)c=t.file.path;else if(t.path)c=t.path;else return console.error("MinimalTasks: No path found in task object",t),"Error: No task path";let o=t[this.settings.statusField]||"none",r=t[this.settings.priorityField]||"anytime",u=o==="done"||o==="dropped",p=this.createControls(r,o,c),m=this.createContent(t,s,u,a,n,c),v=this.createMainLine(p,m),w=this.createProjectsSection(t,i);return`<div class="minimal-task-row" data-task-path="${c}" data-status="${o}" data-priority="${r}">${v}${w}</div>`}createControls(t,e,s){return`<div class="minimal-task-controls">${this.renderPriorityBadge(t,s)}${this.renderStatusDot(e,s)}</div>`}createContent(t,e,s,i,a,n){let c=this.createTitle(t,s),o=`<span class="minimal-task-edit-icon" data-task-path="${n}" title="Edit task">\u270F\uFE0F</span>`,r=e&&this.settings.showNoteIcon?'<span class="minimal-task-note-icon">\u2630</span>':"",u=this.createMetadata(t,i,a);return`<div class="minimal-task-content">${c}${o}${r}${u}</div>`}createTitle(t,e){let s=t.link||"Untitled";return`<span class="minimal-task-title${e?" is-completed":""}">${s}</span>`}createMetadata(t,e,s){let i=[],a=this.renderDateBadges(t);a&&i.push(a);let n=t[this.settings.rruleField];n&&!s.includes("recurrence")&&i.push(this.renderRecurrencePill(n));let c=t[this.settings.contextsField]||[];e&&c.length>0&&!s.includes("contexts")&&i.push(this.renderContextPills(c));let o=t[this.settings.discussWithField];o&&!s.includes("person")&&i.push(this.renderDiscussWithPills(o));let r=t[this.settings.discussDuringField];r&&!s.includes("meeting")&&i.push(this.renderDiscussDuringPills(r));let u=t[this.settings.storeField];return u&&!s.includes("store")&&i.push(this.renderStorePill(u)),i.length===0?"":`<span class="minimal-task-metadata">${i.join("")}</span>`}createMainLine(t,e){return`<div class="minimal-task-main">${t}${e}</div>`}createProjectsSection(t,e){if(!this.settings.showProjects||!e)return"";let s=t[this.settings.projectField]||[];return s.length===0?"":`<div class="minimal-task-projects">${(t.projectsWithMeta||s).map(n=>this.createProjectItem(n)).join("")}</div>`}createProjectItem(t){let e="";if(t.link){let s=t;if(e=s.link,this.settings.showProjectDueDates&&s.due){let i=s.dueFormatted||s.due,a=s.overdue?" is-overdue":"";e+=` <span class="minimal-badge minimal-badge-date${a}">\u{1F4C5} ${i}</span>`}}else e=typeof t=="string"?t:String(t);return`<div class="minimal-task-project">${e}</div>`}renderStatusDot(t,e){return`<span class="task-status-dot" data-status="${t}" data-task-path="${e}" title="Status: ${t} (click to cycle)"></span>`}renderPriorityBadge(t,e){let s=this.getPriorityIcon(t);return`<span class="task-priority-badge" data-priority="${t}" data-task-path="${e}" title="Priority: ${t} (click to cycle)">${s}</span>`}renderContextPills(t){return(Array.isArray(t)?t:[t]).map(e=>`<span class="minimal-badge minimal-badge-context">@${e}</span>`).join("")}renderDiscussWithPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=this.extractDisplayName(e),i=this.extractLinkPath(e);return i?`<span class="minimal-badge minimal-badge-person"><a class="internal-link" data-href="${i}" href="${i}" target="_blank" rel="noopener">\u{1F464}${s}</a></span>`:`<span class="minimal-badge minimal-badge-person">\u{1F464}${s}</span>`}).join("")}extractDisplayName(t){if(!t)return t;let e=String(t),s=e.match(/\[\[(?:[^\]|]+\|)?([^\]]+)\]\]/);return s?s[1]:e}extractLinkPath(t){if(!t)return null;let s=String(t).match(/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/);return s?s[1]:null}stripEventPrefix(t){return t&&t.replace(/^\d{4}-\d{2}-\d{2} \d{4} /,"")}renderDiscussDuringPills(t){return(Array.isArray(t)?t:[t]).map(e=>{let s=this.extractDisplayName(e);return`<span class="minimal-badge minimal-badge-meeting">\u{1F4C5}${this.stripEventPrefix(s)}</span>`}).join("")}renderStorePill(t){return`<span class="minimal-badge minimal-badge-store">\u{1F3EA}${t}</span>`}renderRecurrencePill(t){return`<span class="minimal-badge minimal-badge-recurrence">\u{1F501} ${this.formatRRuleReadable(t)}</span>`}formatRRuleReadable(t){if(!t)return"";try{let e=this.parseRRule(t),s=e.FREQ,i=parseInt(e.INTERVAL||"1"),a=e.BYDAY,n=e.BYMONTHDAY,c=e.BYMONTH,o="";if(i===1)switch(s){case"DAILY":o="Daily";break;case"WEEKLY":o="Weekly";break;case"MONTHLY":o="Monthly";break;case"YEARLY":o="Yearly";break}else switch(s){case"DAILY":o=`Every ${i} days`;break;case"WEEKLY":o=`Every ${i} weeks`;break;case"MONTHLY":o=`Every ${i} months`;break;case"YEARLY":o=`Every ${i} years`;break}if(a){let r=a.split(",").map(u=>({SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"})[u]||u);o+=" on "+r.join(", ")}return n&&(o+=" on the "+n+this.ordinalSuffix(parseInt(n))),c&&(o+=" in "+["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(c)]),o}catch(e){return console.error("Failed to format RRULE:",e),"Recurring"}}parseRRule(t){let e={};return t.split(";").forEach(i=>{let[a,n]=i.split(":").length===2?i.split(":"):i.split("=");a&&n&&(e[a]=n)}),e}ordinalSuffix(t){let e=t%10,s=t%100;return e===1&&s!==11?"st":e===2&&s!==12?"nd":e===3&&s!==13?"rd":"th"}renderDateBadges(t){let e=[],s=t[this.settings.dueField],i=t[this.settings.scheduledField];if(i){let a=new Date(i);a.setHours(0,0,0,0);let n=this.formatDate(a);e.push(`<span class="minimal-badge minimal-badge-date">\u{1F5D3}\uFE0F ${n}</span>`)}if(s){let a=new Date(s);a.setHours(0,0,0,0);let n=new Date;n.setHours(0,0,0,0);let c=a<n,o=this.formatDate(a),r=c?"\u26A0\uFE0F":"\u{1F4C5}",u=c?" is-overdue":"";e.push(`<span class="minimal-badge minimal-badge-date${u}">${r} ${o}</span>`)}return e.join("")}formatDate(t){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}`}getPriorityIcon(t){return{today:"\u2B50",someday:"\u{1F4AD}",anytime:"\u2022"}[t]||"\u2022"}async handleClick(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),await this.cycleStatus(e);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),await this.cyclePriority(e);return}if(e.classList.contains("minimal-task-edit-icon")){t.preventDefault(),t.stopPropagation();let s=e.dataset.taskPath;s&&new O(this.app,this,s).open();return}}handleContextMenu(t){let e=t.target;if(e.classList.contains("task-status-dot")){t.preventDefault(),t.stopPropagation(),this.showStatusMenu(e,t);return}if(e.classList.contains("task-priority-badge")){t.preventDefault(),t.stopPropagation(),this.showPriorityMenu(e,t);return}}showStatusMenu(t,e){let s=t.dataset.taskPath,i=t.dataset.status;if(!s)return;let a=new d.Menu;[{value:"none",label:"\u26AA None",icon:"\u26AA"},{value:"open",label:"\u{1F535} Open",icon:"\u{1F535}"},{value:"in-progress",label:"\u{1F7E1} In Progress",icon:"\u{1F7E1}"},{value:"done",label:"\u2705 Done",icon:"\u2705"},{value:"dropped",label:"\u{1F534} Dropped",icon:"\u{1F534}"}].forEach(c=>{a.addItem(o=>{o.setTitle(c.label+(i===c.value?" \u2713":"")).onClick(async()=>{await this.setStatus(t,s,c.value)})})}),a.showAtMouseEvent(e)}showPriorityMenu(t,e){let s=t.dataset.taskPath,i=t.dataset.priority;if(!s)return;let a=new d.Menu;[{value:"anytime",label:"\u2022 Anytime",icon:"\u2022"},{value:"today",label:"\u2B50 Today",icon:"\u2B50"},{value:"someday",label:"\u{1F4AD} Someday",icon:"\u{1F4AD}"}].forEach(c=>{a.addItem(o=>{o.setTitle(c.label+(i===c.value?" \u2713":"")).onClick(async()=>{await this.setPriority(t,s,c.value)})})}),a.showAtMouseEvent(e)}async setStatus(t,e,s){try{await this.updateTaskField(e,"status",s);let i=t.closest(".minimal-task-row");i&&i.setAttribute("data-status",s),t.dataset.status=s;let a=i==null?void 0:i.querySelector(".minimal-task-title");a&&(s==="done"||s==="dropped"?a.classList.add("is-completed"):a.classList.remove("is-completed"));let n={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new d.Notice(n[s]||s)}catch(i){console.error("Error setting status:",i),new d.Notice("Error updating task status")}}async setPriority(t,e,s){try{await this.updateTaskField(e,"priority",s),t.dataset.priority=s,t.textContent=this.getPriorityIcon(s);let i={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new d.Notice(i[s]||s)}catch(i){console.error("Error setting priority:",i),new d.Notice("Error updating task priority")}}async cycleStatus(t){let e=t.dataset.taskPath,s=t.dataset.status;if(!e)return;let i=["none","open","in-progress","done","dropped"],a=i.indexOf(s||"none"),n=i[(a+1)%i.length];try{await this.updateTaskField(e,"status",n);let c=t.closest(".minimal-task-row");c&&c.setAttribute("data-status",n),t.dataset.status=n;let o=c==null?void 0:c.querySelector(".minimal-task-title");o&&(n==="done"||n==="dropped"?o.classList.add("is-completed"):o.classList.remove("is-completed"));let r={none:"\u26AA None",open:"\u{1F535} Open","in-progress":"\u{1F7E1} In Progress",done:"\u2705 Done",dropped:"\u{1F534} Dropped"};new d.Notice(r[n]||n)}catch(c){console.error("Error cycling status:",c),new d.Notice("Error updating task status")}}async cyclePriority(t){let e=t.dataset.taskPath,s=t.dataset.priority;if(!e)return;let i=["anytime","today","someday"],a=i.indexOf(s||"anytime"),n=i[(a+1)%i.length];try{await this.updateTaskField(e,"priority",n),t.dataset.priority=n,t.textContent=this.getPriorityIcon(n);let c={anytime:"\u2022 Anytime",today:"\u2B50 Today",someday:"\u{1F4AD} Someday"};new d.Notice(c[n]||n)}catch(c){console.error("Error cycling priority:",c),new d.Notice("Error updating task priority")}}async updateTaskField(t,e,s){let i=this.app.vault.getAbstractFileByPath(t);if(!i||!(i instanceof d.TFile))throw new Error(`Task file not found: ${t}`);let a=await this.app.vault.read(i),{frontmatter:n,body:c}=this.parseFrontmatter(a);n.rrule&&String(n.rrule).trim().length>0&&(e==="status"&&s==="done")&&await this.createNextRecurringInstance(n,c),n[e]=s,e==="status"&&s==="done"&&!n.completedDate&&(n.completedDate=new Date().toISOString().split("T")[0]),e==="status"&&s!=="done"&&n.completedDate&&delete n.completedDate;let u=this.rebuildContent(n,c);await this.app.vault.modify(i,u)}async createNextRecurringInstance(t,e){try{new d.Notice("\u{1F501} Creating next instance...",2e3);let s=String(t.rrule).replace(/^["']|["']$/g,""),i=new Date().toISOString().split("T")[0],a=this.calculateNextOccurrence(s,i),n=new Date,u=`gtd/actions/${`${n.toISOString().replace(/[:.]/g,"-").replace("T","-").split("-").slice(0,6).join("").replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1$2$3-$4$5$6")}.md`}`,p=n.toISOString(),m={status:"open",priority:t.priority||"anytime",dateCreated:p,dateModified:p,tags:t.tags||"[]",type:"action",title:t.title||"",contexts:t.contexts||[],area:t.area||'""',scheduled:a,rrule:`"${s}"`};t.projects&&(m.projects=t.projects),t.due&&(m.due=t.due),t.recurrence_start&&(m.recurrence_start=t.recurrence_start),t.store&&(m.store=t.store),t["discuss-with"]&&(m["discuss-with"]=t["discuss-with"]),t["discuss-during"]&&(m["discuss-during"]=t["discuss-during"]);let v=this.rebuildContent(m,e);await this.app.vault.create(u,v),new d.Notice(`\u2705 Completed! Next: ${a}`,3e3)}catch(s){console.error("Failed to create recurring task instance:",s),new d.Notice("\u26A0\uFE0F Failed to create next instance: "+s.message,5e3)}}calculateNextOccurrence(t,e){let s=this.parseRRule(t),i=new Date(e);i.setDate(i.getDate()+1);let a=s.DTSTART;if(!a)throw new Error("DTSTART is required in RRULE");let n=new Date(parseInt(a.substring(0,4)),parseInt(a.substring(4,6))-1,parseInt(a.substring(6,8))),c=s.FREQ;if(!c)throw new Error("FREQ is required in RRULE");let o=parseInt(s.INTERVAL||"1"),r;switch(c){case"DAILY":if(r=new Date(i),s.BYDAY){let f=s.BYDAY.split(",").map(this.dayCodeToNumber);for(;!f.includes(r.getDay());)r.setDate(r.getDate()+1)}else{let D=Math.floor((r.getTime()-n.getTime())/864e5)%o;D!==0&&r.setDate(r.getDate()+(o-D))}break;case"WEEKLY":r=new Date(i);let w=(s.BYDAY||["SU","MO","TU","WE","TH","FR","SA"][n.getDay()]).split(",").map(this.dayCodeToNumber),k=!1;for(let f=0;f<7&&!k;f++){if(w.includes(r.getDay())){if(o===1){k=!0;break}if(Math.floor((r.getTime()-n.getTime())/(1e3*60*60*24*7))%o===0){k=!0;break}}r.setDate(r.getDate()+1)}if(!k)for(r=new Date(i),r.setDate(r.getDate()+o*7);!w.includes(r.getDay());)r.setDate(r.getDate()+1);break;case"MONTHLY":r=new Date(i);let b=s.BYMONTHDAY?parseInt(s.BYMONTHDAY):n.getDate();if(r.setDate(b),r<=i)r.setMonth(r.getMonth()+o);else{let f=(r.getFullYear()-n.getFullYear())*12+(r.getMonth()-n.getMonth());if(f%o!==0){let D=f%o;r.setMonth(r.getMonth()+(o-D))}}for(;r.getDate()!==b;)r.setDate(0),r.setMonth(r.getMonth()+1);break;case"YEARLY":r=new Date(i);let F=s.BYMONTH?parseInt(s.BYMONTH)-1:n.getMonth(),T=s.BYMONTHDAY?parseInt(s.BYMONTHDAY):n.getDate();if(r.setMonth(F),r.setDate(T),r<=i)r.setFullYear(r.getFullYear()+o);else{let f=r.getFullYear()-n.getFullYear();if(f%o!==0){let D=f%o;r.setFullYear(r.getFullYear()+(o-D))}}break;default:throw new Error("Unsupported FREQ: "+c)}let u=r.getFullYear(),p=String(r.getMonth()+1).padStart(2,"0"),m=String(r.getDate()).padStart(2,"0");return`${u}-${p}-${m}`}dayCodeToNumber(t){return{SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[t]||0}parseFrontmatter(t){let e=/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/,s=t.match(e);if(!s)return{frontmatter:{},body:t};let i=s[1],a=s[2],n={},c=i.split(`
`),o=null,r=null;for(let u of c){if(u.trim().startsWith("- ")){r&&r.push(u.trim().substring(2));continue}let p=u.indexOf(":");if(p>0){let m=u.substring(0,p).trim(),v=u.substring(p+1).trim();o=m,v===""?(r=[],n[m]=r):(n[m]=v,r=null)}}return{frontmatter:n,body:a}}rebuildContent(t,e){let s=[];for(let[a,n]of Object.entries(t))Array.isArray(n)?n.length===0?s.push(`${a}: []`):(s.push(`${a}:`),n.forEach(c=>{s.push(`  - ${c}`)})):s.push(`${a}: ${n}`);return`---
${s.join(`
`)}
---
${e}`}refreshDataview(){setTimeout(()=>{try{this.app.commands.executeCommandById("dataview:dataview-rebuild-current-view")}catch(t){this.app.metadataCache.trigger("changed")}},100)}async convertToAction(t,e,s,i){try{let a=await this.detectNoteContext(),n=this.generateTimestamp(),o=`gtd/actions/${`${n}.md`}`,r=this.buildConvertFrontmatter(t,a),u=this.buildActionContent(r);await this.app.vault.create(o,u);let p=`- [ ] [[${n}|${t}]]`;i.dispatch({changes:{from:e,to:s,insert:p}}),new d.Notice(`Created action: ${t}`)}catch(a){console.error("Error converting task:",a),new d.Notice("Error converting task: "+a.message)}}async detectNoteContext(){let t=this.app.workspace.getActiveFile();if(!t)return{};let e=await this.app.vault.read(t),{frontmatter:s}=this.parseFrontmatter(e);return t.path.startsWith("gtd/projects/")&&!t.path.includes("archive")?{projects:[`[[${t.basename}]]`]}:s.type==="event"&&s.project?{projects:[s.project]}:s.area?{area:s.area}:{}}generateTimestamp(){let t=new Date,e=s=>s.toString().padStart(2,"0");return`${t.getFullYear()}${e(t.getMonth()+1)}${e(t.getDate())}-${e(t.getHours())}${e(t.getMinutes())}${e(t.getSeconds())}`}buildConvertFrontmatter(t,e){let s=new Date().toISOString(),i={type:"action",title:t,status:"open",priority:"anytime",dateCreated:s,dateModified:s,tags:[],contexts:[]},a=(e.projects||[]).filter(n=>n?(typeof n=="string"?n:String(n)).trim().length>0:!1);return a.length>0?(i.projects=a,i.area='""'):e.area&&e.area.trim()&&e.area!=='""'?(i.projects=[],i.area=e.area):(i.projects=[],i.area='""'),i}buildActionContent(t){let e='```dataviewjs\nawait dv.view("apps/dataview/unified-ribbon");\n```\n';return this.rebuildContent(t,e)}onunload(){console.log("Unloading Minimal Tasks plugin"),delete window.MinimalTasks}},Y=class extends d.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Minimal Tasks Settings"}),t.createEl("h3",{text:"Frontmatter Field Names"}),t.createEl("p",{text:"Customize which frontmatter fields are used for task metadata.",cls:"setting-item-description"}),new d.Setting(t).setName("Status field").setDesc("Frontmatter field for task status").addText(e=>e.setPlaceholder("status").setValue(this.plugin.settings.statusField).onChange(async s=>{this.plugin.settings.statusField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Priority field").setDesc("Frontmatter field for task priority").addText(e=>e.setPlaceholder("priority").setValue(this.plugin.settings.priorityField).onChange(async s=>{this.plugin.settings.priorityField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Projects field").setDesc("Frontmatter field for project links (array)").addText(e=>e.setPlaceholder("projects").setValue(this.plugin.settings.projectField).onChange(async s=>{this.plugin.settings.projectField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Contexts field").setDesc("Frontmatter field for contexts (array)").addText(e=>e.setPlaceholder("contexts").setValue(this.plugin.settings.contextsField).onChange(async s=>{this.plugin.settings.contextsField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Due date field").setDesc("Frontmatter field for due date").addText(e=>e.setPlaceholder("due").setValue(this.plugin.settings.dueField).onChange(async s=>{this.plugin.settings.dueField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Scheduled field").setDesc("Frontmatter field for scheduled date").addText(e=>e.setPlaceholder("scheduled").setValue(this.plugin.settings.scheduledField).onChange(async s=>{this.plugin.settings.scheduledField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Discuss-with field").setDesc("Frontmatter field for people to discuss with (array)").addText(e=>e.setPlaceholder("discuss-with").setValue(this.plugin.settings.discussWithField).onChange(async s=>{this.plugin.settings.discussWithField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Discuss-during field").setDesc("Frontmatter field for meetings to discuss during (array)").addText(e=>e.setPlaceholder("discuss-during").setValue(this.plugin.settings.discussDuringField).onChange(async s=>{this.plugin.settings.discussDuringField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Store field").setDesc("Frontmatter field for store/location (errands)").addText(e=>e.setPlaceholder("store").setValue(this.plugin.settings.storeField).onChange(async s=>{this.plugin.settings.storeField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Area field").setDesc("Frontmatter field for area/category").addText(e=>e.setPlaceholder("area").setValue(this.plugin.settings.areaField).onChange(async s=>{this.plugin.settings.areaField=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Title field").setDesc("Frontmatter field for task title").addText(e=>e.setPlaceholder("title").setValue(this.plugin.settings.titleField).onChange(async s=>{this.plugin.settings.titleField=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Display Options"}),new d.Setting(t).setName("Show projects").setDesc("Display project links below tasks").addToggle(e=>e.setValue(this.plugin.settings.showProjects).onChange(async s=>{this.plugin.settings.showProjects=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Show project due dates").setDesc("Show due date warnings for projects").addToggle(e=>e.setValue(this.plugin.settings.showProjectDueDates).onChange(async s=>{this.plugin.settings.showProjectDueDates=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Show note icon").setDesc("Show \u2630 icon for tasks with content").addToggle(e=>e.setValue(this.plugin.settings.showNoteIcon).onChange(async s=>{this.plugin.settings.showNoteIcon=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Enable convert icon").setDesc("Show a convert icon at the end of markdown task lines in edit mode. Click to convert to an action file. Requires restart to take effect.").addToggle(e=>e.setValue(this.plugin.settings.enableConvertIcon).onChange(async s=>{this.plugin.settings.enableConvertIcon=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Note content ignore pattern").setDesc("Regex pattern to ignore when detecting note content. Useful for stripping boilerplate code blocks like ribbons. Leave empty to disable.").addTextArea(e=>e.setPlaceholder('^\\s*```dataviewjs\\s*\\n\\s*await dv\\.view\\("(?:apps\\/dataview\\/)?unified-ribbon"\\);?\\s*\\n\\s*```\\s*').setValue(this.plugin.settings.noteContentIgnorePattern).onChange(async s=>{this.plugin.settings.noteContentIgnorePattern=s,await this.plugin.saveSettings()}))}};
